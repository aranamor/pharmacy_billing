<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmacy Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .shop-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .logo-container {
            width: 150px;
            height: 150px;
            background: white;
            border-radius: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            color: #667eea;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #dee2e6;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
            margin-bottom: -3px;
        }

        .content {
            padding: 30px;
            min-height: 500px;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f93b1d 0%, #ea5455 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(249, 59, 29, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }

        .btn-info {
            background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);
            color: white;
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 210, 255, 0.4);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .inventory-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .bill-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .bill-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #dee2e6;
        }

        .bill-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .total-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 2px solid #667eea;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .total-row:last-child {
            border-bottom: none;
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
        }

        .invoice-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .stat-card h3 {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #495057;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            animation: slideIn 0.3s;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .search-box {
            position: relative;
            max-width: 400px;
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 40px 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 25px;
            font-size: 14px;
        }

        .search-box::after {
            content: "üîç";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
        }

        @media print {
            body { background: white; }
            .no-print { display: none !important; }
            .invoice-container { box-shadow: none; }
        }

        .expired-item {
            background: #ffebee !important;
        }

        .low-stock {
            background: #fff3e0 !important;
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 1.5em; }
            .tabs { overflow-x: scroll; }
            .form-grid { grid-template-columns: 1fr; }
        }

        /* Styles for the searchable select dropdown */
        .select-wrapper {
            position: relative;
        }
        .select-wrapper input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .select-wrapper .dropdown-list {
            display: none;
            position: absolute;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            background-color: white;
            z-index: 100;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .select-wrapper .dropdown-list div {
            padding: 10px 15px;
            cursor: pointer;
        }
        .select-wrapper .dropdown-list div:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container"><img src="hologram.png" width="100" height="100"><br></div>
            <div class="shop-info">
                <div>
                    <h1 id="shopName">MediCare Pharmacy</h1>
                    <p>Wahi Kaam Sahi Daam | GST: 16GLDPD3626M1Z0</p>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="switchTab('billing')">üí∞ Billing</button>
            <button class="tab" onclick="switchTab('inventory')">üì¶ Inventory</button>
            <button class="tab" onclick="switchTab('customers')">üë• Customers</button>
            <button class="tab" onclick="switchTab('reports')">üìà Reports</button>
            <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
            <button class="tab" onclick="switchTab('oldBills')">üìú Bills</button>

        </div>

        <div class="content">
            <div id="dashboard" class="tab-content active">
                <h2>Dashboard Overview</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Today's Sales</h3>
                        <div class="value" id="todaySales">‚Çπ0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Inventory Items</h3>
                        <div class="value" id="totalItems">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Low Stock Alerts</h3>
                        <div class="value" id="lowStockCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Expiring Soon</h3>
                        <div class="value" id="expiringCount">0</div>
                    </div>
                </div>

                <h3 style="margin-top: 30px;">Recent Transactions</h3>
                <table id="recentTransactions">
                    <thead>
                        <tr>
                            <th>Bill No</th>
                            <th>Date</th>
                            <th>Patient</th>
                            <th>Amount</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="recentTransactionsBody">
                        <tr><td colspan="5" style="text-align: center;">No recent transactions</td></tr>
                    </tbody>
                </table>
            </div>

            <div id="billing" class="tab-content">
                <h2>New Bill</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Patient Name *</label>
                        <input type="text" id="patientName" placeholder="Enter patient name" oninput="searchCustomer()">
                        <div class="dropdown-list" id="patientNameDropdown"></div>
                    </div>
                    <div class="form-group">
                        <label>Patient Mobile *</label>
                        <input type="tel" id="patientMobile" placeholder="10-digit mobile number" maxlength="10" oninput="searchCustomer()">
                    </div>
                    <div class="form-group">
                        <label>Doctor Name</label>
                        <input type="text" id="doctorName" placeholder="Prescribing doctor (optional)">
                    </div>
                </div>

                <h3>Add Products</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Select Product *</label>
                        <div class="select-wrapper">
                            <input type="text" id="billProductSearch" placeholder="Search product..." autocomplete="off" oninput="searchProducts()" onfocus="showProductDropdown()">
                            <div class="dropdown-list" id="billProductDropdown"></div>
                            <input type="hidden" id="billProductId">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Batch</label>
                        <input type="text" id="billBatch" readonly>
                    </div>
                    <div class="form-group">
                        <label>Expiry</label>
                        <input type="month" id="billExpiry" readonly>
                    </div>
                    <div class="form-group">
                        <label>Available Qty</label>
                        <input type="number" id="availableQty" readonly>
                    </div>
                    <div class="form-group">
                        <label>MRP</label>
                        <input type="number" id="billMRP" readonly>
                    </div>
                    <div class="form-group">
                        <label>Sale Rate</label>
                        <input type="number" id="billRate" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Quantity *</label>
                        <input type="number" id="billQty" min="1" placeholder="Enter quantity">
                    </div>
                    <div class="form-group">
                        <label>Discount (%)</label>
                        <input type="number" id="billDiscount" min="0" max="100" value="0">
                    </div>
                </div>

                <button class="btn btn-primary" onclick="addToBill()">‚ûï Add to Bill</button>

                <div class="bill-section">
                    <h3>Current Bill Items</h3>
                    <table id="billItemsTable">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Batch</th>
                                <th>Exp</th>
                                <th>MRP</th>
                                <th>Rate</th>
                                <th>Qty</th>
                                <th>Disc %</th>
                                <th>GST</th>
                                <th>Amount</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="billItemsBody">
                            <tr><td colspan="10" style="text-align: center;">No items added</td></tr>
                        </tbody>
                    </table>

                    <div class="total-section">
                        <div class="total-row">
                            <span>Subtotal:</span>
                            <span id="subtotal">‚Çπ0.00</span>
                        </div>
                        <div class="total-row">
                            <span>Total Discount:</span>
                            <span id="totalDiscount">‚Çπ0.00</span>
                        </div>
                        <div class="total-row">
                            <span>CGST:</span>
                            <span id="totalCGST">‚Çπ0.00</span>
                        </div>
                        <div class="total-row">
                            <span>SGST:</span>
                            <span id="totalSGST">‚Çπ0.00</span>
                        </div>
                        <div class="total-row">
                            <span>Grand Total:</span>
                            <span id="grandTotal">‚Çπ0.00</span>
                        </div>
                    </div>

                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="generateBill()">üñ®Ô∏è Generate Bill</button>
                        <button class="btn btn-danger" onclick="clearBill()">üóëÔ∏è Clear Bill</button>
                    </div>
                </div>
            </div>

            <div id="inventory" class="tab-content">
                <h2>Inventory Management</h2>
                
                <div class="inventory-actions">
                    <button class="btn btn-primary" onclick="showAddProductModal()">‚ûï Add New Product</button>
                    <div class="form-group">
                        <label for="expiry-filter">Filter Expiring</label>
                        <select id="expiry-filter" class="form-control">
                            <option value="none">Show All</option>
                            <option value="expired">Expired</option>
                            <option value="thisMonth">Expiring this month</option>
                            <option value="next2months">Expiring in next 2 months</option>
                            <option value="next3months">Expiring in next 3 months</option>
                        </select>
                    </div>
                    <button class="btn btn-info" onclick="filterExpiring()">‚ö†Ô∏è Check Expiring</button>
                    <button class="btn btn-warning" onclick="checkLowStock()">üìâ Low Stock Alert</button>
                </div>

                <div class="search-box">
                    <input type="text" id="inventorySearch" placeholder="Search products..." onkeyup="searchInventory()">
                </div>

                <table id="inventoryTable">
                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>HSN</th>
                            <th>Batch</th>
                            <th>Quantity</th>
                            <th>MRP</th>
                            <th>Sale Rate</th>
                            <th>Expiry</th>
                            <th>CGST %</th>
                            <th>SGST %</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryBody">
                        <tr><td colspan="10" style="text-align: center;">No products in inventory</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- New Customers Tab -->
            <div id="customers" class="tab-content">
                <h2>Customer Management</h2>
                <div class="inventory-actions">
                    <div class="search-box">
                        <input type="text" id="customerSearch" placeholder="Search customers..." onkeyup="searchCustomers()">
                    </div>
                </div>
                <table id="customersTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Mobile</th>
                            <th>Doctor Name</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customersBody">
                        <tr><td colspan="5" style="text-align: center;">No customers found</td></tr>
                    </tbody>
                </table>
            </div>


            <div id="reports" class="tab-content">
                <h2>Reports & Analytics</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>From Date</label>
                        <input type="date" id="reportFromDate">
                    </div>
                    <div class="form-group">
                        <label>To Date</label>
                        <input type="date" id="reportToDate">
                    </div>
                    <div class="form-group">
                        <label>Report Type</label>
                        <select id="reportType">
                            <option value="sales">Sales Report</option>
                            <option value="gst">GST Report</option>
                            <option value="inventory">Inventory Report</option>
                            <option value="expiry">Expiry Report</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="generateReport()">üìä Generate Report</button>

                <div id="reportContent" style="margin-top: 30px;">
                    </div>
            </div>

            <div id="settings" class="tab-content">
                <h2>Settings</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Shop Name</label>
                        <input type="text" id="settingsShopName" value="MediCare Pharmacy">
                    </div>
                    <div class="form-group">
                        <label>GST Number</label>
                        <input type="text" id="settingsGST" value="27XXXXX1234X0Z5">
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="settingsPhone" value="9876543210">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="settingsEmail" value="info@medicare.com">
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" id="settingsAddress" value="123, Main Street, City">
                    </div>
                    <div class="form-group">
                        <label>Low Stock Alert (Qty)</label>
                        <input type="number" id="lowStockThreshold" value="10">
                    </div>
                </div>

                <button class="btn btn-success" onclick="saveSettings()">üíæ Save Settings</button>
            </div>
            <!-- All Bills Tab -->
            <div id="oldBills" class="tab-content">
                <h2>All Bills</h2>
                <table id="billsTable">
                    <thead>
                        <tr>
                            <th>Bill No</th>
                            <th>Date</th>
                            <th>Patient</th>
                            <th>Total</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="billsBody">
                        <tr><td colspan="5" style="text-align:center;">Loading bills...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Edit Bill Modal -->
            <div id="editBillModal" class="modal">
                <div class="modal-content" style="min-width: 800px;">
                    <h2>Edit Bill</h2>
                    <div id="editBillContent"></div>
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="saveEditedBill()">üíæ Save Changes</button>
                        <button class="btn btn-danger" onclick="closeModal('editBillModal')">Cancel</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <h2>Add New Product</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>Product Name *</label>
                    <input type="text" id="newProductName" placeholder="Enter product name">
                </div>
                <div class="form-group">
                    <label>HSN Code *</label>
                    <input type="text" id="newHSN" placeholder="HSN Code">
                </div>
                <div class="form-group">
                    <label>Batch Number *</label>
                    <input type="text" id="newBatch" placeholder="Batch number">
                </div>
                <div class="form-group">
                    <label>Quantity *</label>
                    <input type="number" id="newQuantity" min="0" placeholder="Initial quantity">
                </div>
                <div class="form-group">
                    <label>MRP *</label>
                    <input type="number" id="newMRP" step="0.01" placeholder="Maximum retail price">
                </div>
                <div class="form-group">
                    <label>Rate (Inclusive of Tax)</label>
                    <input type="number" id="newSaleRateInclusive" step="0.01" placeholder="Price with GST" oninput="calculateExclusiveRate()">
                </div>
                <div class="form-group">
                    <label>Rate (Exclusive of Tax) *</label>
                    <input type="number" id="newSaleRate" step="0.01" placeholder="Selling price without GST">
                </div>
                <div class="form-group">
                    <label>Expiry Date *</label>
                    <input type="month" id="newExpiry">
                </div>
                <div class="form-group">
                    <label>CGST % *</label>
                    <input type="number" id="newCGST" min="0" max="100" step="0.5" value="6" oninput="calculateExclusiveRate()">
                </div>
                <div class="form-group">
                    <label>SGST % *</label>
                    <input type="number" id="newSGST" min="0" max="100" step="0.5" value="6" oninput="calculateExclusiveRate()">
                </div>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="addProduct()">Add Product</button>
                <button class="btn btn-danger" onclick="closeModal('addProductModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="invoiceModal" class="modal">
        <div class="modal-content" style="min-width: 800px;">
            <div class="invoice-container" id="invoiceContent">
                </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;" class="no-print">
                <button class="btn btn-primary" onclick="printInvoice()">üñ®Ô∏è Print Invoice</button>
                <button class="btn btn-danger" onclick="closeModal('invoiceModal')">Close</button>
            </div>
        </div>
    </div>

    <div id="editCustomerModal" class="modal">
        <div class="modal-content">
            <h2>Edit Customer</h2>
            <input type="hidden" id="editCustomerId">
            <div class="form-grid">
                <div class="form-group">
                    <label>Customer Name *</label>
                    <input type="text" id="editCustomerName" placeholder="Enter customer name">
                </div>
                <div class="form-group">
                    <label>Mobile Number *</label>
                    <input type="tel" id="editCustomerMobile" placeholder="10-digit mobile number" maxlength="10">
                </div>
                <div class="form-group">
                    <label>Doctor Name</label>
                    <input type="text" id="editCustomerDoctorName" placeholder="Prescribing doctor (optional)">
                </div>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="updateCustomer()">Update Customer</button>
                <button class="btn btn-danger" onclick="closeModal('editCustomerModal')">Cancel</button>
            </div>
        </div>
    </div>


    <script>
        // Data Storage
        let inventory = [];
        let billItems = [];
        let transactions = [];
        let settings = {};

        // Base URL for the API
        const API_BASE_URL = 'http://localhost:3000/api';

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            await fetchSettings();
            await fetchInventory();
            await fetchDashboardData();
            setTodayDate();
        });

        // Tab Switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'dashboard') {
                fetchDashboardData();
            } else if (tabName === 'inventory') {
                fetchInventory();
            } else if (tabName === 'customers') {
                fetchCustomers();
            } else if (tabName === 'reports') {
                setTodayDate();
                document.getElementById('reportContent').innerHTML = ''; // Clear previous report
            } else if (tabName === 'oldBills') {
                fetchBills();
            }
        }


        // Settings Management
        async function fetchSettings() {
            try {
                const response = await fetch(`${API_BASE_URL}/settings`);
                settings = await response.json();
                loadSettings();
            } catch (error) {
                showAlert('Failed to load settings.', 'danger');
                console.error('Error fetching settings:', error);
            }
        }

        function loadSettings() {
            if (!settings) return;
            
            const shopNameEl = document.getElementById('shopName');
            if (shopNameEl && settings.shopName) {
                shopNameEl.textContent = settings.shopName;
            }
            
            const settingsInputs = [
                'settingsShopName', 'settingsGST', 'settingsPhone', 
                'settingsEmail', 'settingsAddress', 'lowStockThreshold'
            ];
            
            settingsInputs.forEach(inputId => {
                const element = document.getElementById(inputId);
                const settingKey = inputId.replace('settings', '').toLowerCase();
                const key = settingKey === 'gst' ? 'gst' : settingKey === 'lowstockthreshold' ? 'lowStockThreshold' : settingKey;
                
                if (element && settings[key]) {
                    element.value = settings[key];
                }
            });
        }

        async function saveSettings() {
            const updatedSettings = {
                shopName: document.getElementById('settingsShopName').value,
                gst: document.getElementById('settingsGST').value,
                phone: document.getElementById('settingsPhone').value,
                email: document.getElementById('settingsEmail').value,
                address: document.getElementById('settingsAddress').value,
                lowStockThreshold: parseInt(document.getElementById('lowStockThreshold').value)
            };
            try {
                const response = await fetch(`${API_BASE_URL}/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ settings: updatedSettings })
                });
                const result = await response.json();
                if (response.ok) {
                    settings = updatedSettings;
                    loadSettings();
                    showAlert(result.message, 'success');
                } else {
                    showAlert(result.error, 'danger');
                }
            } catch (error) {
                showAlert('Failed to save settings.', 'danger');
                console.error('Error saving settings:', error);
            }
        }

        // Inventory Management
        async function fetchInventory() {
            try {
                console.log('Fetching inventory...');
                const response = await fetch(`${API_BASE_URL}/products`);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to fetch inventory');
                }
                
                inventory = await response.json();
                console.log('Inventory loaded:', inventory);
                updateInventoryTable(inventory);
                
                // Update dashboard counts if on dashboard
                if (document.getElementById('dashboard').classList.contains('active')) {
                    await fetchDashboardData();
                }
            } catch (error) {
                console.error('Error fetching inventory:', error);
                // Still try to update the table even if empty
                inventory = [];
                updateInventoryTable(inventory);
                showAlert('Failed to load inventory: ' + error.message, 'danger');
            }
        }
        async function showAddProductModal() {
            closeModal('invoiceModal'); // Close any open modals
            document.getElementById('addProductModal').classList.add('active');
            clearProductForm();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function calculateExclusiveRate() {
            const inclusiveRateEl = document.getElementById('newSaleRateInclusive');
            const exclusiveRateEl = document.getElementById('newSaleRate');
            const cgstEl = document.getElementById('newCGST');
            const sgstEl = document.getElementById('newSGST');

            const inclusiveRate = parseFloat(inclusiveRateEl.value);
            const cgst = parseFloat(cgstEl.value) || 0;
            const sgst = parseFloat(sgstEl.value) || 0;

            if (!isNaN(inclusiveRate) && inclusiveRate > 0) {
                const totalGstPercent = cgst + sgst;
                const exclusiveRate = inclusiveRate / (1 + (totalGstPercent / 100));
                exclusiveRateEl.value = exclusiveRate.toFixed(2);
            } else if (inclusiveRateEl.value.trim() === '') {
                 exclusiveRateEl.value = '';
            }
        }

        async function addProduct() {
            const product = {
                name: document.getElementById('newProductName').value,
                hsn: document.getElementById('newHSN').value,
                batch: document.getElementById('newBatch').value,
                quantity: parseInt(document.getElementById('newQuantity').value),
                mrp: parseFloat(document.getElementById('newMRP').value),
                saleRate: parseFloat(document.getElementById('newSaleRate').value),
                expiry: document.getElementById('newExpiry').value,
                cgst: parseFloat(document.getElementById('newCGST').value),
                sgst: parseFloat(document.getElementById('newSGST').value)
            };

            if (!product.name || !product.hsn || !product.batch || isNaN(product.quantity) || 
                isNaN(product.mrp) || isNaN(product.saleRate) || !product.expiry) {
                showAlert('Please fill all required fields!', 'danger');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/products`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(product)
                });
                const result = await response.json();
                if (response.ok) {
                    showAlert(result.message, 'success');
                    await fetchInventory(); // Refresh inventory after adding a product
                    await fetchDashboardData(); // Refresh dashboard data
                    closeModal('addProductModal');
                } else {
                    showAlert(result.error, 'danger');
                }
            } catch (error) {
                showAlert('Failed to add product.', 'danger');
                console.error('Error adding product:', error);
            }
        }

        function clearProductForm() {
            document.getElementById('newProductName').value = '';
            document.getElementById('newHSN').value = '';
            document.getElementById('newBatch').value = '';
            document.getElementById('newQuantity').value = '';
            document.getElementById('newMRP').value = '';
            document.getElementById('newSaleRateInclusive').value = '';
            document.getElementById('newSaleRate').value = '';
            document.getElementById('newExpiry').value = '';
            document.getElementById('newCGST').value = '6';
            document.getElementById('newSGST').value = '6';
        }

        function updateInventoryTable(data) {
            const tableBody = document.getElementById('inventoryBody');
            
            if (!tableBody) {
                console.error('Inventory table body not found');
                return;
            }
            
            tableBody.innerHTML = '';
            
            if (!data || data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center;">No products in inventory</td></tr>';
                return;
            }

            const today = new Date();
            const oneMonth = 30 * 24 * 60 * 60 * 1000;

            data.forEach(product => {
                const row = document.createElement('tr');
                let rowClass = '';
                
                // Check expiry date
                // Append -01 to compare as a date
                const expiryDate = new Date(`${product.expiry}-01`);
                if (expiryDate < today) {
                    rowClass = 'expired-item';
                } else if ((expiryDate - today) < oneMonth) {
                    rowClass = 'low-stock';
                }
                
                // Check low stock
                const lowStockThreshold = parseInt(settings.lowStockThreshold) || 10;
                if (product.quantity <= lowStockThreshold) {
                    rowClass = 'low-stock';
                }

                row.className = rowClass;
                row.innerHTML = `
                    <td>${product.name || 'N/A'}</td>
                    <td>${product.hsn || 'N/A'}</td>
                    <td>${product.batch || 'N/A'}</td>
                    <td>${product.quantity || 0}</td>
                    <td>‚Çπ${parseFloat(product.mrp || 0).toFixed(2)}</td>
                    <td>‚Çπ${parseFloat(product.sale_rate || 0).toFixed(2)}</td>
                    <td>${product.expiry || 'N/A'}</td>
                    <td>${product.cgst || 0}%</td>
                    <td>${product.sgst || 0}%</td>
                    <td>
                        <button class="btn btn-warning" style="padding: 5px 10px; margin-right: 5px;" onclick="editProduct(${product.id})">‚úèÔ∏è</button>
                        <button class="btn btn-danger" style="padding: 5px 10px;" onclick="deleteProduct(${product.id})">‚ùå</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }


        async function searchInventory() {
            const query = document.getElementById('inventorySearch').value.toLowerCase();
            try {
                const response = await fetch(`${API_BASE_URL}/products/search?query=${query}`);
                const filtered = await response.json();
                updateInventoryTable(filtered);
            } catch (error) {
                showAlert('Failed to search inventory.', 'danger');
                console.error('Error searching inventory:', error);
            }
        }
        
        // New function to handle filtering by expiry
        async function filterExpiring() {
            const filterType = document.getElementById('expiry-filter').value;
            if (filterType === 'none') {
                fetchInventory(); // Show all products
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/products`);
                const allProducts = await response.json();
                const today = new Date();
                const todayStr = today.toISOString().substring(0, 7);

                let filteredProducts = [];
                let message = '';

                if (filterType === 'expired') {
                    filteredProducts = allProducts.filter(p => p.expiry && new Date(`${p.expiry}-01`) < today);
                    message = filteredProducts.length > 0 ? 'The following products have expired.' : 'No products have expired.';
                } else if (filterType === 'thisMonth') {
                    filteredProducts = allProducts.filter(p => p.expiry && p.expiry === todayStr);
                    message = filteredProducts.length > 0 ? 'The following products are expiring this month.' : 'No products are expiring this month.';
                } else if (filterType === 'next2months') {
                    const twoMonthsFromNow = new Date();
                    twoMonthsFromNow.setMonth(twoMonthsFromNow.getMonth() + 2);
                    filteredProducts = allProducts.filter(p => {
                        if (!p.expiry) return false;
                        const expiryDate = new Date(`${p.expiry}-01`);
                        return expiryDate >= today && expiryDate <= twoMonthsFromNow;
                    });
                    message = filteredProducts.length > 0 ? 'The following products are expiring in the next 2 months.' : 'No products are expiring in the next 2 months.';
                } else if (filterType === 'next3months') {
                    const threeMonthsFromNow = new Date();
                    threeMonthsFromNow.setMonth(threeMonthsFromNow.getMonth() + 3);
                    filteredProducts = allProducts.filter(p => {
                        if (!p.expiry) return false;
                        const expiryDate = new Date(`${p.expiry}-01`);
                        return expiryDate >= today && expiryDate <= threeMonthsFromNow;
                    });
                    message = filteredProducts.length > 0 ? 'The following products are expiring in the next 3 months.' : 'No products are expiring in the next 3 months.';
                }
                
                updateInventoryTable(filteredProducts);
                showAlert(message, filteredProducts.length > 0 ? 'warning' : 'success');

            } catch (error) {
                showAlert('Failed to filter products.', 'danger');
                console.error('Error filtering products:', error);
            }
        }


        async function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                try {
                    const response = await fetch(`${API_BASE_URL}/products/${id}`, { method: 'DELETE' });
                    const result = await response.json();
                    if (response.ok) {
                        showAlert(result.message, 'success');
                        await fetchInventory();
                        await fetchDashboardData();
                    } else {
                        showAlert(result.error, 'danger');
                    }
                } catch (error) {
                    showAlert('Failed to delete product.', 'danger');
                    console.error('Error deleting product:', error);
                }
            }
        }

        async function editProduct(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/products/${id}`);
                const product = await response.json();
                if (!response.ok) {
                    showAlert('Product not found.', 'danger');
                    return;
                }

                const newQuantity = prompt(`Enter new quantity for ${product.name} (Current: ${product.quantity}):`);
                if (newQuantity !== null && !isNaN(newQuantity) && parseInt(newQuantity) >= 0) {
                    const updateResponse = await fetch(`${API_BASE_URL}/products/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ quantity: parseInt(newQuantity) })
                    });
                    const updateResult = await updateResponse.json();
                    if (updateResponse.ok) {
                        showAlert(updateResult.message, 'success');
                        await fetchInventory();
                        await fetchDashboardData();
                    } else {
                        showAlert(updateResult.error, 'danger');
                    }
                } else if (newQuantity !== null) {
                    showAlert('Invalid quantity entered!', 'danger');
                }
            } catch (error) {
                showAlert('Failed to edit product.', 'danger');
                console.error('Error editing product:', error);
            }
        }
        
        // Original check expiring logic is now a function of filterExpiring
        function checkExpiring() {
            filterExpiring();
        }

        async function checkLowStock() {
            try {
                const response = await fetch(`${API_BASE_URL}/products`);
                const allProducts = await response.json();
                const lowStock = allProducts.filter(p => p.quantity <= settings.lowStockThreshold);
                
                const message = lowStock.length > 0
                    ? `The following products are low in stock (below ${settings.lowStockThreshold}): \n\n${lowStock.map(p => `${p.name} (Batch: ${p.batch}, Qty: ${p.quantity})`).join('\n')}`
                    : 'All products are well stocked.';
                    
                showAlert(message, lowStock.length > 0 ? 'warning' : 'success');
            } catch (error) {
                showAlert('Failed to check low stock.', 'danger');
                console.error('Error checking low stock:', error);
            }
        }

        // Billing Logic
        async function searchProducts() {
            const query = document.getElementById('billProductSearch').value.toLowerCase().trim();
            const dropdown = document.getElementById('billProductDropdown');
            
            if (!dropdown) {
                console.error('Product dropdown not found');
                return;
            }
            
            dropdown.innerHTML = '';

            if (query.length < 1) {
                dropdown.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/products/search?query=${encodeURIComponent(query)}`);
                
                if (!response.ok) {
                    throw new Error('Failed to search products');
                }
                
                const filteredProducts = await response.json();
                console.log('Search results:', filteredProducts);

                if (filteredProducts.length > 0) {
                    filteredProducts.forEach(product => {
                        const item = document.createElement('div');
                        item.textContent = `${product.name} - Batch: ${product.batch} (Qty: ${product.quantity})`;
                        item.style.cursor = 'pointer';
                        item.onclick = () => selectProduct(product);
                        dropdown.appendChild(item);
                    });
                    dropdown.style.display = 'block';
                } else {
                    const noResult = document.createElement('div');
                    noResult.textContent = 'No products found';
                    noResult.style.padding = '10px';
                    noResult.style.color = '#666';
                    dropdown.appendChild(noResult);
                    dropdown.style.display = 'block';
                }
            } catch (error) {
                console.error('Error searching products:', error);
                const errorDiv = document.createElement('div');
                errorDiv.textContent = 'Error searching products';
                errorDiv.style.padding = '10px';
                errorDiv.style.color = '#dc3545';
                dropdown.appendChild(errorDiv);
                dropdown.style.display = 'block';
            }
        }

        function showProductDropdown() {
            const dropdown = document.getElementById('billProductDropdown');
            searchProducts();
            dropdown.style.display = 'block';
        }

        document.addEventListener('click', function(event) {
            const selectWrapper = document.querySelector('.select-wrapper');
            const dropdown = document.getElementById('billProductDropdown');
            if (!selectWrapper.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });

        function selectProduct(product) {
            console.log('Selected product:', product);

            // Update form fields
            document.getElementById('billProductSearch').value = `${product.name} - ${product.batch}`;
            document.getElementById('billProductId').value = product.id;
            document.getElementById('billProductDropdown').style.display = 'none';

            // Update product details
            document.getElementById('billBatch').value = product.batch || '';
            document.getElementById('billExpiry').value = product.expiry || '';
            document.getElementById('availableQty').value = product.quantity || 0;
            document.getElementById('billMRP').value = parseFloat(product.mrp || 0).toFixed(2);
            document.getElementById('billRate').value = parseFloat(product.sale_rate || 0).toFixed(2);

            // Set max quantity and clear current quantity
            const qtyInput = document.getElementById('billQty');
            qtyInput.max = product.quantity || 0;
            qtyInput.value = '';
            qtyInput.focus();
        }

        function addToBill() {
            console.log('addToBill clicked');
            
            if (!inventory || inventory.length === 0) {
                showAlert('Inventory not loaded yet. Please wait a moment and try again.', 'danger');
                return;
            }

            const productIdStr = document.getElementById('billProductId').value;
            const quantityStr = document.getElementById('billQty').value;
            const rateStr = document.getElementById('billRate').value;
            const discountStr = document.getElementById('billDiscount').value || '0';

            if (!productIdStr) {
                showAlert('Please select a product first.', 'danger');
                return;
            }

            const productId = Number(productIdStr);
            const quantity = Number(quantityStr);
            const rate = Number(rateStr);
            const discount = Number(discountStr);

            if (isNaN(productId) || isNaN(quantity) || quantity <= 0 || isNaN(rate) || rate <= 0) {
                showAlert('Please enter valid quantity and rate.', 'danger');
                return;
            }

            if (isNaN(discount) || discount < 0 || discount > 100) {
                showAlert('Please enter a valid discount (0-100%).', 'danger');
                return;
            }

            // Find product with proper type coercion
            const product = inventory.find(p => Number(p.id) === productId);
            if (!product) {
                showAlert('Product not found in inventory.', 'danger');
                console.error('Looking for ID:', productId, 'in inventory:', inventory);
                return;
            }

            if (quantity > Number(product.quantity)) {
                showAlert(`Not enough stock. Only ${product.quantity} available.`, 'danger');
                return;
            }

            const existingBillItemIndex = billItems.findIndex(item => Number(item.id) === productId);
            if (existingBillItemIndex !== -1) {
                const existingItem = billItems[existingBillItemIndex];
                const totalQuantityNeeded = existingItem.quantity + quantity;

                if (totalQuantityNeeded > Number(product.quantity)) {
                    showAlert(`Total quantity (${totalQuantityNeeded}) exceeds available stock (${product.quantity}).`, 'danger');
                    return;
                }

                existingItem.quantity = totalQuantityNeeded;
                existingItem.discount = discount;
                existingItem.rate = rate;
            } else {
                // Make sure to include product_id for backend processing
                billItems.push({
                    id: Number(product.id),
                    product_id: Number(product.id), // Add this explicitly
                    name: product.name,
                    hsn: product.hsn,
                    batch: product.batch,
                    expiry: product.expiry,
                    mrp: Number(product.mrp) || 0,
                    rate: rate,
                    quantity: quantity,
                    discount: discount,
                    cgst: Number(product.cgst) || 0,
                    sgst: Number(product.sgst) || 0
                });
            }   

            try {
                updateBillTable();
                calculateTotals();
                clearProductInputs();
                showAlert('Product added to bill successfully!', 'success');
            } catch (err) {
                console.error('Error after adding to bill:', err);
                showAlert('Unexpected error while adding to bill. Check console for details.', 'danger');
            }
        }

        function updateBillTable() {
            const tableBody = document.getElementById('billItemsBody');
            tableBody.innerHTML = '';
            if (billItems.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center;">No items added</td></tr>';
                return;
            }

            billItems.forEach((item, index) => {
                // ensure numeric coercion before formatting
                const mrpNum = Number(item.mrp) || 0;
                const rateNum = Number(item.rate) || 0;
                const qtyNum = Number(item.quantity) || 0;
                const discountNum = Number(item.discount) || 0;
                const cgstNum = Number(item.cgst) || 0;
                const sgstNum = Number(item.sgst) || 0;

                const amount = (rateNum * qtyNum) - ((rateNum * qtyNum) * (discountNum / 100));
                const totalGST = amount * ((cgstNum + sgstNum) / 100);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.batch}</td>
                    <td>${item.expiry}</td>
                    <td>‚Çπ${mrpNum.toFixed(2)}</td>
                    <td>‚Çπ${rateNum.toFixed(2)}</td>
                    <td>${qtyNum}</td>
                    <td>${discountNum}%</td>
                    <td>${(cgstNum + sgstNum)}%</td>
                    <td>‚Çπ${(amount + totalGST).toFixed(2)}</td>
                    <td><button class="btn btn-danger btn-sm" onclick="removeFromBill(${index})">üóëÔ∏è</button></td>
                `;
                tableBody.appendChild(row);
            });
        }

        function clearProductInputs() {
            document.getElementById('billProductSearch').value = '';
            document.getElementById('billProductId').value = '';
            document.getElementById('billQty').value = '';
            document.getElementById('billDiscount').value = '0';
            document.getElementById('billBatch').value = '';
            document.getElementById('billExpiry').value = '';
            document.getElementById('availableQty').value = '';
            document.getElementById('billMRP').value = '';
            document.getElementById('billRate').value = '';
            document.getElementById('billProductDropdown').style.display = 'none';
        }

        function removeFromBill(index) {
            billItems.splice(index, 1);
            updateBillTable();
            calculateTotals();
        }

        function calculateTotals() {
            let subtotal = 0;
            let totalDiscount = 0;
            let totalCGST = 0;
            let totalSGST = 0;

            billItems.forEach(item => {
                const itemSubtotal = item.rate * item.quantity;
                const itemDiscount = itemSubtotal * (item.discount / 100);
                const itemAmountAfterDiscount = itemSubtotal - itemDiscount;
                const itemCGST = itemAmountAfterDiscount * (item.cgst / 100);
                const itemSGST = itemAmountAfterDiscount * (item.sgst / 100);

                subtotal += itemSubtotal;
                totalDiscount += itemDiscount;
                totalCGST += itemCGST;
                totalSGST += itemSGST;
            });

            const actualGrandTotal = subtotal - totalDiscount + totalCGST + totalSGST;
            const roundedGrandTotal = Math.round(actualGrandTotal);
            const rounding = (roundedGrandTotal - actualGrandTotal).toFixed(2);

            document.getElementById('subtotal').textContent = `‚Çπ${subtotal.toFixed(2)}`;
            document.getElementById('totalDiscount').textContent = `‚Çπ${totalDiscount.toFixed(2)}`;
            document.getElementById('totalCGST').textContent = `‚Çπ${totalCGST.toFixed(2)}`;
            document.getElementById('totalSGST').textContent = `‚Çπ${totalSGST.toFixed(2)}`;

            // Show rounding row
            let roundingRow = document.getElementById('roundingRow');
            if (!roundingRow) {
                const row = document.createElement('div');
                row.className = 'total-row';
                row.id = 'roundingRow';
                row.innerHTML = `<span>Rounding:</span><span id="roundingValue"></span>`;
                document.querySelector('.total-section').insertBefore(row, document.getElementById('grandTotal').parentNode);
            }
            document.getElementById('roundingValue').textContent = `‚Çπ${rounding}`;

            // Show rounded grand total
            document.getElementById('grandTotal').textContent = `‚Çπ${roundedGrandTotal}`;
        }


        async function generateBill() {
            const patientName = document.getElementById('patientName').value;
            const patientMobile = document.getElementById('patientMobile').value;
            const doctorName = document.getElementById('doctorName').value;
            const grandTotal = parseFloat(document.getElementById('grandTotal').textContent.replace('‚Çπ', ''));
            const subtotal = parseFloat(document.getElementById('subtotal').textContent.replace('‚Çπ', ''));
            const totalDiscount = parseFloat(document.getElementById('totalDiscount').textContent.replace('‚Çπ', ''));
            const totalCGST = parseFloat(document.getElementById('totalCGST').textContent.replace('‚Çπ', ''));
            const totalSGST = parseFloat(document.getElementById('totalSGST').textContent.replace('‚Çπ', ''));

            if (!patientName || !patientMobile) {
                showAlert('Patient Name and Mobile are required to generate a bill.', 'danger');
                return;
            }

            if (billItems.length === 0) {
                showAlert('Please add at least one item to the bill.', 'danger');
                return;
            }

            const bill = {
                billNumber: `BILL-${Date.now()}`,
                patientName,
                patientMobile,
                doctorName,
                items: billItems.map(item => ({
                    ...item,
                    product_id: item.product_id || item.id // Ensure product_id is set
                })),
                subtotal,
                totalDiscount,
                totalCGST,
                totalSGST,
                grandTotal
            };

            try {
                const response = await fetch(`${API_BASE_URL}/bills`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bill)
                });
                const result = await response.json();
                if (response.ok) {
                    showAlert('Bill generated successfully!', 'success');
                    displayInvoice(bill);
                    await fetchInventory();
                    await fetchDashboardData();
                    clearBill();
                } else {
                    showAlert(result.error, 'danger');
                }
            } catch (error) {
                showAlert('Failed to generate bill.', 'danger');
                console.error('Error generating bill:', error);
            }
        }

        function displayInvoice(bill) {
            const invoiceContent = document.getElementById('invoiceContent');

            let itemsHtml = bill.items.map(item => {
                const amount = (item.rate * item.quantity) - ((item.rate * item.quantity) * (item.discount / 100));
                const totalGST = amount * ((item.cgst + item.sgst) / 100);
                const itemTotal = amount + totalGST;
                return `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.batch}</td>
                        <td>${item.expiry}</td>
                        <td>‚Çπ${item.mrp.toFixed(2)}</td>
                        <td>${item.quantity}</td>
                        <td>‚Çπ${item.rate.toFixed(2)}</td>
                        <td>${item.discount}%</td>
                        <td>${item.cgst}%</td>
                        <td>${item.sgst}%</td>
                        <td>‚Çπ${itemTotal.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');

            // Rounding calculation
            const actualGrandTotal = bill.subtotal - bill.totalDiscount + bill.totalCGST + bill.totalSGST;
            const roundedGrandTotal = Math.round(actualGrandTotal);
            const rounding = (roundedGrandTotal - actualGrandTotal).toFixed(2);

            invoiceContent.innerHTML = `
                <div class="bill-header">
                    <h2 class="no-print">Invoice</h2>
                    <h1>${settings.shopName}</h1>
                    <p>GST: ${settings.gst} | Ph: ${settings.phone} | ${settings.email}</p>
                    <p>${settings.address}</p>
                    <p>Drug License No: ${settings.drugLicense || "DL-XXXXXX"}</p>
                </div>
                
                <div class="bill-details" style="display: flex; justify-content: space-between;">
                    <div><strong>Bill No:</strong> ${bill.billNumber}</div>
                    <div><strong>Date:</strong> ${new Date().toLocaleDateString()}</div>
                </div>
                <div class="bill-details" style="display: flex; justify-content: space-between;">
                    <div><strong>Patient Name:</strong> ${bill.patientName}</div>
                    <div><strong>Patient Mobile:</strong> ${bill.patientMobile}</div>
                </div>
                ${bill.doctorName ? `<div><strong>Doctor Name:</strong> ${bill.doctorName}</div>` : ''}

                <table style="margin-top: 20px;">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Batch</th>
                            <th>Exp</th>
                            <th>MRP</th>
                            <th>Qty</th>
                            <th>Rate</th>
                            <th>Disc %</th>
                            <th>CGST</th>
                            <th>SGST</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                </table>

                <div class="total-section">
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span>‚Çπ${bill.subtotal.toFixed(2)}</span>
                    </div>
                    <div class="total-row">
                        <span>Total Discount:</span>
                        <span>‚Çπ${bill.totalDiscount.toFixed(2)}</span>
                    </div>
                    <div class="total-row">
                        <span>CGST:</span>
                        <span>‚Çπ${bill.totalCGST.toFixed(2)}</span>
                    </div>
                    <div class="total-row">
                        <span>SGST:</span>
                        <span>‚Çπ${bill.totalSGST.toFixed(2)}</span>
                    </div>
                    <div class="total-row">
                        <span>Rounding:</span>
                        <span>‚Çπ${rounding}</span>
                    </div>
                    <div class="total-row">
                        <span>Grand Total:</span>
                        <span>‚Çπ${roundedGrandTotal}</span>
                    </div>
                </div>

                <div style="margin-top:40px;">
                    <p><strong>Pharmacist Name: ________________________</strong></p>
                </div>
            `;

            document.getElementById('invoiceModal').classList.add('active');
        }

        function printInvoice() {
            const invoiceContent = document.getElementById('invoiceContent').innerHTML;
            const originalContent = document.body.innerHTML;

            // Replace body with only invoice
            document.body.innerHTML = invoiceContent;

            // Print just the invoice
            window.print();

            // Restore original page
            document.body.innerHTML = originalContent;
            location.reload(); // reattach scripts/styles if needed
        }


        function clearBill() {
            billItems = [];
            document.getElementById('patientName').value = '';
            document.getElementById('patientMobile').value = '';
            document.getElementById('doctorName').value = '';
            document.getElementById('billProductSearch').value = '';
            document.getElementById('billProductId').value = '';
            document.getElementById('billQty').value = '';
            document.getElementById('billDiscount').value = '0';
            document.getElementById('billBatch').value = '';
            document.getElementById('billExpiry').value = '';
            document.getElementById('availableQty').value = '';
            document.getElementById('billMRP').value = '';
            document.getElementById('billRate').value = '';
            updateBillTable();
            calculateTotals();
        }

        // Dashboard & Reporting
        async function fetchDashboardData() {
            try {
                console.log('Fetching dashboard data...');
                
                const [billsResponse, inventoryResponse, settingsResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/bills`),
                    fetch(`${API_BASE_URL}/products`),
                    fetch(`${API_BASE_URL}/settings`)
                ]);

                const allBills = await billsResponse.json();
                const allProducts = await inventoryResponse.json();
                const currentSettings = await settingsResponse.json();
                
                // Update settings if needed
                if (currentSettings) {
                    settings = currentSettings;
                }
                
                // Get today's sales
                const today = new Date();
                const todayStr = today.toDateString();
                const todaySales = allBills
                    .filter(bill => new Date(bill.bill_date).toDateString() === todayStr)
                    .reduce((sum, bill) => sum + parseFloat(bill.grand_total || 0), 0);
                
                // Get total items
                const totalItems = allProducts.reduce((sum, product) => sum + (product.quantity || 0), 0);

                // Get low stock and expiring items
                const lowStockThreshold = parseInt(settings.lowStockThreshold) || 10;
                const lowStockCount = allProducts.filter(p => (p.quantity || 0) <= lowStockThreshold).length;
                
                const oneMonth = 30 * 24 * 60 * 60 * 1000;
                const expiringCount = allProducts.filter(p => {
                    if (!p.expiry) return false;
                    const expiryDate = new Date(`${p.expiry}-01`);
                    return (expiryDate > today && (expiryDate - today) < oneMonth);
                }).length;

                // Update dashboard UI
                const todaySalesEl = document.getElementById('todaySales');
                const totalItemsEl = document.getElementById('totalItems');
                const lowStockCountEl = document.getElementById('lowStockCount');
                const expiringCountEl = document.getElementById('expiringCount');
                
                if (todaySalesEl) todaySalesEl.textContent = `‚Çπ${todaySales.toFixed(2)}`;
                if (totalItemsEl) totalItemsEl.textContent = totalItems;
                if (lowStockCountEl) lowStockCountEl.textContent = lowStockCount;
                if (expiringCountEl) expiringCountEl.textContent = expiringCount;

                // Update recent transactions
                updateRecentTransactions(allBills);
                
            } catch (error) {
                console.error('Error fetching dashboard data:', error);
                showAlert('Failed to load dashboard data.', 'danger');
            }
        }
        function updateRecentTransactions(bills) {
            const recentTransactionsBody = document.getElementById('recentTransactionsBody');
            if (!recentTransactionsBody) return;
            
            recentTransactionsBody.innerHTML = '';
            
            if (!bills || bills.length === 0) {
                recentTransactionsBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No recent transactions</td></tr>';
                return;
            }

            bills.slice(0, 5).forEach(bill => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${bill.bill_number || 'N/A'}</td>
                    <td>${new Date(bill.bill_date).toLocaleDateString()}</td>
                    <td>${bill.patient_name || 'N/A'}</td>
                    <td>‚Çπ${parseFloat(bill.grand_total || 0).toFixed(2)}</td>
                    <td><span style="color: green; font-weight: bold;">Paid</span></td>
                `;
                recentTransactionsBody.appendChild(row);
            });
        }

        async function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;
            const reportContent = document.getElementById('reportContent');
            reportContent.innerHTML = '';

            try {
                const billsResponse = await fetch(`${API_BASE_URL}/bills`);
                const allBills = await billsResponse.json();

                if (reportType === 'sales') {
                    const filteredSales = allBills.filter(t => {
                        const billDate = new Date(t.bill_date);
                        return billDate >= new Date(fromDate) && billDate <= new Date(toDate);
                    });

                    let totalSales = filteredSales.reduce((sum, t) => sum + parseFloat(t.grand_total), 0);
                    
                    let salesHtml = `<h3>Sales Report from ${fromDate} to ${toDate}</h3>`;
                    salesHtml += `<p><strong>Total Sales:</strong> ‚Çπ${totalSales.toFixed(2)}</p>`;
                    salesHtml += `<table><thead><tr><th>Bill No</th><th>Date</th><th>Patient</th><th>Amount</th></tr></thead><tbody>`;
                    if (filteredSales.length === 0) {
                        salesHtml += `<tr><td colspan="4" style="text-align: center;">No sales in this period.</td></tr>`;
                    } else {
                        filteredSales.forEach(t => {
                            salesHtml += `<tr><td>${t.bill_number}</td><td>${new Date(t.bill_date).toLocaleDateString()}</td><td>${t.patient_name}</td><td>‚Çπ${parseFloat(t.grand_total).toFixed(2)}</td></tr>`;
                        });
                    }
                    salesHtml += `</tbody></table>`;
                    reportContent.innerHTML = salesHtml;

                } else if (reportType === 'gst') {
                    const filteredBills = allBills.filter(t => {
                        const billDate = new Date(t.bill_date);
                        return billDate >= new Date(fromDate) && billDate <= new Date(toDate);
                    });
                    
                    let totalCGST = filteredBills.reduce((sum, t) => sum + parseFloat(t.total_cgst), 0);
                    let totalSGST = filteredBills.reduce((sum, t) => sum + parseFloat(t.total_sgst), 0);

                    let gstHtml = `<h3>GST Report from ${fromDate} to ${toDate}</h3>`;
                    gstHtml += `<p><strong>Total CGST Collected:</strong> ‚Çπ${totalCGST.toFixed(2)}</p>`;
                    gstHtml += `<p><strong>Total SGST Collected:</strong> ‚Çπ${totalSGST.toFixed(2)}</p>`;
                    gstHtml += `<table><thead><tr><th>Bill No</th><th>Date</th><th>Taxable Value</th><th>CGST</th><th>SGST</th></tr></thead><tbody>`;
                    if (filteredBills.length === 0) {
                        gstHtml += `<tr><td colspan="5" style="text-align: center;">No GST data in this period.</td></tr>`;
                    } else {
                        for (const t of filteredBills) {
                            const itemsResponse = await fetch(`${API_BASE_URL}/bills/${t.id}`);
                            const billWithItems = await itemsResponse.json();
                            const taxable = billWithItems.items.reduce((sum, item) => sum + (item.rate * item.quantity) - ((item.rate * item.quantity) * (item.discount / 100)), 0);
                            gstHtml += `<tr><td>${t.bill_number}</td><td>${new Date(t.bill_date).toLocaleDateString()}</td><td>‚Çπ${taxable.toFixed(2)}</td><td>‚Çπ${parseFloat(t.total_cgst).toFixed(2)}</td><td>‚Çπ${parseFloat(t.total_sgst).toFixed(2)}</td></tr>`;
                        }
                    }
                    gstHtml += `</tbody></table>`;
                    reportContent.innerHTML = gstHtml;
                
                } else if (reportType === 'inventory') {
                    const inventoryResponse = await fetch(`${API_BASE_URL}/products`);
                    const allProducts = await response.json();

                    let inventoryHtml = `<h3>Current Inventory Report</h3>`;
                    inventoryHtml += `<table><thead><tr><th>Product Name</th><th>HSN</th><th>Batch</th><th>Quantity</th><th>MRP</th><th>Sale Rate</th><th>Expiry</th><th>CGST %</th><th>SGST %</th></tr></thead><tbody>`;
                    if (allProducts.length === 0) {
                        inventoryHtml += `<tr><td colspan="9" style="text-align: center;">No products in inventory.</td></tr>`;
                    } else {
                        allProducts.forEach(p => {
                            inventoryHtml += `<tr><td>${p.name}</td><td>${p.hsn}</td><td>${p.batch}</td><td>${p.quantity}</td><td>‚Çπ${p.mrp.toFixed(2)}</td><td>‚Çπ${p.sale_rate.toFixed(2)}</td><td>${p.expiry}</td><td>${p.cgst}%</td><td>${p.sgst}%</td></tr>`;
                        });
                    }
                    inventoryHtml += `</tbody></table>`;
                    reportContent.innerHTML = inventoryHtml;

                } else if (reportType === 'expiry') {
                    const inventoryResponse = await fetch(`${API_BASE_URL}/products`);
                    const allProducts = await inventoryResponse.json();
                    const today = new Date();
                    const expired = allProducts.filter(p => new Date(`${p.expiry}-01`) < today);
                    
                    let expiryHtml = `<h3>Expired Products Report</h3>`;
                    expiryHtml += `<table><thead><tr><th>Product Name</th><th>Batch</th><th>Quantity</th><th>Expiry Date</th></tr></thead><tbody>`;
                    if (expired.length === 0) {
                        expiryHtml += `<tr><td colspan="4" style="text-align: center;">No expired products.</td></tr>`;
                    } else {
                        expired.forEach(p => {
                            expiryHtml += `<tr class="expired-item"><td>${p.name}</td><td>${p.batch}</td><td>${p.quantity}</td><td>${p.expiry}</td></tr>`;
                        });
                    }
                    expiryHtml += `</tbody></table>`;
                    reportContent.innerHTML = expiryHtml;
                }
            } catch (error) {
                showAlert('Failed to generate report.', 'danger');
                console.error('Error generating report:', error);
            }
        }
        // ---------------- Bills: Fetch / Show / Edit ----------------

        async function fetchBills() {
            try {
                const response = await fetch(`${API_BASE_URL}/bills`);
                if (!response.ok) throw new Error('Failed to fetch bills');
                const bills = await response.json();
                updateBillsTable(bills);
            } catch (error) {
                console.error('Error fetching bills:', error);
                const billsBody = document.getElementById('billsBody');
                if (billsBody) billsBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Error loading bills</td></tr>';
                showAlert('Failed to fetch bills.', 'danger');
            }
        }

        function updateBillsTable(bills) {
            const billsBody = document.getElementById('billsBody');
            billsBody.innerHTML = '';
            if (!bills || bills.length === 0) {
                billsBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No bills found</td></tr>';
                return;
            }

            bills.forEach(bill => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${bill.bill_number || bill.billNumber || 'N/A'}</td>
                    <td>${new Date(bill.bill_date).toLocaleDateString()}</td>
                    <td>${bill.patient_name || bill.patientName}</td>
                    <td>‚Çπ${parseFloat(bill.grand_total || bill.grandTotal || 0).toFixed(2)}</td>
                    <td>
                        <button class="btn btn-warning" onclick="viewBill(${bill.id})">‚úèÔ∏è View/Edit</button>
                        <button class="btn btn-info" onclick="printOldBill(${bill.id})" style="margin-left: 5px;">üñ®Ô∏è Print</button>
                    </td>

                `;
                billsBody.appendChild(row);
            });
        }

        async function viewBill(billId) {
            try {
                const response = await fetch(`${API_BASE_URL}/bills/${billId}`);
                if (!response.ok) throw new Error('Failed to fetch bill');
                const bill = await response.json();

                // Build editable rows for each item
                let itemsHtml = bill.items.map((item, index) => `
                    <tr>
                        <td>${item.product_name || item.productName || item.name}</td>
                        <td>${item.batch || ''}</td>
                        <td><input type="month" value="${item.expiry || ''}" data-index="${index}" class="edit-expiry" style="width:100px;"></td>
                        <td>‚Çπ${item.mrp ? Number(item.mrp).toFixed(2) : '0.00'}</td>
                        <td><input type="number" min="1" value="${item.quantity}" data-index="${index}" class="edit-qty" style="width:60px;"></td>
                        <td><input type="number" min="0" step="0.01" value="${item.rate}" data-index="${index}" class="edit-rate" style="width:80px;"></td>
                        <td><input type="number" min="0" max="100" value="${item.discount || 0}" data-index="${index}" class="edit-discount" style="width:60px;"></td>
                        <td>${item.cgst}%</td>
                        <td>${item.sgst}%</td>
                        <td>‚Çπ${(Number(item.rate) * Number(item.quantity)).toFixed(2)}</td>
                        <input type="hidden" data-index="${index}" class="edit-mrp" value="${item.mrp || 0}">
                    </tr>
                `).join('');

                document.getElementById('editBillContent').innerHTML = `
                    <p><strong>Bill No:</strong> ${bill.bill_number || bill.billNumber}</p>
                    <p><strong>Date:</strong> ${new Date(bill.bill_date).toLocaleDateString()}</p>
                    <p><strong>Patient:</strong> ${bill.patient_name || bill.patientName} | <strong>Mobile:</strong> ${bill.patient_mobile || bill.patientMobile}</p>
                    <table style="width:100%; margin-top:10px;">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Batch</th>
                                <th>Expiry</th>
                                <th>MRP</th>
                                <th>Qty</th>
                                <th>Rate</th>
                                <th>Discount</th>
                                <th>CGST</th>
                                <th>SGST</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                    </table>
                `;
                document.getElementById('editBillModal').classList.add('active');

                // Keep the bill for saving later
                window.currentEditingBill = bill;
            } catch (error) {
                console.error('Error viewing bill:', error);
                showAlert('Failed to fetch bill details.', 'danger');
            }
        }

        async function saveEditedBill() {
            if (!window.currentEditingBill) return;

                // Read edited values
                const qtyInputs = document.querySelectorAll('.edit-qty');
                const rateInputs = document.querySelectorAll('.edit-rate');
                const discountInputs = document.querySelectorAll('.edit-discount');
                const mrpInputs = document.querySelectorAll('.edit-mrp');
                const expiryInputs = document.querySelectorAll('.edit-expiry');

                qtyInputs.forEach(input => {
                    const index = Number(input.dataset.index);
                    window.currentEditingBill.items[index].quantity = Number(input.value);
                });
                rateInputs.forEach(input => {
                    const index = Number(input.dataset.index);
                    window.currentEditingBill.items[index].rate = Number(input.value);
                });
                discountInputs.forEach(input => {
                    const index = Number(input.dataset.index);
                    window.currentEditingBill.items[index].discount = Number(input.value);
                });

                // Preserve MRP and Expiry from hidden fields
                mrpInputs.forEach(input => {
                    const index = Number(input.dataset.index);
                    window.currentEditingBill.items[index].mrp = Number(input.value);
                });
                expiryInputs.forEach(input => {
                    const index = Number(input.dataset.index);
                    window.currentEditingBill.items[index].expiry = input.value;
                });

            // Recalculate totals on the client side (server will also re-calc/validate)
            const items = window.currentEditingBill.items.map(it => {
                return {
                    product_id: it.product_id || it.productId || it.id || null,
                    product_name: it.product_name || it.productName || it.name,
                    batch: it.batch,
                    mrp: Number(it.mrp || 0),                   // ‚úÖ Include MRP
                    expiry: it.expiry || null,                  // ‚úÖ Include Expiry
                    rate: Number(it.rate),
                    quantity: Number(it.quantity),
                    discount: Number(it.discount || 0),
                    cgst: Number(it.cgst),
                    sgst: Number(it.sgst)
                };
            });

            const subtotal = items.reduce((s, it) => s + (it.rate * it.quantity), 0);
            const totalDiscount = items.reduce((s, it) => s + ((it.rate * it.quantity) * (it.discount / 100)), 0);
            const totalCGST = items.reduce((s, it) => s + ((it.rate * it.quantity - (it.rate * it.quantity * (it.discount/100))) * (it.cgst / 100)), 0);
            const totalSGST = items.reduce((s, it) => s + ((it.rate * it.quantity - (it.rate * it.quantity * (it.discount/100))) * (it.sgst / 100)), 0);
            const grandTotal = subtotal - totalDiscount + totalCGST + totalSGST;

            const payload = {
                bill_number: window.currentEditingBill.bill_number || window.currentEditingBill.billNumber,
                bill_date: window.currentEditingBill.bill_date || window.currentEditingBill.billDate || new Date().toISOString(),
                patient_name: window.currentEditingBill.patient_name || window.currentEditingBill.patientName,
                patient_mobile: window.currentEditingBill.patient_mobile || window.currentEditingBill.patientMobile,
                doctor_name: window.currentEditingBill.doctor_name || window.currentEditingBill.doctorName,
                items: items,
                subtotal,
                total_discount: totalDiscount,
                total_cgst: totalCGST,
                total_sgst: totalSGST,
                grand_total: grandTotal
            };

            try {
                const response = await fetch(`${API_BASE_URL}/bills/${window.currentEditingBill.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (response.ok) {
                    showAlert('Bill updated successfully!', 'success');
                    closeModal('editBillModal');
                    fetchBills();
                    await fetchInventory();
                    await fetchDashboardData();
                } else {
                    showAlert(result.error || 'Failed to update bill', 'danger');
                    console.error('Update error result:', result);
                }
            } catch (error) {
                console.error('Error saving edited bill:', error);
                showAlert('Failed to update bill.', 'danger');
            }
        }

        async function printOldBill(billId) {
            // --- FIX #1: Correctly copy all bill properties ---
            try {
                const response = await fetch(`${API_BASE_URL}/bills/${billId}`);
                if (!response.ok) throw new Error('Failed to fetch bill');
                
                const billFromServer = await response.json();

                const billForDisplay = {
                    ...billFromServer, 
                    items: billFromServer.items.map(item => ({
                        name: item.product_name || item.productName || item.name,
                        batch: item.batch || '',
                        expiry: item.expiry || 'N/A',
                        mrp: parseFloat(item.mrp || 0),
                        rate: parseFloat(item.rate || 0),
                        quantity: parseInt(item.quantity || 0),
                        discount: parseFloat(item.discount || 0),
                        cgst: parseFloat(item.cgst || 0),
                        sgst: parseFloat(item.sgst || 0)
                    }))
                };
                
                displayOldInvoice(billForDisplay);

            } catch (error) {
                console.error('Error printing old bill:', error);
                showAlert('Failed to load bill for printing.', 'danger');
            }
        }

        function displayOldInvoice(bill) {
            // --- FIX #2: Use correct snake_case properties from server ---
            const invoiceContent = document.getElementById('invoiceContent');

            let itemsHtml = bill.items.map(item => {
                const amount = (item.rate * item.quantity) - ((item.rate * item.quantity) * (item.discount / 100));
                const totalGST = amount * ((item.cgst + item.sgst) / 100);
                const itemTotal = amount + totalGST;
                return `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.batch}</td>
                        <td>${item.expiry}</td>
                        <td>‚Çπ${item.mrp.toFixed(2)}</td>
                        <td>${item.quantity}</td>
                        <td>‚Çπ${item.rate.toFixed(2)}</td>
                        <td>${item.discount}%</td>
                        <td>${item.cgst}%</td>
                        <td>${item.sgst}%</td>
                        <td>‚Çπ${itemTotal.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
            
            // Use snake_case properties that come from the server
            const subtotal = Number(bill.subtotal || 0);
            const total_discount = Number(bill.total_discount || 0);
            const total_cgst = Number(bill.total_cgst || 0);
            const total_sgst = Number(bill.total_sgst || 0);

            const actualGrandTotal = subtotal - total_discount + total_cgst + total_sgst;
            const roundedGrandTotal = Math.round(actualGrandTotal);
            const rounding = (roundedGrandTotal - actualGrandTotal).toFixed(2);
            
            const billDate = new Date(bill.bill_date);
            const formattedDate = billDate.toLocaleDateString('en-GB'); // dd/mm/yyyy

            invoiceContent.innerHTML = `
                <div class="bill-header">
                    <h2 class="no-print">Invoice</h2>
                    <h1>${settings.shopName || 'MediCare Pharmacy'}</h1>
                    <p>GST: ${settings.gst || 'N/A'} | Ph: ${settings.phone || 'N/A'} | ${settings.email || 'N/A'}</p>
                    <p>${settings.address || 'N/A'}</p>
                    <p>Drug License No: ${settings.drugLicense || "DL-XXXXXX"}</p>
                </div>
                
                <div class="bill-details" style="display: flex; justify-content: space-between;">
                    <div><strong>Bill No:</strong> ${bill.bill_number}</div>
                    <div><strong>Date:</strong> ${formattedDate}</div>
                </div>
                <div class="bill-details" style="display: flex; justify-content: space-between;">
                    <div><strong>Patient Name:</strong> ${bill.patient_name}</div>
                    <div><strong>Patient Mobile:</strong> ${bill.patient_mobile}</div>
                </div>
                ${bill.doctor_name ? `<div><strong>Doctor Name:</strong> ${bill.doctor_name}</div>` : ''}

                <table style="margin-top: 20px;">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Batch</th>
                            <th>Exp</th>
                            <th>MRP</th>
                            <th>Qty</th>
                            <th>Rate</th>
                            <th>Disc %</th>
                            <th>CGST</th>
                            <th>SGST</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                </table>

                <div class="total-section">
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span>‚Çπ${subtotal.toFixed(2)}</span>
                    </div>
                    <div class="total-row">
                        <span>Total Discount:</span>
                        <span>‚Çπ${total_discount.toFixed(2)}</span>
                    </div>
                    <div class="total-row">
                        <span>CGST:</span>
                        <span>‚Çπ${total_cgst.toFixed(2)}</span>
                    </div>
                    <div class="total-row">
                        <span>SGST:</span>
                        <span>‚Çπ${total_sgst.toFixed(2)}</span>
                    </div>
                    <div class="total-row">
                        <span>Rounding:</span>
                        <span>‚Çπ${rounding}</span>
                    </div>
                    <div class="total-row">
                        <span>Grand Total:</span>
                        <span>‚Çπ${roundedGrandTotal}</span>
                    </div>
                </div>

                <div style="margin-top:40px;">
                    <p><strong>Pharmacist Name: ________________________</strong></p>
                </div>
            `;

            document.getElementById('invoiceModal').classList.add('active');
        }
        // ---------------- end Bills feature ----------------


        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportFromDate').value = today;
            document.getElementById('reportToDate').value = today;
        }

        // Helper Functions
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            document.querySelector('.content').prepend(alertDiv);
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Customer Management
        async function fetchCustomers() {
            try {
                const response = await fetch(`${API_BASE_URL}/customers`);
                const customers = await response.json();
                updateCustomersTable(customers);
            } catch (error) {
                console.error('Error fetching customers:', error);
                showAlert('Failed to load customers.', 'danger');
            }
        }

        function updateCustomersTable(data) {
            const tableBody = document.getElementById('customersBody');
            tableBody.innerHTML = '';
            if (!data || data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No customers found</td></tr>';
                return;
            }

            data.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.id}</td>
                    <td>${customer.name || 'N/A'}</td>
                    <td>${customer.mobile || 'N/A'}</td>
                    <td>${customer.doctor_name || 'N/A'}</td>
                    <td>
                        <button class="btn btn-warning" style="padding: 5px 10px;" onclick="showEditCustomerModal(${customer.id})">‚úèÔ∏è</button>
                        <button class="btn btn-danger" style="padding: 5px 10px;" onclick="deleteCustomer(${customer.id})">‚ùå</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        async function searchCustomers() {
            const query = document.getElementById('customerSearch').value.toLowerCase();
            try {
                const response = await fetch(`${API_BASE_URL}/customers/search?query=${query}`);
                const filtered = await response.json();
                updateCustomersTable(filtered);
            } catch (error) {
                showAlert('Failed to search customers.', 'danger');
                console.error('Error searching customers:', error);
            }
        }
        
        async function showEditCustomerModal(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/customers/${id}`);
                if (!response.ok) {
                    throw new Error('Customer not found');
                }
                const customer = await response.json();
                
                document.getElementById('editCustomerId').value = customer.id;
                document.getElementById('editCustomerName').value = customer.name;
                document.getElementById('editCustomerMobile').value = customer.mobile;
                document.getElementById('editCustomerDoctorName').value = customer.doctor_name || '';
                
                document.getElementById('editCustomerModal').classList.add('active');
            } catch (error) {
                showAlert(error.message, 'danger');
                console.error('Error fetching customer for edit:', error);
            }
        }

        async function updateCustomer() {
            const id = document.getElementById('editCustomerId').value;
            const customer = {
                name: document.getElementById('editCustomerName').value,
                mobile: document.getElementById('editCustomerMobile').value,
                doctor_name: document.getElementById('editCustomerDoctorName').value
            };

            if (!customer.name || !customer.mobile) {
                showAlert('Please fill all required fields!', 'danger');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/customers/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(customer)
                });
                const result = await response.json();
                if (response.ok) {
                    showAlert(result.message, 'success');
                    await fetchCustomers();
                    closeModal('editCustomerModal');
                } else {
                    showAlert(result.error, 'danger');
                }
            } catch (error) {
                showAlert('Failed to update customer.', 'danger');
                console.error('Error updating customer:', error);
            }
        }

        async function deleteCustomer(id) {
            if (confirm('Are you sure you want to delete this customer? This will not affect existing bills.')) {
                try {
                    const response = await fetch(`${API_BASE_URL}/customers/${id}`, { method: 'DELETE' });
                    const result = await response.json();
                    if (response.ok) {
                        showAlert(result.message, 'success');
                        await fetchCustomers();
                    } else {
                        showAlert(result.error, 'danger');
                    }
                } catch (error) {
                    showAlert('Failed to delete customer.', 'danger');
                    console.error('Error deleting customer:', error);
                }
            }
        }

        async function searchCustomer() {
            const nameQuery = document.getElementById('patientName').value.trim();
            const mobileQuery = document.getElementById('patientMobile').value.trim();
            const dropdown = document.getElementById('patientNameDropdown');
            dropdown.innerHTML = '';

            const query = nameQuery || mobileQuery;
            if (query.length < 2) {
                dropdown.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/customers/search?query=${encodeURIComponent(query)}`);
                const customers = await response.json();

                if (customers.length > 0) {
                    customers.forEach(customer => {
                        const item = document.createElement('div');
                        item.textContent = `${customer.name} - ${customer.mobile}`;
                        item.onclick = () => selectCustomer(customer);
                        dropdown.appendChild(item);
                    });
                    dropdown.style.display = 'block';
                } else {
                    dropdown.style.display = 'none';
                }
            } catch (error) {
                console.error('Error searching customers:', error);
                dropdown.style.display = 'none';
            }
        }

        function selectCustomer(customer) {
            document.getElementById('patientName').value = customer.name;
            document.getElementById('patientMobile').value = customer.mobile;
            document.getElementById('doctorName').value = customer.doctor_name || '';
            document.getElementById('patientNameDropdown').style.display = 'none';
        }

        document.addEventListener('click', function(event) {
            const nameInput = document.getElementById('patientName');
            const mobileInput = document.getElementById('patientMobile');
            const dropdown = document.getElementById('patientNameDropdown');
            if (nameInput && mobileInput && dropdown && !nameInput.contains(event.target) && !mobileInput.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });
    </script>
</body>
</html>
