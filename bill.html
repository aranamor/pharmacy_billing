<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmacy Billing System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #43cea2 0%, #185a9d 100%);
            --accent-color: #185a9d; /* A deep, classy blue */
            --background-color: #f8f9fa; /* A very light grey for the main background */
            --container-background: #ffffff;
            --text-primary: #2c3e50; /* A darker, softer black */
            --text-secondary: #7f8c8d;
            --border-color: #ecf0f1;
            
            --success-gradient: linear-gradient(135deg, #2ecc71 0%, #1abc9c 100%);
            --danger-gradient: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            --warning-gradient: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            --info-gradient: linear-gradient(135deg, #3498db 0%, #2980b9 100%);

            --shadow-color: rgba(24, 90, 157, 0.1);
            --shadow-light: rgba(44, 62, 80, 0.05);
            --shadow-strong: rgba(44, 62, 80, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--container-background);
            color: var(--text-primary);
            font-size: 16px;
        }

        .container {
            width: 100%;
            min-height: 100vh;
            background: var(--container-background);
            overflow: hidden;
        }

        .header {
            background: var(--primary-gradient);
            color: white;
            padding: 2.5rem;
            text-align: center;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .shop-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            flex-direction: column;
            margin-bottom: 1rem;
        }
        
        .logo-container img {
            max-width: 350px;
            height: auto;
        }

        .tabs {
            display: flex;
            background: #ffffff;
            border-bottom: 2px solid var(--border-color);
            overflow-x: auto;
            padding: 0 1.5rem;
            box-shadow: 0 4px 6px -1px var(--shadow-light);
        }

        .tab {
            padding: 1.25rem 1.5rem;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            white-space: nowrap;
            border-bottom: 4px solid transparent;
        }

        .tab:hover {
            color: var(--accent-color);
        }

        .tab.active {
            color: var(--accent-color);
            border-bottom: 4px solid var(--accent-color);
        }
        
        .tab.logout-btn {
            margin-left: auto;
            color: #e74c3c;
        }
        
        .tab.logout-btn:hover {
            color: #c0392b;
        }

        .content {
            padding: 2.5rem;
            min-height: 600px;
            background-color: var(--background-color);
        }

        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        h2 {
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 1rem;
        }
        h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group { position: relative; }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 1rem;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.9rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s ease;
            background-color: #fff;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px var(--shadow-color);
        }
        input:read-only {
            background-color: #fdfdfe;
            cursor: not-allowed;
        }

        .btn {
            padding: 0.9rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.2); }
        .btn:active { transform: translateY(-1px); box-shadow: 0 5px 10px -3px rgba(0,0,0,0.2); }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.8rem; }

        .btn-primary { background: var(--primary-gradient); color: white; }
        .btn-success { background: var(--success-gradient); color: white; }
        .btn-danger { background: var(--danger-gradient); color: white; }
        .btn-warning { background: var(--warning-gradient); color: white; }
        .btn-info { background: var(--info-gradient); color: white; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 2rem;
            font-size: 1rem;
            background-color: #fff;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 12px var(--shadow-light);
        }
        thead {
            background-color: #f1f5f9;
        }
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        th {
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }
        tbody tr:last-child td {
            border-bottom: none;
        }
        tbody tr:hover { background-color: #f8fafc; }
        td input { padding: 0.5rem; font-size: 1rem; border-radius: 8px; border: 1px solid var(--border-color); }

        .inventory-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            position: relative;
            max-width: 400px;
        }
        .search-box input {
            width: 100%;
            padding: 0.9rem 3rem 0.9rem 1rem;
            border-radius: 50px;
        }
        .search-box::after {
            content: "üîç";
            position: absolute;
            right: 1.25rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
        }
        
        .bill-section { background: #ffffff; padding: 2rem; border-radius: 16px; margin-top: 2rem; box-shadow: 0 4px 12px var(--shadow-light); }
        
        .total-section {
            background: #ffffff;
            padding: 2rem;
            border-radius: 16px;
            margin-top: 2rem;
            border: 2px solid var(--accent-color);
            box-shadow: 0 10px 20px -5px var(--shadow-color);
        }
        .total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 1.1rem;
        }
        .total-row:last-child {
            border-bottom: none;
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent-color);
        }
        .total-row span:first-child { font-weight: 600; }
        #overallDiscountPercent { width: 100px; text-align: right; font-size: 1.1rem; font-weight: 600; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 12px var(--shadow-light);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        .stat-card:nth-child(1) { border-left: 6px solid #1abc9c; }
        .stat-card:nth-child(2) { border-left: 6px solid #3498db; }
        .stat-card:nth-child(3) { border-left: 6px solid #9b59b6; }
        .stat-card:nth-child(4) { border-left: 6px solid #e67e22; }
        .stat-card:nth-child(5) { border-left: 6px solid #e74c3c; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px var(--shadow-color); }
        .stat-card h3 { font-size: 1.1rem; margin-bottom: 0.5rem; color: var(--text-secondary); }
        .stat-card .value { font-size: 3rem; font-weight: 700; color: var(--text-primary); }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 2.5rem; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: 24px; animation: slideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .alert { position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 12px; z-index: 9999; box-shadow: 0 5px 15px rgba(0,0,0,0.2); animation: slideIn 0.3s, fadeOut 0.5s 4.5s forwards; font-weight: 600; }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .alert-success { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .alert-danger { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .alert-warning { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .alert-info { background: #e0f2fe; color: #075985; border: 1px solid #bae6fd; }

        @media print {
            body { background: white; }
            .no-print { display: none !important; }
            .container { box-shadow: none; border: none; margin: 0; max-width: 100%; }
            .content { padding: 0; background-color: #fff; }
            .invoice-container { box-shadow: none; }
        }

        .expired-item { background: #fee2e2 !important; }
        .low-stock { background: #fef3c7 !important; }

        .filter-btn-group { display: flex; gap: 0.5rem; background: #ffffff; padding: 0.5rem; border-radius: 50px; border: 1px solid var(--border-color); }
        .filter-btn { background: none; border: none; padding: 0.75rem 1.5rem; border-radius: 50px; cursor: pointer; font-weight: 600; color: var(--text-secondary); transition: all 0.3s ease; font-size: 0.9rem; }
        .filter-btn:hover { background: var(--border-color); }
        .filter-btn.active { background: var(--primary-gradient); color: white; box-shadow: 0 4px 10px rgba(24, 90, 157, 0.3); }

        .select-wrapper { position: relative; }
        .select-wrapper .dropdown-list {
            display: none; position: absolute; top: 105%; left: 0; width: 100%; max-height: 250px;
            overflow-y: auto; border: 1px solid var(--border-color); background-color: white; z-index: 100;
            border-radius: 12px; box-shadow: 0 10px 15px -3px var(--shadow-light);
        }
        .select-wrapper .dropdown-list div { padding: 0.75rem 1rem; cursor: pointer; font-size: 0.95rem; }
        .select-wrapper .dropdown-list div:hover { background-color: #f1f5f9; }
        
        .modal-content[style*="min-width: 90vw"] { max-width: 1400px; }
    </style>
</head>
<body>
    <div id="alert-container"></div>
    <div class="container no-print">
        <div class="header">
            <div class="shop-info">
                <div class="logo-container">
                    <img src="logo2.png" alt="Shop Logo">
                </div>
                <div>
                    <h1 id="shopName"></h1>
                    <p>Wahi Kaam Sahi Daam | GST: 16GLDPD3626M1Z0</p>
                    <p>D.L No. RLF20TR2025000281 | RLF21TR2025000273</p>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="switchTab('billing')">üí∞ Billing</button>
            <button class="tab" onclick="switchTab('inventory')">üì¶ Inventory</button>
            <button class="tab" onclick="switchTab('purchases')">üõí Purchases</button>
            <button class="tab" onclick="switchTab('customers')">üë• Customers</button>
            <button class="tab" onclick="switchTab('reports')">üìà Reports</button>
            <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
            <button class="tab" onclick="switchTab('oldBills')">üìú Bills</button>
            <button class="tab logout-btn" onclick="logout()">üîí Logout</button>
        </div>

        <div class="content">
             <!-- All other HTML content remains unchanged -->
            <div id="dashboard" class="tab-content active">
                <h2>Dashboard Overview</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Today's Sales</h3>
                        <div class="value" id="todaySales">‚Çπ0.00</div>
                    </div>
                    <div class="stat-card">
                        <h3>Today's Bills</h3>
                        <div class="value" id="todayBillsCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Inventory Items</h3>
                        <div class="value" id="totalItems">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Low Stock Alerts</h3>
                        <div class="value" id="lowStockCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Expiring Soon</h3>
                        <div class="value" id="expiringCount">0</div>
                    </div>
                </div>

                <h3>Recent Transactions</h3>
                <table id="recentTransactions">
                    <thead>
                        <tr>
                            <th>Bill No</th>
                            <th>Date</th>
                            <th>Patient</th>
                            <th>Amount</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="recentTransactionsBody">
                        <tr><td colspan="5" style="text-align: center;">No recent transactions</td></tr>
                    </tbody>
                </table>
            </div>

            <div id="billing" class="tab-content">
                <h2>New Bill</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Patient Name *</label>
                        <div class="select-wrapper">
                            <input type="text" id="patientName" placeholder="Enter patient name" oninput="searchCustomer()" autocomplete="off">
                            <div class="dropdown-list" id="patientNameDropdown"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Patient Mobile *</label>
                        <div class="select-wrapper">
                            <input type="tel" id="patientMobile" placeholder="10-digit mobile number" maxlength="10" oninput="searchCustomer()" autocomplete="off">
                            <div class="dropdown-list" id="patientMobileDropdown"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Doctor Name</label>
                        <input type="text" id="doctorName" placeholder="Prescribing doctor (optional)">
                    </div>
                    <div class="form-group">
                        <label>Bill Date</label>
                        <input type="date" id="saleBillDate">
                    </div>
                </div>

                <h3>Add Products</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Select Product *</label>
                        <div class="select-wrapper">
                            <input type="text" id="billProductSearch" placeholder="Search product..." autocomplete="off" oninput="searchProducts()" onfocus="showProductDropdown()">
                            <div class="dropdown-list" id="billProductDropdown"></div>
                            <input type="hidden" id="billProductId">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Batch</label>
                        <input type="text" id="billBatch" readonly>
                    </div>
                    <div class="form-group">
                        <label>Expiry</label>
                        <input type="month" id="billExpiry" readonly>
                    </div>
                    <div class="form-group">
                        <label>Available Qty</label>
                        <input type="number" id="availableQty" readonly>
                    </div>
                    <div class="form-group">
                        <label>MRP</label>
                        <input type="number" id="billMRP" readonly>
                    </div>
                    <div class="form-group">
                        <label>Sale Rate</label>
                        <input type="number" id="billRate" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Quantity *</label>
                        <input type="number" id="billQty" min="0.01" step="0.01" placeholder="Enter quantity">
                    </div>
                    <div class="form-group">
                        <label>Discount (%)</label>
                        <input type="number" id="billDiscount" min="0" max="100" value="0" step="0.01">
                    </div>
                </div>

                <button class="btn btn-primary" onclick="addToBill()">‚ûï Add to Bill</button>

                <div class="bill-section">
                    <h3>Current Bill Items</h3>
                    <table id="billItemsTable">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Batch</th>
                                <th>Exp</th>
                                <th>MRP</th>
                                <th>Rate</th>
                                <th>Qty</th>
                                <th>Disc %</th>
                                <th>GST</th>
                                <th>Amount</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="billItemsBody">
                            <tr><td colspan="10" style="text-align: center;">No items added</td></tr>
                        </tbody>
                    </table>

                    <div class="total-section">
                        <div class="total-row">
                            <span>Subtotal:</span>
                            <span id="subtotal">‚Çπ0.00</span>
                        </div>
                        <div class="total-row">
                            <span>Total Discount:</span>
                            <span id="totalDiscount">‚Çπ0.00</span>
                        </div>
                        <div class="total-row">
                            <span>CGST:</span>
                            <span id="totalCGST">‚Çπ0.00</span>
                        </div>
                        <div class="total-row">
                            <span>SGST:</span>
                            <span id="totalSGST">‚Çπ0.00</span>
                        </div>
                        <div class="total-row">
                            <label for="overallDiscountPercent">Overall Discount (%):</label>
                            <input type="number" id="overallDiscountPercent" value="0" min="0" oninput="calculateTotals()">
                        </div>
                        <div class="total-row">
                            <span>Grand Total:</span>
                            <span id="grandTotal">‚Çπ0.00</span>
                        </div>
                    </div>

                    <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                        <button class="btn btn-success" onclick="generateBill()">üñ®Ô∏è Generate Bill</button>
                        <button class="btn btn-danger" onclick="clearBill()">üóëÔ∏è Clear Bill</button>
                    </div>
                </div>
            </div>

            <div id="inventory" class="tab-content">
                <h2>Inventory Management</h2>
                
                <div class="inventory-actions">
                    <button class="btn btn-primary" onclick="showAddProductModal()">‚ûï Add New Product</button>
                    
                    <div id="expiry-filter-group" class="filter-btn-group">
                        <button class="filter-btn active" onclick="applyExpiryFilter('none', this)">Show All</button>
                        <button class="filter-btn" onclick="applyExpiryFilter('expired', this)">Expired</button>
                        <button class="filter-btn" onclick="applyExpiryFilter('thisMonth', this)">This Month</button>
                        <button class="filter-btn" onclick="applyExpiryFilter('next2months', this)">Next 2 Months</button>
                        <button class="filter-btn" onclick="applyExpiryFilter('next3months', this)">Next 3 Months</button>
                    </div>

                    <button class="btn btn-warning" onclick="checkLowStock()">üìâ Low Stock Alert</button>
                </div>

                <div class="search-box">
                    <input type="text" id="inventorySearch" placeholder="Search products by name, batch, or HSN..." onkeyup="searchInventory()">
                </div>

                <table id="inventoryTable">
                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>Packaging</th>
                            <th>HSN</th>
                            <th>Batch</th>
                            <th>Quantity</th>
                            <th>MRP</th>
                            <th>Purchase Rate</th>
                            <th>Sale Rate (Incl. GST)</th>
                            <th>Expiry</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryBody">
                        <tr><td colspan="10" style="text-align: center;">Loading inventory...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div id="purchases" class="tab-content">
                <h2>Purchase Management</h2>
                <div class="inventory-actions">
                    <button class="btn btn-primary" onclick="showAddPurchaseModal()">‚ûï Add New Purchase Bill</button>
                </div>
                <table id="purchaseBillsTable">
                    <thead>
                        <tr>
                            <th>Bill No</th>
                            <th>Supplier</th>
                            <th>Bill Date</th>
                            <th>Tax Type</th>
                            <th>Total Amount</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="purchaseBillsBody">
                        <tr><td colspan="6" style="text-align:center;">Loading purchase bills...</td></tr>
                    </tbody>
                </table>
            </div>

            <div id="customers" class="tab-content">
                <h2>Customer Management</h2>
                <div class="inventory-actions">
                    <div class="search-box">
                        <input type="text" id="customerSearch" placeholder="Search customers..." onkeyup="searchCustomers()">
                    </div>
                </div>
                <table id="customersTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Mobile</th>
                            <th>Doctor Name</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customersBody">
                        <tr><td colspan="5" style="text-align: center;">Loading customers...</td></tr>
                    </tbody>
                </table>
            </div>

            <div id="reports" class="tab-content">
                <h2>Reports & Analytics</h2>
                
                <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr 0.5fr; align-items: end;">
                    <div class="form-group">
                        <label>From Date</label>
                        <input type="date" id="reportFromDate">
                    </div>
                    <div class="form-group">
                        <label>To Date</label>
                        <input type="date" id="reportToDate">
                    </div>
                    <div class="form-group">
                        <label>Report Type</label>
                        <select id="reportType">
                            <option value="sales">Sales Report</option>
                            <option value="purchases">Purchase Report</option>
                            <option value="gst">GST Report</option>
                            <option value="hsn_sale">HSN-wise Sale Report</option>
                            <option value="inventory">Inventory Report</option>
                            <option value="expiry">Expiry Report</option>
                        </select>
                    </div>
                     <button class="btn btn-primary" onclick="generateReport()">üìä Generate</button>
                </div>

                <div id="reportContent" style="margin-top: 3rem;"></div>
            </div>

            <div id="settings" class="tab-content">
                <h2>Settings</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Shop Name</label>
                        <input type="text" id="settingsShopName" value="Genericart Medicine Store">
                    </div>
                    <div class="form-group">
                        <label>GST Number</label>
                        <input type="text" id="settingsGST" value="16GLDPD3626M1Z0">
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="settingsPhone" value="6009700852">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="settingsEmail" value="genericartcr@gmail.com">
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" id="settingsAddress" value="Near MBB Club, Shivnagar, 799001">
                    </div>
                    <div class="form-group">
                        <label>Low Stock Alert (Qty)</label>
                        <input type="number" id="lowStockThreshold" value="10" step="0.01">
                    </div>
                </div>

                <button class="btn btn-success" onclick="saveSettings()">üíæ Save Settings</button>
            </div>
            
            <div id="oldBills" class="tab-content">
                <h2>All Bills</h2>
                <table id="billsTable">
                    <thead>
                        <tr>
                            <th>Bill No</th>
                            <th>Date</th>
                            <th>Patient</th>
                            <th>Total</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="billsBody">
                        <tr><td colspan="5" style="text-align:center;">Loading bills...</td></tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>

    <!-- MODALS SECTION -->
    <div id="addProductModal" class="modal no-print">
        <div class="modal-content">
            <h2 id="productModalTitle">Add New Product</h2>
            <input type="hidden" id="editProductId">
            <div class="form-grid">
                <div class="form-group"> <label>Product Name *</label> <input type="text" id="productName"> </div>
                <div class="form-group"> <label>Packaging Type</label> <select id="productPackaging"></select> </div>
                <div class="form-group"> <label>HSN Code *</label> <input type="text" id="productHSN"> </div>
                <div class="form-group"> <label>Batch Number *</label> <input type="text" id="productBatch"> </div>
                <div class="form-group"> <label>Quantity *</label> <input type="number" id="productQuantity" min="0" step="0.01"> </div>
                <div class="form-group"> <label>Purchase Rate *</label> <input type="number" id="productPurchaseRate" step="0.01"> </div>
                <div class="form-group"> <label>MRP *</label> <input type="number" id="productMRP" step="0.01"> </div>
                <div class="form-group"> <label>Sale Rate (Incl. Tax) *</label> <input type="number" id="productSaleRateInclusive" step="0.01" oninput="calculateModalSaleExclusiveRate()"> </div>
                <div class="form-group"> <label>Sale Rate (Excl. Tax)</label> <input type="number" id="productSaleRate" step="0.01" readonly> </div>
                <div class="form-group"> <label>CGST % *</label> <input type="number" id="productCGST" value="6" oninput="calculateModalSaleExclusiveRate()"> </div>
                <div class="form-group"> <label>SGST % *</label> <input type="number" id="productSGST" value="6" oninput="calculateModalSaleExclusiveRate()"> </div>
                <div class="form-group"> <label>Expiry Date *</label> <input type="month" id="productExpiry"> </div>
            </div>
            <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                <button id="productModalSaveBtn" class="btn btn-success" onclick="saveProduct()">Add Product</button>
                <button class="btn btn-danger" onclick="closeModal('addProductModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="addPurchaseModal" class="modal no-print">
        <div class="modal-content" style="min-width: 90vw;">
            <h2>Add New Purchase Bill</h2>
            <div class="form-grid">
                <div class="form-group"> <label>Supplier Name *</label> <input type="text" id="purchaseSupplierName"> </div>
                <div class="form-group"> <label>Purchase Bill No *</label> <input type="text" id="purchaseBillNumber"> </div>
                <div class="form-group"> <label>Bill Date *</label> <input type="date" id="purchaseBillDate"> </div>
            </div>
            <div style="margin: 1rem 0; display: flex; gap: 1.5rem;">
                <strong>Tax Type:</strong>
                <label><input type="radio" name="purchaseTaxType" value="CSGST" checked> CGST/SGST</label>
                <label><input type="radio" name="purchaseTaxType" value="IGST"> IGST</label>
            </div>
            <hr style="margin: 2rem 0;">
            <h3>Add Products to Bill</h3>
            <div class="form-grid" style="grid-template-columns: repeat(4, 1fr);">
                <div class="form-group"> <label>Product Name *</label> <input type="text" id="purchaseProductName"> </div>
                <div class="form-group"> <label>Packaging</label> <select id="purchasePackaging"></select> </div>
                <div class="form-group"> <label>HSN *</label> <input type="text" id="purchaseHSN"> </div>
                <div class="form-group"> <label>Batch *</label> <input type="text" id="purchaseBatch"> </div>
                <div class="form-group"> <label>Quantity *</label> <input type="number" id="purchaseQty" step="0.01"> </div>
                <div class="form-group"> <label>Free Qty</label> <input type="number" id="purchaseFreeQty" value="0" step="0.01"> </div>
                <div class="form-group"> <label>Expiry *</label> <input type="month" id="purchaseExpiry"> </div>
                <div class="form-group"> <label>MRP *</label> <input type="number" id="purchaseMRP" step="0.01"> </div>
                <div class="form-group"> <label>Purchase Rate *</label> <input type="number" id="purchaseRate" step="0.01"> </div>
                <div class="form-group"> <label>Purchase GST % *</label> <input type="number" id="purchaseGstPercent" value="12" step="0.01"> </div>
                <div class="form-group"> <label>Discount %</label> <input type="number" id="purchaseDiscount" value="0" step="0.01"> </div>
                <div class="form-group"> <label>Sale Rate (Incl. Tax) *</label> <input type="number" id="purchaseSaleRateIncl" step="0.01" oninput="calculatePurchaseSaleExclusiveRate()"> </div>
                 <div class="form-group"> <label>Sale GST % *</label> <input type="number" id="purchaseSaleGstPercent" min="0" value="12" step="0.01" oninput="calculatePurchaseSaleExclusiveRate()"> </div>
                <div class="form-group"> <label>Sale Rate (Excl. Tax)</label> <input type="number" id="purchaseSaleRateExcl" step="0.01" readonly> </div>
            </div>
            <button class="btn btn-info" onclick="addProductToPurchaseBill()" style="margin-top: 1rem;">‚ûï Add Product</button>
            <div class="bill-section">
                <h3>Purchase Items</h3>
                <table id="purchaseItemsTable">
                    <thead>
                        <tr>
                            <th>Product</th> <th>Batch</th> <th>Qty</th> <th>Free</th> <th>Rate</th> <th>Disc %</th> <th>Disc Amt</th>
                            <th>Taxable</th> <th>GST %</th> <th>GST Amt</th> <th>Total</th> <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="purchaseItemsBody"></tbody>
                </table>
                <div class="total-section">
                    <div class="total-row"> <span>Total (Pre-Tax):</span> <span id="purchaseTotalPreTax">‚Çπ0.00</span> </div>
                    <div class="total-row"> <label for="purchaseOverallDiscountPercent">Overall Discount (%):</label> <input type="number" id="purchaseOverallDiscountPercent" value="0" oninput="calculatePurchaseTotal()" style="width: 100px;"> </div>
                    <div class="total-row"> <span>Discount Amount:</span> <span id="purchaseOverallDiscountAmount">‚Çπ0.00</span> </div>
                    <div class="total-row"> <span>Taxable Amount:</span> <span id="purchaseTaxableAmount">‚Çπ0.00</span> </div>
                    <div class="total-row"> <span>Total GST:</span> <span id="purchaseTotalGstAmount">‚Çπ0.00</span> </div>
                    <div class="total-row"> <span>Rounding:</span> <span id="purchaseRoundingAmount">‚Çπ0.00</span> </div>
                    <div class="total-row"> <strong>Grand Total:</strong> <strong id="purchaseGrandTotal">‚Çπ0.00</strong> </div>
                </div>
            </div>
            <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                <button class="btn btn-success" onclick="savePurchaseBill()">üíæ Save Purchase Bill</button>
                <button class="btn btn-danger" onclick="closeModal('addPurchaseModal')">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="viewPurchaseModal" class="modal no-print">
        <div class="modal-content"><h2 >Purchase Bill Details</h2><div id="viewPurchaseContent"></div><div style="margin-top: 2rem;"><button class="btn btn-danger" onclick="closeModal('viewPurchaseModal')">Close</button></div></div>
    </div>

    <div id="invoiceModal" class="modal">
        <div class="modal-content" style="min-width: 800px;">
            <div class="invoice-container" id="invoiceContent"></div>
            <div style="margin-top: 2rem; display: flex; gap: 1rem;" class="no-print">
                <button class="btn btn-primary" onclick="printInvoice()">üñ®Ô∏è Print Invoice</button>
                <button class="btn btn-danger" onclick="closeModal('invoiceModal')">Close</button>
            </div>
        </div>
    </div>

    <div id="editBillModal" class="modal no-print">
        <div class="modal-content" style="min-width: 800px;"><h2 >Edit Bill</h2><div id="editBillContent"></div><div style="margin-top: 2rem; display: flex; gap: 1rem;"><button class="btn btn-success" onclick="saveEditedBill()">üíæ Save Changes</button><button class="btn btn-danger" onclick="closeModal('editBillModal')">Cancel</button></div></div>
    </div>

    <div id="editCustomerModal" class="modal no-print">
        <div class="modal-content">
            <h2>Edit Customer</h2>
            <input type="hidden" id="editCustomerId">
            <div class="form-grid">
                <div class="form-group"> <label>Customer Name *</label> <input type="text" id="editCustomerName"> </div>
                <div class="form-group"> <label>Mobile Number *</label> <input type="tel" id="editCustomerMobile" maxlength="10"> </div>
                <div class="form-group"> <label>Doctor Name</label> <input type="text" id="editCustomerDoctorName"> </div>
            </div>
            <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                <button class="btn btn-success" onclick="updateCustomer()">Update Customer</button>
                <button class="btn btn-danger" onclick="closeModal('editCustomerModal')">Cancel</button>
            </div>
        </div>
    </div>
    
    <script>
        // JAVASCRIPT LOGIC IS UNCHANGED
        window.addEventListener('beforeunload', function() { navigator.sendBeacon('/api/logout-beacon', new Blob()); });
        let inventory = []; let billItems = []; let purchaseBillItems = []; let transactions = []; let settings = {};
        const packagingTypes = ["", "STRIP", "BOTTLE", "PACK", "JAR", "TABLET", "CAPSULES", "BOX", "TUBE", "PIECE", "VIAL", "INJ", "SACHET", "SPRAY BOTTLE", "CAN", "UNIT", "AMPUL", "DROP", "PACKET", "POUCH", "INSURANCE", "RESPULE", "AMPOULE", "GLOVES", "INSULIN", "VIAL & SMALL BOTTLE", "SYRINGE", "TIN", "CONTAINER", "SUPPOSITRIES", "ML", "INJECTION" ];
        const API_BASE_URL = '/api';
        document.addEventListener('DOMContentLoaded', async function() { populatePackagingDropdowns(); await fetchSettings(); await fetchInventory(); await fetchDashboardData(); setTodayDate(); await setSaleBillDate(); });
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            if (tabName === 'dashboard') { fetchDashboardData(); } else if (tabName === 'inventory') { fetchInventory(); } else if (tabName === 'customers') { fetchCustomers(); } else if (tabName === 'reports') { setTodayDate(); document.getElementById('reportContent').innerHTML = ''; } else if (tabName === 'oldBills') { fetchBills(); } else if (tabName === 'purchases') { fetchPurchaseBills(); }
        }
        async function logout() { if (confirm('Are you sure you want to log out?')) { try { const response = await fetch('/api/logout', { method: 'POST' }); if (response.ok) { window.location.href = '/'; } else { showAlert('Logout failed. Please try again.', 'danger'); } } catch (error) { showAlert('An error occurred during logout.', 'danger'); } } }
        function populatePackagingDropdowns() {
            const productPackagingSelect = document.getElementById('productPackaging'); const purchasePackagingSelect = document.getElementById('purchasePackaging');
            productPackagingSelect.innerHTML = ''; purchasePackagingSelect.innerHTML = '';
            const purchaseDefaultOption = new Option("", ""); purchaseDefaultOption.textContent = "Select Packaging"; purchasePackagingSelect.add(purchaseDefaultOption);
            packagingTypes.forEach(type => { const option1 = new Option(type, type); const option2 = new Option(type, type); productPackagingSelect.add(option1); if (type !== "") { purchasePackagingSelect.add(option2); } });
            purchasePackagingSelect.value = "";
        }
        async function fetchSettings() { try { const response = await fetch(`${API_BASE_URL}/settings`); settings = await response.json(); loadSettings(); } catch (error) { showAlert('Failed to load settings.', 'danger'); console.error('Error fetching settings:', error); } }
        function loadSettings() {
            if (!settings) return; const shopNameEl = document.getElementById('shopName'); if (shopNameEl && settings.shopName) { shopNameEl.textContent = settings.shopName; }
            const settingsInputs = [ 'settingsShopName', 'settingsGST', 'settingsPhone', 'settingsEmail', 'settingsAddress', 'lowStockThreshold' ];
            settingsInputs.forEach(inputId => { const element = document.getElementById(inputId); const settingKey = inputId.replace('settings', '').toLowerCase(); const key = settingKey === 'gst' ? 'gst' : settingKey === 'lowstockthreshold' ? 'lowStockThreshold' : settingKey; if (element && settings[key]) { element.value = settings[key]; } });
        }
        async function saveSettings() {
            const updatedSettings = { shopName: document.getElementById('settingsShopName').value, gst: document.getElementById('settingsGST').value, phone: document.getElementById('settingsPhone').value, email: document.getElementById('settingsEmail').value, address: document.getElementById('settingsAddress').value, lowStockThreshold: parseFloat(document.getElementById('lowStockThreshold').value) };
            try { const response = await fetch(`${API_BASE_URL}/settings`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ settings: updatedSettings }) }); const result = await response.json(); if (response.ok) { settings = updatedSettings; loadSettings(); showAlert(result.message, 'success'); } else { showAlert(result.error, 'danger'); } } catch (error) { showAlert('Failed to save settings.', 'danger'); }
        }
        async function fetchInventory() { try { const response = await fetch(`${API_BASE_URL}/products`); if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error || 'Failed to fetch inventory'); } inventory = await response.json(); updateInventoryTable(inventory); if (document.getElementById('dashboard').classList.contains('active')) { await fetchDashboardData(); } } catch (error) { inventory = []; updateInventoryTable(inventory); showAlert('Failed to load inventory: ' + error.message, 'danger'); } }
        function showAddProductModal() { clearProductForm(); document.getElementById('productModalTitle').textContent = 'Add New Product (Manual)'; document.getElementById('productModalSaveBtn').textContent = 'Add Product'; document.getElementById('editProductId').value = ''; document.getElementById('addProductModal').classList.add('active'); }
        function closeModal(modalId) { const modal = document.getElementById(modalId); if (modal) { modal.classList.remove('active'); } }
        function calculateModalSaleExclusiveRate() { const inclusiveRateEl = document.getElementById('productSaleRateInclusive'); const exclusiveRateEl = document.getElementById('productSaleRate'); const cgst = parseFloat(document.getElementById('productCGST').value) || 0; const sgst = parseFloat(document.getElementById('productSGST').value) || 0; const totalGstPercent = cgst + sgst; const inclusiveRate = parseFloat(inclusiveRateEl.value); if (!isNaN(inclusiveRate) && inclusiveRate > 0) { const exclusiveRate = inclusiveRate / (1 + (totalGstPercent / 100)); exclusiveRateEl.value = exclusiveRate.toFixed(2); } else { exclusiveRateEl.value = ''; } }
        async function saveProduct() {
            const productId = document.getElementById('editProductId').value; const isEditing = !!productId;
            const product = { name: document.getElementById('productName').value, packaging: document.getElementById('productPackaging').value, hsn: document.getElementById('productHSN').value, batch: document.getElementById('productBatch').value, quantity: parseFloat(document.getElementById('productQuantity').value), mrp: parseFloat(document.getElementById('productMRP').value), purchase_rate: parseFloat(document.getElementById('productPurchaseRate').value), saleRate: parseFloat(document.getElementById('productSaleRate').value), saleRateInclusive: parseFloat(document.getElementById('productSaleRateInclusive').value), expiry: document.getElementById('productExpiry').value, cgst: parseFloat(document.getElementById('productCGST').value), sgst: parseFloat(document.getElementById('productSGST').value) };
            if (!product.name || !product.hsn || !product.batch || isNaN(product.quantity) || isNaN(product.mrp) || isNaN(product.purchase_rate) || isNaN(product.saleRate) || !product.expiry) { showAlert('Please fill all required fields!', 'danger'); return; }
            const url = isEditing ? `${API_BASE_URL}/products/${productId}` : `${API_BASE_URL}/products`; const method = isEditing ? 'PUT' : 'POST';
            try { const response = await fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(product) }); const result = await response.json(); if (response.ok) { showAlert(result.message, 'success'); await fetchInventory(); await fetchDashboardData(); closeModal('addProductModal'); } else { showAlert(result.error, 'danger'); } } catch (error) { showAlert(`Failed to ${isEditing ? 'update' : 'add'} product.`, 'danger'); }
        }
        function clearProductForm() { document.getElementById('productName').value = ''; document.getElementById('productPackaging').value = packagingTypes[0]; document.getElementById('productHSN').value = ''; document.getElementById('productBatch').value = ''; document.getElementById('productQuantity').value = ''; document.getElementById('productMRP').value = ''; document.getElementById('productPurchaseRate').value = ''; document.getElementById('productSaleRateInclusive').value = ''; document.getElementById('productSaleRate').value = ''; document.getElementById('productExpiry').value = ''; document.getElementById('productCGST').value = '6'; document.getElementById('productSGST').value = '6'; }
        function updateInventoryTable(data) {
            const tableBody = document.getElementById('inventoryBody'); if (!tableBody) return; tableBody.innerHTML = '';
            if (!data || data.length === 0) { tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center;">No products in inventory</td></tr>'; return; }
            const today = new Date();
            data.forEach(product => {
                const row = document.createElement('tr'); let rowClass = '';
                if (product.expiry) { const expiryDate = new Date(`${product.expiry}-01`); if (expiryDate < today) rowClass = 'expired-item'; }
                if (product.quantity <= (settings.lowStockThreshold || 10)) { rowClass += ' low-stock'; }
                row.className = rowClass.trim();
                row.innerHTML = `<td>${product.name || 'N/A'}</td> <td>${product.packaging || 'N/A'}</td> <td>${product.hsn || 'N/A'}</td> <td>${product.batch || 'N/A'}</td> <td>${parseFloat(product.quantity || 0).toFixed(2)}</td> <td>‚Çπ${parseFloat(product.mrp || 0).toFixed(2)}</td> <td>‚Çπ${parseFloat(product.purchase_rate || 0).toFixed(2)}</td> <td>‚Çπ${parseFloat(product.sale_rate_inclusive || 0).toFixed(2)}</td> <td>${product.expiry || 'N/A'}</td> <td><button class="btn btn-warning btn-sm" style="margin-right: 5px;" onclick="editProduct(${product.id})">‚úèÔ∏è</button> <button class="btn btn-danger btn-sm" onclick="deleteProduct(${product.id})">‚ùå</button></td>`;
                tableBody.appendChild(row);
            });
        }
        async function searchInventory() { const query = document.getElementById('inventorySearch').value.toLowerCase(); const filtered = inventory.filter(p => p.name.toLowerCase().includes(query) || p.batch.toLowerCase().includes(query) || p.hsn.toLowerCase().includes(query) ); updateInventoryTable(filtered); }
        function applyExpiryFilter(filterType, element) { document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active')); element.classList.add('active'); filterExpiring(filterType); }
        function filterExpiring(filterType) {
            if (filterType === 'none') { updateInventoryTable(inventory); return; }
            const today = new Date(); today.setHours(0, 0, 0, 0); let filteredProducts = [];
            if (filterType === 'expired') { filteredProducts = inventory.filter(p => p.expiry && new Date(`${p.expiry}-01`) < today); } else { const months = { 'thisMonth': 1, 'next2months': 2, 'next3months': 3 }[filterType]; const futureDate = new Date(today); futureDate.setMonth(futureDate.getMonth() + months); filteredProducts = inventory.filter(p => { if (!p.expiry) return false; const expiryDate = new Date(`${p.expiry}-01`); return expiryDate >= today && expiryDate < futureDate; }); }
            updateInventoryTable(filteredProducts); showAlert(`Showing products based on expiry filter.`, 'info');
        }
        async function deleteProduct(id) { if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) { try { const response = await fetch(`${API_BASE_URL}/products/${id}`, { method: 'DELETE' }); const result = await response.json(); if (response.ok) { showAlert(result.message, 'success'); await fetchInventory(); await fetchDashboardData(); } else { showAlert(result.error, 'danger'); } } catch (error) { showAlert('Failed to delete product.', 'danger'); } } }
        async function editProduct(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/products/${id}`); if (!response.ok) throw new Error('Product not found'); const product = await response.json();
                document.getElementById('productModalTitle').textContent = `Edit Product: ${product.name}`; document.getElementById('productModalSaveBtn').textContent = 'Save Changes'; document.getElementById('editProductId').value = product.id; document.getElementById('productName').value = product.name; document.getElementById('productPackaging').value = product.packaging; document.getElementById('productHSN').value = product.hsn; document.getElementById('productBatch').value = product.batch; document.getElementById('productQuantity').value = product.quantity; document.getElementById('productMRP').value = product.mrp; document.getElementById('productPurchaseRate').value = product.purchase_rate; document.getElementById('productSaleRateInclusive').value = product.sale_rate_inclusive; document.getElementById('productExpiry').value = product.expiry; document.getElementById('productCGST').value = product.cgst; document.getElementById('productSGST').value = product.sgst;
                calculateModalSaleExclusiveRate(); document.getElementById('addProductModal').classList.add('active');
            } catch (error) { showAlert('Failed to fetch product details for editing.', 'danger'); console.error('Edit Product Error:', error); }
        }
        async function checkLowStock() { const lowStock = inventory.filter(p => p.quantity <= (settings.lowStockThreshold || 10)); updateInventoryTable(lowStock); showAlert(`Showing ${lowStock.length} products with low stock (<= ${settings.lowStockThreshold}). Click 'Show All' to clear filter.`, 'warning'); }
        async function searchProducts() {
            const query = document.getElementById('billProductSearch').value.toLowerCase().trim(); const dropdown = document.getElementById('billProductDropdown'); dropdown.innerHTML = ''; if (query.length < 1) { dropdown.style.display = 'none'; return; }
            const filteredProducts = inventory.filter(p => p.quantity > 0 && ( p.name.toLowerCase().includes(query) || p.batch.toLowerCase().includes(query) ) ).slice(0, 50);
            if (filteredProducts.length > 0) { filteredProducts.forEach(product => { const item = document.createElement('div'); item.textContent = `${product.name} - Batch: ${product.batch} (Qty: ${product.quantity})`; item.onclick = () => selectProduct(product); dropdown.appendChild(item); }); dropdown.style.display = 'block'; } else { dropdown.innerHTML = '<div>No products found</div>'; dropdown.style.display = 'block'; }
        }
        function showProductDropdown() { document.getElementById('billProductDropdown').style.display = 'block'; }
        document.addEventListener('click', (event) => { if (!event.target.closest('.select-wrapper')) { document.getElementById('billProductDropdown').style.display = 'none'; document.getElementById('patientNameDropdown').style.display = 'none'; document.getElementById('patientMobileDropdown').style.display = 'none'; } });
        function selectProduct(product) { document.getElementById('billProductSearch').value = `${product.name} - ${product.batch}`; document.getElementById('billProductId').value = product.id; document.getElementById('billBatch').value = product.batch; document.getElementById('billExpiry').value = product.expiry; document.getElementById('availableQty').value = product.quantity; document.getElementById('billMRP').value = Number(product.mrp).toFixed(2); document.getElementById('billRate').value = Number(product.sale_rate).toFixed(2); document.getElementById('billProductDropdown').style.display = 'none'; document.getElementById('billQty').max = product.quantity; document.getElementById('billQty').focus(); }
        function addToBill() {
            const productId = Number(document.getElementById('billProductId').value); const quantity = parseFloat(document.getElementById('billQty').value); const rate = Number(document.getElementById('billRate').value); const discount = Number(document.getElementById('billDiscount').value);
            if (!productId || isNaN(quantity) || quantity <= 0 || rate < 0) { showAlert('Please select a product and enter valid details.', 'danger'); return; }
            const product = inventory.find(p => p.id === productId); if (!product || quantity > product.quantity) { showAlert(`Not enough stock. Only ${product ? product.quantity : 0} available.`, 'danger'); return; }
            const existing = billItems.find(item => item.id === productId); if (existing) { existing.quantity += quantity; } else { billItems.push({ ...product, quantity, rate, discount }); }
            updateBillTable(); calculateTotals(); clearProductInputs(); showAlert('Product added to bill!', 'success');
        }
        function updateBillTable() {
            const tableBody = document.getElementById('billItemsBody'); tableBody.innerHTML = ''; if (billItems.length === 0) { tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center;">No items added</td></tr>'; return; }
            billItems.forEach((item, index) => {
                const amount = (item.rate * item.quantity) * (1 - (item.discount / 100)); const totalGST = amount * ((Number(item.cgst) + Number(item.sgst)) / 100); const row = document.createElement('tr');
                row.innerHTML = `<td>${item.name}</td> <td>${item.batch}</td> <td>${item.expiry}</td> <td>‚Çπ${Number(item.mrp).toFixed(2)}</td> <td>‚Çπ${Number(item.rate).toFixed(2)}</td> <td>${parseFloat(item.quantity).toFixed(2)}</td> <td>${item.discount}%</td> <td>${(Number(item.cgst) + Number(item.sgst))}%</td> <td>‚Çπ${(amount + totalGST).toFixed(2)}</td> <td><button class="btn btn-danger btn-sm" onclick="removeFromBill(${index})">üóëÔ∏è</button></td>`;
                tableBody.appendChild(row);
            });
        }
        function clearProductInputs() { document.getElementById('billProductSearch').value = ''; document.getElementById('billProductId').value = ''; document.getElementById('billQty').value = ''; document.getElementById('billDiscount').value = '0'; document.getElementById('billBatch').value = ''; document.getElementById('billExpiry').value = ''; document.getElementById('availableQty').value = ''; document.getElementById('billMRP').value = ''; document.getElementById('billRate').value = ''; }
        function removeFromBill(index) { billItems.splice(index, 1); updateBillTable(); calculateTotals(); }
        function calculateTotals() {
            let subtotal = 0, totalDiscount = 0, totalCGST = 0, totalSGST = 0; const overallDiscountPercent = parseFloat(document.getElementById('overallDiscountPercent').value) || 0;
            billItems.forEach(item => {
                const itemSubtotal = item.rate * item.quantity; const itemDiscountAmount = itemSubtotal * (item.discount / 100); const taxableAfterItemDisc = itemSubtotal - itemDiscountAmount;
                const overallDiscountAmount = taxableAfterItemDisc * (overallDiscountPercent / 100); const finalTaxable = taxableAfterItemDisc - overallDiscountAmount;
                subtotal += itemSubtotal; totalDiscount += itemDiscountAmount + overallDiscountAmount; totalCGST += finalTaxable * (Number(item.cgst) / 100); totalSGST += finalTaxable * (Number(item.sgst) / 100);
            });
            const grandTotal = subtotal - totalDiscount + totalCGST + totalSGST; const rounded = Math.round(grandTotal); const rounding = rounded - grandTotal;
            document.getElementById('subtotal').textContent = `‚Çπ${subtotal.toFixed(2)}`; document.getElementById('totalDiscount').textContent = `‚Çπ${totalDiscount.toFixed(2)}`; document.getElementById('totalCGST').textContent = `‚Çπ${totalCGST.toFixed(2)}`; document.getElementById('totalSGST').textContent = `‚Çπ${totalSGST.toFixed(2)}`;
            let roundingRow = document.getElementById('roundingRow'); if (!roundingRow) { roundingRow = document.createElement('div'); roundingRow.className = 'total-row'; roundingRow.id = 'roundingRow'; const gtRow = document.getElementById('grandTotal').parentNode; gtRow.parentNode.insertBefore(roundingRow, gtRow); }
            roundingRow.innerHTML = `<span>Rounding:</span><span>‚Çπ${rounding.toFixed(2)}</span>`; document.getElementById('grandTotal').textContent = `‚Çπ${rounded.toFixed(2)}`;
        }
        async function generateBill() {
            if (!document.getElementById('patientName').value || !document.getElementById('patientMobile').value || billItems.length === 0) { showAlert('Patient details and at least one item are required.', 'danger'); return; }
            const bill = { patientName: document.getElementById('patientName').value, patientMobile: document.getElementById('patientMobile').value, doctorName: document.getElementById('doctorName').value, items: billItems.map(item => ({ ...item, product_id: item.id })), billDate: document.getElementById('saleBillDate').value, overallDiscountPercent: document.getElementById('overallDiscountPercent').value, };
            try {
                const response = await fetch(`${API_BASE_URL}/bills`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(bill) }); const result = await response.json();
                if (response.ok) { showAlert('Bill generated successfully!', 'success'); bill.items.forEach(billedItem => { const inventoryItem = inventory.find(invItem => invItem.id === billedItem.product_id); if (inventoryItem) { inventoryItem.quantity -= billedItem.quantity; } }); const savedBill = await fetch(`${API_BASE_URL}/bills/${result.id}`).then(res => res.json()); displayInvoice(savedBill); await fetchInventory(); await fetchDashboardData(); clearBill(); } else { showAlert(result.error, 'danger'); }
            } catch (error) { showAlert('Failed to generate bill.', 'danger'); }
        }
        function displayInvoice(bill) {
            const itemsHtml = bill.items.map(item => { const taxable = (item.rate * item.quantity) * (1 - (item.discount / 100)); const gst = taxable * ((Number(item.cgst) + Number(item.sgst)) / 100); return `<tr> <td>${item.product_name}</td> <td>${item.batch}</td> <td>${item.expiry}</td> <td>‚Çπ${Number(item.mrp).toFixed(2)}</td> <td>${parseFloat(item.quantity).toFixed(2)}</td> <td>‚Çπ${Number(item.rate).toFixed(2)}</td> <td>${item.discount}%</td> <td>${(Number(item.cgst) + Number(item.sgst))}%</td> <td>‚Çπ${(taxable + gst).toFixed(2)}</td> </tr>`; }).join('');
            const rounded = Math.round(Number(bill.grand_total)); const rounding = rounded - Number(bill.grand_total);
            const discountPercentHtml = bill.overall_discount_percent > 0 ? `<div class="total-row"><span>Overall Discount %:</span><span>${bill.overall_discount_percent}%</span></div>` : '';
            document.getElementById('invoiceContent').innerHTML = `<div class="bill-header"> <h2>Invoice</h2> <h1>${settings.shopName}</h1> <p>GST: ${settings.gst} | Ph: ${settings.phone}</p> <p>${settings.address}</p> </div> <div class="bill-details" style="display: flex; justify-content: space-between;"> <div><strong>Bill No:</strong> ${bill.bill_number}</div> <div><strong>Date:</strong> ${formatDateForDisplay(bill.bill_date)}</div> </div> <div class="bill-details" style="display: flex; justify-content: space-between;"> <div><strong>Patient Name:</strong> ${bill.patient_name}</div> <div><strong>Mobile:</strong> ${bill.patient_mobile}</div> </div> ${bill.doctor_name ? `<div><strong>Doctor Name:</strong> ${bill.doctor_name}</div>` : ''} <table style="margin-top: 20px;"> <thead> <tr> <th>Product</th> <th>Batch</th> <th>Exp</th> <th>MRP</th> <th>Qty</th> <th>Rate</th> <th>Disc %</th> <th>GST</th> <th>Amount</th> </tr> </thead> <tbody> ${itemsHtml} </tbody> </table> <div class="total-section"> <div class="total-row"><span>Subtotal:</span><span>‚Çπ${Number(bill.subtotal).toFixed(2)}</span></div> ${discountPercentHtml} <div class="total-row"><span>Total Discount:</span><span>‚Çπ${Number(bill.total_discount).toFixed(2)}</span></div> <div class="total-row"><span>CGST:</span><span>‚Çπ${Number(bill.total_cgst).toFixed(2)}</span></div> <div class="total-row"><span>SGST:</span><span>‚Çπ${Number(bill.total_sgst).toFixed(2)}</span></div> <div class="total-row"><span>Rounding:</span><span>‚Çπ${rounding.toFixed(2)}</span></div> <div class="total-row"><span>Grand Total:</span><span>‚Çπ${rounded.toFixed(2)}</span></div> </div>`;
            document.getElementById('invoiceModal').classList.add('active');
        }
        function printInvoice() { const printWindow = window.open('', '', 'height=600,width=800'); printWindow.document.write('<html><head><title>Invoice</title>'); printWindow.document.write('<style> body { font-family: sans-serif; } table { width: 100%; border-collapse: collapse; } th, td { padding: 8px; border: 1px solid #ddd; } .total-section { margin-top: 20px; } .total-row { display: flex; justify-content: space-between; padding: 5px 0; } </style>'); printWindow.document.write('</head><body>'); printWindow.document.write(document.getElementById('invoiceContent').innerHTML); printWindow.document.write('</body></html>'); printWindow.document.close(); setTimeout(() => { printWindow.print(); printWindow.close(); }, 250); }
        function clearBill() { billItems = []; document.getElementById('patientName').value = ''; document.getElementById('patientMobile').value = ''; document.getElementById('doctorName').value = ''; document.getElementById('overallDiscountPercent').value = 0; clearProductInputs(); updateBillTable(); calculateTotals(); setSaleBillDate(); }
        async function fetchDashboardData() { try { const response = await fetch(`${API_BASE_URL}/dashboard-stats`); if (!response.ok) { throw new Error('Failed to fetch dashboard stats'); } const data = await response.json(); document.getElementById('todaySales').textContent = `‚Çπ${Number(data.todaySales).toFixed(2)}`; document.getElementById('todayBillsCount').textContent = data.todayBillsCount; document.getElementById('totalItems').textContent = data.totalItems; document.getElementById('lowStockCount').textContent = data.lowStockCount; document.getElementById('expiringCount').textContent = data.expiringCount; updateRecentTransactions(data.recentTransactions); } catch (error) { console.error('Error fetching dashboard data:', error); showAlert('Failed to load dashboard data.', 'danger'); } }
        function updateRecentTransactions(bills) {
            const body = document.getElementById('recentTransactionsBody'); body.innerHTML = ''; if (!bills || bills.length === 0) { body.innerHTML = '<tr><td colspan="5" style="text-align: center;">No recent transactions</td></tr>'; return; }
            bills.slice(0, 5).forEach(b => { body.innerHTML += `<tr> <td>${b.bill_number}</td> <td>${formatDateForDisplay(b.bill_date)}</td> <td>${b.patient_name}</td> <td>‚Çπ${Number(b.grand_total).toFixed(2)}</td> <td><span style="color: green; font-weight: bold;">Paid</span></td> </tr>`; });
        }
        async function generateReport() {
            const type = document.getElementById('reportType').value; const fromDate = document.getElementById('reportFromDate').value; const toDate = document.getElementById('reportToDate').value; const contentDiv = document.getElementById('reportContent'); contentDiv.innerHTML = '<h3>Generating report...</h3>';
            if(!fromDate || !toDate) { showAlert('Please select a valid date range.', 'danger'); contentDiv.innerHTML = ''; return; }
            try {
                const response = await fetch(`${API_BASE_URL}/reports?type=${type}&fromDate=${fromDate}&toDate=${toDate}`); if (!response.ok) throw new Error(await response.json().then(e => e.error)); const data = await response.json();
                let html = `<h3>${type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())} Report from ${fromDate} to ${toDate}</h3>`;
                if (data.length === 0) { html += `<p>No data found for this period.</p>`; } else { const headers = Object.keys(data[0]); html += `<table class="report-table"><thead><tr>${headers.map(h => `<th>${h.replace(/_/g, ' ').toUpperCase()}</th>`).join('')}</tr></thead><tbody>`; data.forEach(row => { html += `<tr>${headers.map(h => { const val = row[h]; let displayVal = val === null || val === undefined ? '' : val; const isCurrency = typeof val === 'number' && (h.includes('rate') || h.includes('amount') || h.includes('total') || h.includes('mrp') || h.includes('gst') || h.includes('subtotal') || h.includes('value')); if(isCurrency) { displayVal = '‚Çπ' + parseFloat(val).toFixed(2); } else if (h.includes('date')) { displayVal = formatDateForDisplay(val); } return `<td>${displayVal}</td>`; }).join('')}</tr>`; }); html += `</tbody></table>`; }
                contentDiv.innerHTML = html;
            } catch(error) { showAlert(`Error generating report: ${error.message}`, 'danger'); contentDiv.innerHTML = `<p style="color:red;">Could not generate report.</p>`; }
        }
        async function fetchBills() { try { const bills = await fetch(`${API_BASE_URL}/bills`).then(res => res.json()); updateBillsTable(bills); } catch (error) { showAlert(error.message, 'danger'); } }
        function updateBillsTable(bills) {
            const billsBody = document.getElementById('billsBody'); billsBody.innerHTML = '';
            if (!Array.isArray(bills)) { console.error("Error: Expected an array of bills, but received:", bills); billsBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: red;">Could not load bills. Invalid data received.</td></tr>'; return; }
            if (bills.length === 0) { billsBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No bills found</td></tr>'; return; }
            bills.forEach(bill => { const row = document.createElement('tr'); row.innerHTML = `<td>${bill.bill_number}</td> <td>${formatDateForDisplay(bill.bill_date)}</td> <td>${bill.patient_name}</td> <td>‚Çπ${parseFloat(bill.grand_total).toFixed(2)}</td> <td><button class="btn btn-warning btn-sm" onclick="viewBill(${bill.id})">‚úèÔ∏è View/Edit</button> <button class="btn btn-info btn-sm" onclick="printOldBill(${bill.id})" style="margin-left: 5px;">üñ®Ô∏è Print</button></td>`; billsBody.appendChild(row); });
        }
        function removeEditedItem(index) { if (!window.currentEditingBill || !window.currentEditingBill.items) return; window.currentEditingBill.items.splice(index, 1); renderEditBillItems(); }
        function renderEditBillItems() { let itemsHtml = window.currentEditingBill.items.map((item, i) => `<tr> <td>${item.product_name}</td> <td><input type="text" value="${item.batch}" class="edit-batch" data-index="${i}" style="width:100px;"></td> <td><input type="number" value="${parseFloat(item.quantity).toFixed(2)}" class="edit-qty" data-index="${i}" style="width:60px;" oninput="recalculateEditedBillTotals()" step="0.01"></td> <td><input type="number" value="${item.rate}" class="edit-rate" data-index="${i}" step="0.01" style="width:80px;" oninput="recalculateEditedBillTotals()"></td> <td><input type="number" value="${item.discount}" class="edit-discount" data-index="${i}" step="0.01" style="width:70px;" oninput="recalculateEditedBillTotals()"></td> <td><button class="btn btn-danger btn-sm" onclick="removeEditedItem(${i})">Remove</button></td> </tr>`).join(''); document.getElementById('editBillItemsBody').innerHTML = itemsHtml; recalculateEditedBillTotals(); }
        function recalculateEditedBillTotals() {
            const qtyInputs = document.querySelectorAll('.edit-qty'); const rateInputs = document.querySelectorAll('.edit-rate'); const discountInputs = document.querySelectorAll('.edit-discount'); const overallDiscountPercent = parseFloat(document.getElementById('editOverallDiscount').value) || 0;
            let subtotal = 0, totalDiscount = 0, totalCGST = 0, totalSGST = 0;
            window.currentEditingBill.items.forEach((item, i) => { const qty = parseFloat(qtyInputs[i].value); const rate = parseFloat(rateInputs[i].value); const discount = parseFloat(discountInputs[i].value); const itemSubtotal = rate * qty; const itemDiscountAmount = itemSubtotal * (discount / 100); const taxableAfterItemDisc = itemSubtotal - itemDiscountAmount; const overallDiscountAmount = taxableAfterItemDisc * (overallDiscountPercent / 100); const finalTaxable = taxableAfterItemDisc - overallDiscountAmount; subtotal += itemSubtotal; totalDiscount += itemDiscountAmount + overallDiscountAmount; totalCGST += finalTaxable * (Number(item.cgst) / 100); totalSGST += finalTaxable * (Number(item.sgst) / 100); });
            const grandTotal = subtotal - totalDiscount + totalCGST + totalSGST; const rounded = Math.round(grandTotal);
            document.getElementById('editSubtotal').textContent = `‚Çπ${subtotal.toFixed(2)}`; document.getElementById('editDiscount').textContent = `‚Çπ${totalDiscount.toFixed(2)}`; document.getElementById('editCgst').textContent = `‚Çπ${totalCGST.toFixed(2)}`; document.getElementById('editSgst').textContent = `‚Çπ${totalSGST.toFixed(2)}`; document.getElementById('editGrandTotal').textContent = `‚Çπ${rounded.toFixed(2)}`;
        }
        async function viewBill(billId) {
            try {
                const bill = await fetch(`${API_BASE_URL}/bills/${billId}`).then(res => res.json()); window.currentEditingBill = bill;
                document.getElementById('editBillContent').innerHTML = `<div class="form-grid"> <div class="form-group"> <label>Patient Name</label> <input type="text" id="editPatientName" value="${bill.patient_name}"> </div> <div class="form-group"> <label>Patient Mobile</label> <input type="text" id="editPatientMobile" value="${bill.patient_mobile}"> </div> <div class="form-group"> <label>Doctor Name</label> <input type="text" id="editDoctorName" value="${bill.doctor_name || ''}"> </div> <div class="form-group"> <label>Overall Discount %</label> <input type="number" id="editOverallDiscount" value="${bill.overall_discount_percent || 0}" oninput="recalculateEditedBillTotals()"> </div> </div> <p><strong>Bill No:</strong> ${bill.bill_number}</p> <table style="width:100%; margin-top:10px;"> <thead> <tr> <th>Product</th> <th>Batch</th> <th>Qty</th> <th>Rate</th> <th>Discount %</th> <th>Action</th> </tr> </thead> <tbody id="editBillItemsBody"></tbody> </table> <div class="total-section" style="margin-top:10px;"> <div class="total-row"><span>Subtotal:</span><span id="editSubtotal"></span></div> <div class="total-row"><span>Discount:</span><span id="editDiscount"></span></div> <div class="total-row"><span>CGST:</span><span id="editCgst"></span></div> <div class="total-row"><span>SGST:</span><span id="editSgst"></span></div> <div class="total-row"><span>Grand Total:</span><span id="editGrandTotal"></span></div> </div>`;
                renderEditBillItems(); document.getElementById('editBillModal').classList.add('active');
            } catch (error) { showAlert('Failed to fetch bill details.', 'danger'); }
        }
        async function saveEditedBill() {
            if (!window.currentEditingBill) return; const qtyInputs = document.querySelectorAll('.edit-qty'); const rateInputs = document.querySelectorAll('.edit-rate'); const discountInputs = document.querySelectorAll('.edit-discount'); const batchInputs = document.querySelectorAll('.edit-batch');
            const updatedItems = window.currentEditingBill.items.map((item, i) => ({ ...item, batch: batchInputs[i].value, quantity: parseFloat(qtyInputs[i].value), rate: parseFloat(rateInputs[i].value), discount: parseFloat(discountInputs[i].value) }));
            const payload = { ...window.currentEditingBill, patient_name: document.getElementById('editPatientName').value, patient_mobile: document.getElementById('editPatientMobile').value, doctor_name: document.getElementById('editDoctorName').value, overall_discount_percent: document.getElementById('editOverallDiscount').value, items: updatedItems };
            try { const response = await fetch(`${API_BASE_URL}/bills/${payload.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); const result = await response.json(); if (response.ok) { showAlert('Bill updated successfully!', 'success'); closeModal('editBillModal'); await fetchBills(); await fetchInventory(); } else { showAlert(result.error, 'danger'); } } catch (error) { showAlert('Failed to update bill.', 'danger'); }
        }
        async function printOldBill(billId) { try { const bill = await fetch(`${API_BASE_URL}/bills/${billId}`).then(res => res.json()); displayInvoice(bill); } catch(error) { showAlert('Could not fetch bill for printing.', 'danger'); } }
        async function fetchPurchaseBills() { try { const purchaseBills = await fetch(`${API_BASE_URL}/purchases`).then(res => res.json()); updatePurchaseBillsTable(purchaseBills); } catch (error) { showAlert(error.message, 'danger'); } }
        function updatePurchaseBillsTable(bills) {
            const tableBody = document.getElementById('purchaseBillsBody'); tableBody.innerHTML = ''; if (!bills || bills.length === 0) { tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No purchase bills found</td></tr>'; return; }
            bills.forEach(bill => { const row = document.createElement('tr'); row.innerHTML = `<td>${bill.bill_number}</td> <td>${bill.supplier_name}</td> <td>${formatDateForDisplay(bill.bill_date)}</td> <td>${bill.tax_type}</td> <td>‚Çπ${Number(bill.grand_total).toFixed(2)}</td> <td><button class="btn btn-info btn-sm" onclick="viewPurchaseBill(${bill.id})">üëÅÔ∏è View</button></td>`; tableBody.appendChild(row); });
        }
        async function showAddPurchaseModal() {
            purchaseBillItems = []; document.getElementById('addPurchaseModal').classList.add('active'); document.getElementById('purchaseSupplierName').value = ''; document.getElementById('purchaseBillNumber').value = '';
            try { const response = await fetch(`${API_BASE_URL}/current-ist-date`); const data = await response.json(); document.getElementById('purchaseBillDate').value = data.currentDate; } catch (error) { console.error("Could not fetch current date, falling back to local date.", error); document.getElementById('purchaseBillDate').valueAsDate = new Date(); }
            clearPurchaseProductForm(); updatePurchaseItemsTable(); calculatePurchaseTotal();
        }
        function clearPurchaseProductForm() { document.getElementById('purchaseProductName').value = ''; document.getElementById('purchasePackaging').value = ""; document.getElementById('purchaseHSN').value = ''; document.getElementById('purchaseBatch').value = ''; document.getElementById('purchaseQty').value = ''; document.getElementById('purchaseFreeQty').value = '0'; document.getElementById('purchaseMRP').value = ''; document.getElementById('purchaseRate').value = ''; document.getElementById('purchaseGstPercent').value = '12'; document.getElementById('purchaseDiscount').value = '0'; document.getElementById('purchaseSaleRateIncl').value = ''; document.getElementById('purchaseSaleGstPercent').value = '12'; document.getElementById('purchaseSaleRateExcl').value = ''; document.getElementById('purchaseExpiry').value = ''; }
        function calculatePurchaseSaleExclusiveRate(){ const inclRate = parseFloat(document.getElementById('purchaseSaleRateIncl').value) || 0; const saleGst = parseFloat(document.getElementById('purchaseSaleGstPercent').value) || 0; const exclRateEl = document.getElementById('purchaseSaleRateExcl'); if(inclRate > 0 && saleGst >= 0) { exclRateEl.value = (inclRate / (1 + (saleGst/100))).toFixed(2); } else { exclRateEl.value = ''; } }
        function addProductToPurchaseBill() {
            const purchaseTaxType = document.querySelector('input[name="purchaseTaxType"]:checked').value; const purchaseGst = parseFloat(document.getElementById('purchaseGstPercent').value) || 0; const saleGst = parseFloat(document.getElementById('purchaseSaleGstPercent').value) || 0; const selectedPackaging = document.getElementById('purchasePackaging').value;
            const item = { productName: document.getElementById('purchaseProductName').value, packaging: selectedPackaging, hsn: document.getElementById('purchaseHSN').value, batch: document.getElementById('purchaseBatch').value, quantity: parseFloat(document.getElementById('purchaseQty').value), freeQuantity: parseFloat(document.getElementById('purchaseFreeQty').value) || 0, mrp: parseFloat(document.getElementById('purchaseMRP').value), purchaseRate: parseFloat(document.getElementById('purchaseRate').value), discount: parseFloat(document.getElementById('purchaseDiscount').value), expiry: document.getElementById('purchaseExpiry').value, saleRate: parseFloat(document.getElementById('purchaseSaleRateExcl').value), saleRateIncl: parseFloat(document.getElementById('purchaseSaleRateIncl').value), saleCgst: saleGst / 2, saleSgst: saleGst / 2, cgst: purchaseTaxType === 'CSGST' ? purchaseGst / 2 : 0, sgst: purchaseTaxType === 'CSGST' ? purchaseGst / 2 : 0, igst: purchaseTaxType === 'IGST' ? purchaseGst : 0, };
            if (!item.productName || !item.batch || !item.hsn || !item.expiry || !item.packaging || isNaN(item.quantity) || item.quantity <= 0 || isNaN(item.purchaseRate) || isNaN(item.saleRate) || isNaN(item.saleRateIncl) || isNaN(item.mrp)) { showAlert('Please fill all required product fields (*) with valid values.', 'danger'); return; }
            purchaseBillItems.push(item); updatePurchaseItemsTable(); calculatePurchaseTotal(); clearPurchaseProductForm(); document.getElementById('purchaseProductName').focus();
        }
        function updatePurchaseItemsTable() {
            const tableBody = document.getElementById('purchaseItemsBody'); tableBody.innerHTML = ''; if (purchaseBillItems.length === 0) { tableBody.innerHTML = '<tr><td colspan="12" style="text-align: center;">No items added</td></tr>'; return; }
            purchaseBillItems.forEach((item, index) => { const baseAmount = (item.purchaseRate || 0) * (item.quantity || 0); const discountAmount = baseAmount * ((item.discount || 0) / 100); const taxableAmount = baseAmount - discountAmount; const gstPercent = (item.igst > 0 ? item.igst : (item.cgst + item.sgst)); const gstAmount = taxableAmount * (gstPercent / 100); const totalAmount = taxableAmount + gstAmount; const gstText = item.igst > 0 ? `${item.igst}% I` : `${item.cgst + item.sgst}% C/S`; const row = document.createElement('tr'); row.innerHTML = `<td>${item.productName}</td> <td>${item.batch}</td> <td>${parseFloat(item.quantity).toFixed(2)}</td> <td>${parseFloat(item.freeQuantity).toFixed(2)}</td> <td>‚Çπ${Number(item.purchaseRate).toFixed(2)}</td> <td>${item.discount.toFixed(2)}%</td> <td>‚Çπ${discountAmount.toFixed(2)}</td> <td>‚Çπ${taxableAmount.toFixed(2)}</td> <td>${gstText}</td> <td>‚Çπ${gstAmount.toFixed(2)}</td> <td>‚Çπ${totalAmount.toFixed(2)}</td> <td><button class="btn btn-danger btn-sm" onclick="removeProductFromPurchase(${index})">üóëÔ∏è</button></td>`; tableBody.appendChild(row); });
        }
        function removeProductFromPurchase(index) { purchaseBillItems.splice(index, 1); updatePurchaseItemsTable(); calculatePurchaseTotal(); }
        function calculatePurchaseTotal() {
            const overallDiscountPercent = parseFloat(document.getElementById('purchaseOverallDiscountPercent').value) || 0; let totalPreTax = 0; let totalGstAmount = 0;
            purchaseBillItems.forEach(item => { const base = (item.purchaseRate || 0) * (item.quantity || 0); const itemDiscounted = base * (1 - ((item.discount || 0) / 100)); totalPreTax += itemDiscounted; });
            const overallDiscountAmount = totalPreTax * (overallDiscountPercent / 100); const taxableAmount = totalPreTax - overallDiscountAmount;
            purchaseBillItems.forEach(item => { const base = (item.purchaseRate || 0) * (item.quantity || 0); const itemDiscounted = base * (1 - ((item.discount || 0) / 100)); const finalDiscounted = itemDiscounted * (1 - (overallDiscountPercent / 100)); const totalGstPercent = (Number(item.igst) || 0) > 0 ? (Number(item.igst) || 0) : ((Number(item.cgst) || 0) + (Number(item.sgst) || 0)); const itemGstAmount = finalDiscounted * (totalGstPercent / 100); totalGstAmount += itemGstAmount; });
            const totalBeforeRounding = taxableAmount + totalGstAmount; const roundedTotal = Math.round(totalBeforeRounding); const rounding = roundedTotal - totalBeforeRounding;
            document.getElementById('purchaseTotalPreTax').textContent = `‚Çπ${totalPreTax.toFixed(2)}`; document.getElementById('purchaseOverallDiscountAmount').textContent = `‚Çπ${overallDiscountAmount.toFixed(2)}`; document.getElementById('purchaseTaxableAmount').textContent = `‚Çπ${taxableAmount.toFixed(2)}`; document.getElementById('purchaseTotalGstAmount').textContent = `‚Çπ${totalGstAmount.toFixed(2)}`; document.getElementById('purchaseRoundingAmount').textContent = `‚Çπ${rounding.toFixed(2)}`; document.getElementById('purchaseGrandTotal').textContent = `‚Çπ${roundedTotal.toFixed(2)}`;
        }
        async function savePurchaseBill() {
            const purchaseData = { supplierName: document.getElementById('purchaseSupplierName').value, billNumber: document.getElementById('purchaseBillNumber').value, billDate: document.getElementById('purchaseBillDate').value, taxType: document.querySelector('input[name="purchaseTaxType"]:checked').value, items: purchaseBillItems, overallDiscountPercent: document.getElementById('purchaseOverallDiscountPercent').value, };
            if (!purchaseData.supplierName || !purchaseData.billNumber || !purchaseData.billDate || purchaseData.items.length === 0) { showAlert('Please fill supplier details and add at least one product.', 'danger'); return; }
            try { const response = await fetch(`${API_BASE_URL}/purchases`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(purchaseData) }); const result = await response.json(); if (response.ok) { showAlert(result.message, 'success'); closeModal('addPurchaseModal'); await fetchPurchaseBills(); await fetchInventory(); } else { showAlert(result.error, 'danger'); } } catch (error) { showAlert('Failed to save purchase bill.', 'danger'); }
        }
        async function viewPurchaseBill(id) {
            try {
                const bill = await fetch(`${API_BASE_URL}/purchases/${id}`).then(res => res.json());
                const itemsHtml = bill.items.map(item => `<tr> <td>${item.product_name}</td> <td>${item.packaging || ''}</td> <td>${item.batch}</td> <td>${parseFloat(item.quantity).toFixed(2)}</td> <td>${parseFloat(item.free_quantity || 0).toFixed(2)}</td> <td>‚Çπ${Number(item.purchase_rate).toFixed(2)}</td> <td>${item.discount || 0}%</td> <td>${item.igst > 0 ? item.igst + '% (IGST)' : (item.cgst + item.sgst) + '%'}</td> <td>‚Çπ${Number(item.amount).toFixed(2)}</td> </tr>`).join('');
                document.getElementById('viewPurchaseContent').innerHTML = `<p><strong>Supplier:</strong> ${bill.supplier_name}</p> <p><strong>Bill No:</strong> ${bill.bill_number}</p> <p><strong>Date:</strong> ${formatDateForDisplay(bill.bill_date)}</p> <p><strong>Tax Type:</strong> ${bill.tax_type}</p> <h4 style="margin-top:20px;">Items</h4> <table> <thead> <tr> <th>Product</th> <th>Pkg</th> <th>Batch</th> <th>Qty</th> <th>Free</th> <th>Rate</th> <th>Disc</th> <th>GST</th> <th>Amount</th> </tr> </thead> <tbody>${itemsHtml}</tbody> </table> <div class="total-section" style="margin-top:10px;"> <div class="total-row"><span>Total (Pre-Tax):</span><span>‚Çπ${Number(bill.total_pre_tax).toFixed(2)}</span></div> <div class="total-row"><span>Overall Discount:</span><span>‚Çπ${Number(bill.overall_discount_amount).toFixed(2)} (${bill.overall_discount_percent}%)</span></div> <div class="total-row"><span>Taxable Amount:</span><span>‚Çπ${Number(bill.taxable_amount).toFixed(2)}</span></div> <div class="total-row"><span>Total GST:</span><span>‚Çπ${Number(bill.total_gst_amount).toFixed(2)}</span></div> <div class="total-row"><span>Rounding:</span><span>‚Çπ${Number(bill.rounding).toFixed(2)}</span></div> <div class="total-row"><strong><span>Grand Total:</span></strong><strong><span>‚Çπ${Number(bill.grand_total).toFixed(2)}</span></strong></div> </div>`;
                document.getElementById('viewPurchaseModal').classList.add('active');
            } catch (error) { showAlert(error.message, 'danger'); }
        }
        function formatDateForDisplay(dateString) { if (!dateString) return 'N/A'; const date = new Date(dateString); const day = String(date.getDate()).padStart(2, '0'); const month = String(date.getMonth() + 1).padStart(2, '0'); const year = date.getFullYear(); return `${day}/${month}/${year}`; }
        async function setSaleBillDate() { try { const response = await fetch(`${API_BASE_URL}/current-ist-date`); const data = await response.json(); if (document.getElementById('saleBillDate')) { document.getElementById('saleBillDate').value = data.currentDate; } } catch (error) { console.error("Could not fetch current date for sale bill, falling back to local date.", error); if (document.getElementById('saleBillDate')) { const today = new Date().toISOString().split('T')[0]; document.getElementById('saleBillDate').value = today; } } }
        function setTodayDate() { const today = new Date().toISOString().split('T')[0]; document.getElementById('reportFromDate').value = today; document.getElementById('reportToDate').value = today; }
        function showAlert(message, type) { const container = document.getElementById('alert-container'); const alertDiv = document.createElement('div'); alertDiv.className = `alert alert-${type}`; alertDiv.textContent = message; container.appendChild(alertDiv); setTimeout(() => { alertDiv.remove(); }, 5000); }
        async function fetchCustomers() { try { const response = await fetch(`${API_BASE_URL}/customers`); updateCustomersTable(await response.json()); } catch (error) { showAlert('Failed to load customers.', 'danger'); } }
        function updateCustomersTable(data) {
            const tableBody = document.getElementById('customersBody'); tableBody.innerHTML = ''; if (!data || data.length === 0) { tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No customers found</td></tr>'; return; }
            data.forEach(customer => { const row = document.createElement('tr'); row.innerHTML = `<td>${customer.id}</td> <td>${customer.name || 'N/A'}</td> <td>${customer.mobile || 'N/A'}</td> <td>${customer.doctor_name || 'N/A'}</td> <td><button class="btn btn-warning btn-sm" onclick="showEditCustomerModal(${customer.id})">‚úèÔ∏è</button> <button class="btn btn-danger btn-sm" onclick="deleteCustomer(${customer.id})">‚ùå</button></td>`; tableBody.appendChild(row); });
        }
        async function searchCustomers() { const query = document.getElementById('customerSearch').value.toLowerCase(); try { const response = await fetch(`${API_BASE_URL}/customers/search?query=${encodeURIComponent(query)}`); updateCustomersTable(await response.json()); } catch (error) { showAlert('Failed to search customers.', 'danger'); } }
        async function showEditCustomerModal(id) { try { const response = await fetch(`${API_BASE_URL}/customers/${id}`); if (!response.ok) { const err = await response.json(); throw new Error(err.error || 'Customer not found'); } const customer = await response.json(); document.getElementById('editCustomerId').value = customer.id; document.getElementById('editCustomerName').value = customer.name; document.getElementById('editCustomerMobile').value = customer.mobile; document.getElementById('editCustomerDoctorName').value = customer.doctor_name || ''; document.getElementById('editCustomerModal').classList.add('active'); } catch (error) { showAlert(error.message, 'danger'); } }
        async function updateCustomer() { const id = document.getElementById('editCustomerId').value; const customer = { name: document.getElementById('editCustomerName').value, mobile: document.getElementById('editCustomerMobile').value, doctor_name: document.getElementById('editCustomerDoctorName').value }; try { const response = await fetch(`${API_BASE_URL}/customers/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(customer) }); const result = await response.json(); if (response.ok) { showAlert(result.message, 'success'); fetchCustomers(); closeModal('editCustomerModal'); } else { showAlert(result.error, 'danger'); } } catch (error) { showAlert('Failed to update customer.', 'danger'); } }
        async function deleteCustomer(id) { if (confirm('Are you sure you want to delete this customer?')) { try { const response = await fetch(`${API_BASE_URL}/customers/${id}`, { method: 'DELETE' }); const result = await response.json(); if (response.ok) { showAlert(result.message, 'success'); fetchCustomers(); } else { showAlert(result.error, 'danger'); } } catch (error) { showAlert('Failed to delete customer.', 'danger'); } } }
        async function searchCustomer() {
            const nameInput = document.getElementById('patientName'); const mobileInput = document.getElementById('patientMobile'); const nameDropdown = document.getElementById('patientNameDropdown'); const mobileDropdown = document.getElementById('patientMobileDropdown');
            let query = ''; let activeDropdown;
            if (document.activeElement === mobileInput) { nameDropdown.style.display = 'none'; nameDropdown.innerHTML = ''; } else { mobileDropdown.style.display = 'none'; mobileDropdown.innerHTML = ''; }
            if (document.activeElement === mobileInput) { query = mobileInput.value.trim(); activeDropdown = mobileDropdown; } else if (document.activeElement === nameInput) { query = nameInput.value.trim(); activeDropdown = nameDropdown; } else { nameDropdown.style.display = 'none'; mobileDropdown.style.display = 'none'; return; }
            activeDropdown.innerHTML = ''; if (query.length < 2) { activeDropdown.style.display = 'none'; return; }
            try { const response = await fetch(`${API_BASE_URL}/customers/search?query=${encodeURIComponent(query)}`); const customers = await response.json(); if (customers.length > 0) { customers.forEach(customer => { const item = document.createElement('div'); item.textContent = `${customer.name} - ${customer.mobile}`; item.onclick = () => selectCustomer(customer); activeDropdown.appendChild(item); }); activeDropdown.style.display = 'block'; } else { activeDropdown.style.display = 'none'; } } catch (error) { console.error('Error searching customers:', error); }
        }
        function selectCustomer(customer) { document.getElementById('patientName').value = customer.name; document.getElementById('patientMobile').value = customer.mobile; document.getElementById('doctorName').value = customer.doctor_name || ''; document.getElementById('patientNameDropdown').style.display = 'none'; document.getElementById('patientMobileDropdown').style.display = 'none'; }
    </script>
</body>
</html>

