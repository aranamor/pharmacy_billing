<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmacy Billing System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .shop-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-direction: column; /* Changed for logo on top */
        }

        .logo-container {
            width: 300px; /* Adjust size as needed */
            height: auto; /* Adjust height automatically */
            margin-bottom: 5px; /* Space between logo and text */
        }
        
        .logo-container img {
            max-width: 100%;
            height: auto;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #dee2e6;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
            margin-bottom: -3px;
        }

        .content {
            padding: 30px;
            min-height: 500px;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .form-grid-col-3 {
             grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .tax-toggle-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            background-color: #f0f2f5;
            padding: 10px;
            border-radius: 8px;
        }

        .tax-toggle-group label {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f93b1d 0%, #ea5455 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(249, 59, 29, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }

        .btn-info {
            background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);
            color: white;
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 210, 255, 0.4);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .inventory-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .bill-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .bill-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #dee2e6;
        }

        .bill-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .total-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 2px solid #667eea;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .total-row:last-child {
            border-bottom: none;
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
        }

        .invoice-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .stat-card h3 {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #495057;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 9999;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: slideIn 0.3s, fadeOut 0.5s 4.5s forwards;
            max-width: 400px;
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .search-box {
            position: relative;
            max-width: 400px;
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 40px 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 25px;
            font-size: 14px;
        }

        .search-box::after {
            content: "🔍";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
        }

        @media print {
            body { background: white; }
            .no-print { display: none !important; }
            .invoice-container { box-shadow: none; }
        }

        .expired-item {
            background: #ffebee !important;
        }

        .low-stock {
            background: #fff3e0 !important;
        }

        /* Styles for new expiry filter buttons */
        .filter-btn-group {
            display: flex;
            gap: 10px;
            background: #f0f2f5;
            padding: 5px;
            border-radius: 25px;
        }
        .filter-btn {
            background: none;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
        }
        .filter-btn:hover {
            background: #e2e6ea;
        }
        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.4);
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 1.5em; }
            .tabs { overflow-x: scroll; }
            .form-grid { grid-template-columns: 1fr; }
            .filter-btn-group {
                flex-wrap: wrap;
            }
        }

        /* Styles for the searchable select dropdown */
        .select-wrapper {
            position: relative;
        }
        .select-wrapper input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .select-wrapper .dropdown-list {
            display: none;
            position: absolute;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            background-color: white;
            z-index: 100;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .select-wrapper .dropdown-list div {
            padding: 10px 15px;
            cursor: pointer;
        }
        .select-wrapper .dropdown-list div:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <div id="alert-container"></div>
    <div class="container">
        <div class="header">
            <div class="shop-info">
                <div class="logo-container">
                    <img src="logo2.png" alt="Shop Logo">
                </div>
                <div>
                    <h1 id="shopName"></h1>
                    <p>Wahi Kaam Sahi Daam | GST: 16GLDPD3626M1Z0</p>
                    <p>D.L No. RLF20TR2025000281 | RLF21TR2025000273</p>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">📊 Dashboard</button>
            <button class="tab" onclick="switchTab('billing')">💰 Billing</button>
            <button class="tab" onclick="switchTab('inventory')">📦 Inventory</button>
            <button class="tab" onclick="switchTab('purchases')">🛒 Purchases</button>
            <button class="tab" onclick="switchTab('customers')">👥 Customers</button>
            <button class="tab" onclick="switchTab('reports')">📈 Reports</button>
            <button class="tab" onclick="switchTab('settings')">⚙️ Settings</button>
            <button class="tab" onclick="switchTab('oldBills')">📜 Bills</button>
        </div>

        <div class="content">
            <div id="dashboard" class="tab-content active">
                <h2>Dashboard Overview</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Today's Sales</h3>
                        <div class="value" id="todaySales">₹0.00</div>
                    </div>
                    <div class="stat-card">
                        <h3>Today's Bills</h3>
                        <div class="value" id="todayBillsCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Inventory Items</h3>
                        <div class="value" id="totalItems">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Low Stock Alerts</h3>
                        <div class="value" id="lowStockCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Expiring Soon</h3>
                        <div class="value" id="expiringCount">0</div>
                    </div>
                </div>

                <h3 style="margin-top: 30px;">Recent Transactions</h3>
                <table id="recentTransactions">
                    <thead>
                        <tr>
                            <th>Bill No</th>
                            <th>Date</th>
                            <th>Patient</th>
                            <th>Amount</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="recentTransactionsBody">
                        <tr><td colspan="5" style="text-align: center;">No recent transactions</td></tr>
                    </tbody>
                </table>
            </div>

            <div id="billing" class="tab-content">
                <h2>New Bill</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Patient Name *</label>
                        <input type="text" id="patientName" placeholder="Enter patient name" oninput="searchCustomer()">
                        <div class="dropdown-list" id="patientNameDropdown"></div>
                    </div>
                    <div class="form-group">
                        <label>Patient Mobile *</label>
                        <input type="tel" id="patientMobile" placeholder="10-digit mobile number" maxlength="10" oninput="searchCustomer()">
                    </div>
                    <div class="form-group">
                        <label>Doctor Name</label>
                        <input type="text" id="doctorName" placeholder="Prescribing doctor (optional)">
                    </div>
                </div>

                <h3>Add Products</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Select Product *</label>
                        <div class="select-wrapper">
                            <input type="text" id="billProductSearch" placeholder="Search product..." autocomplete="off" oninput="searchProducts()" onfocus="showProductDropdown()">
                            <div class="dropdown-list" id="billProductDropdown"></div>
                            <input type="hidden" id="billProductId">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Batch</label>
                        <input type="text" id="billBatch" readonly>
                    </div>
                    <div class="form-group">
                        <label>Expiry</label>
                        <input type="month" id="billExpiry" readonly>
                    </div>
                    <div class="form-group">
                        <label>Available Qty</label>
                        <input type="number" id="availableQty" readonly>
                    </div>
                    <div class="form-group">
                        <label>MRP</label>
                        <input type="number" id="billMRP" readonly>
                    </div>
                    <div class="form-group">
                        <label>Sale Rate</label>
                        <input type="number" id="billRate" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Quantity *</label>
                        <input type="number" id="billQty" min="1" placeholder="Enter quantity">
                    </div>
                    <div class="form-group">
                        <label>Discount (%)</label>
                        <input type="number" id="billDiscount" min="0" max="100" value="0">
                    </div>
                </div>

                <button class="btn btn-primary" onclick="addToBill()">➕ Add to Bill</button>

                <div class="bill-section">
                    <h3>Current Bill Items</h3>
                    <table id="billItemsTable">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Batch</th>
                                <th>Exp</th>
                                <th>MRP</th>
                                <th>Rate</th>
                                <th>Qty</th>
                                <th>Disc %</th>
                                <th>GST</th>
                                <th>Amount</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="billItemsBody">
                            <tr><td colspan="10" style="text-align: center;">No items added</td></tr>
                        </tbody>
                    </table>

                    <div class="total-section">
                        <div class="total-row">
                            <span>Subtotal:</span>
                            <span id="subtotal">₹0.00</span>
                        </div>
                        <div class="total-row">
                            <span>Total Discount:</span>
                            <span id="totalDiscount">₹0.00</span>
                        </div>
                        <div class="total-row">
                            <span>CGST:</span>
                            <span id="totalCGST">₹0.00</span>
                        </div>
                        <div class="total-row">
                            <span>SGST:</span>
                            <span id="totalSGST">₹0.00</span>
                        </div>
                        <div class="total-row">
                            <span>Grand Total:</span>
                            <span id="grandTotal">₹0.00</span>
                        </div>
                    </div>

                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="generateBill()">🖨️ Generate Bill</button>
                        <button class="btn btn-danger" onclick="clearBill()">🗑️ Clear Bill</button>
                    </div>
                </div>
            </div>

            <div id="inventory" class="tab-content">
                <h2>Inventory Management</h2>
                
                <div class="inventory-actions">
                    <button class="btn btn-primary" onclick="showAddProductModal()">➕ Add New Product</button>
                    
                    <div id="expiry-filter-group" class="filter-btn-group">
                        <button class="filter-btn active" onclick="applyExpiryFilter('none', this)">Show All</button>
                        <button class="filter-btn" onclick="applyExpiryFilter('expired', this)">Expired</button>
                        <button class="filter-btn" onclick="applyExpiryFilter('thisMonth', this)">This Month</button>
                        <button class="filter-btn" onclick="applyExpiryFilter('next2months', this)">Next 2 Months</button>
                        <button class="filter-btn" onclick="applyExpiryFilter('next3months', this)">Next 3 Months</button>
                    </div>

                    <button class="btn btn-warning" onclick="checkLowStock()">📉 Low Stock Alert</button>
                </div>

                <div class="search-box">
                    <input type="text" id="inventorySearch" placeholder="Search products..." onkeyup="searchInventory()">
                </div>

                <table id="inventoryTable">
                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>Packaging</th>
                            <th>HSN</th>
                            <th>Batch</th>
                            <th>Quantity</th>
                            <th>MRP</th>
                            <th>Purchase Rate</th>
                            <th>Sale Rate (Incl. GST)</th>
                            <th>Expiry</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryBody">
                        <tr><td colspan="10" style="text-align: center;">No products in inventory</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Purchases Tab -->
            <div id="purchases" class="tab-content">
                <h2>Purchase Management</h2>
                <div class="inventory-actions">
                    <button class="btn btn-primary" onclick="showAddPurchaseModal()">➕ Add New Purchase Bill</button>
                </div>
                <table id="purchaseBillsTable">
                    <thead>
                        <tr>
                            <th>Bill No</th>
                            <th>Supplier</th>
                            <th>Bill Date</th>
                            <th>Tax Type</th>
                            <th>Total Amount</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="purchaseBillsBody">
                        <tr><td colspan="6" style="text-align:center;">Loading purchase bills...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- New Customers Tab -->
            <div id="customers" class="tab-content">
                <h2>Customer Management</h2>
                <div class="inventory-actions">
                    <div class="search-box">
                        <input type="text" id="customerSearch" placeholder="Search customers..." onkeyup="searchCustomers()">
                    </div>
                </div>
                <table id="customersTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Mobile</th>
                            <th>Doctor Name</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customersBody">
                        <tr><td colspan="5" style="text-align: center;">No customers found</td></tr>
                    </tbody>
                </table>
            </div>

            <div id="reports" class="tab-content">
                <h2>Reports & Analytics</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>From Date</label>
                        <input type="date" id="reportFromDate">
                    </div>
                    <div class="form-group">
                        <label>To Date</label>
                        <input type="date" id="reportToDate">
                    </div>
                    <div class="form-group">
                        <label>Report Type</label>
                        <select id="reportType">
                            <option value="sales">Sales Report</option>
                            <option value="purchases">Purchase Report</option>
                            <option value="gst">GST Report</option>
                            <option value="hsn_sale">HSN-wise Sale Report</option>
                            <option value="inventory">Inventory Report</option>
                            <option value="expiry">Expiry Report</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="generateReport()">📊 Generate Report</button>

                <div id="reportContent" style="margin-top: 30px;">
                    </div>
            </div>

            <div id="settings" class="tab-content">
                <h2>Settings</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Shop Name</label>
                        <input type="text" id="settingsShopName" value="Genericart Medicine Store">
                    </div>
                    <div class="form-group">
                        <label>GST Number</label>
                        <input type="text" id="settingsGST" value="16GLDPD3626M1Z0">
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="settingsPhone" value="6009700852">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="settingsEmail" value="genericartcr@gmail.com">
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" id="settingsAddress" value="Near MBB Club, Shivnagar, 799001">
                    </div>
                    <div class="form-group">
                        <label>Low Stock Alert (Qty)</label>
                        <input type="number" id="lowStockThreshold" value="10">
                    </div>
                </div>

                <button class="btn btn-success" onclick="saveSettings()">💾 Save Settings</button>
            </div>
            <!-- All Bills Tab -->
            <div id="oldBills" class="tab-content">
                <h2>All Bills</h2>
                <table id="billsTable">
                    <thead>
                        <tr>
                            <th>Bill No</th>
                            <th>Date</th>
                            <th>Patient</th>
                            <th>Total</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="billsBody">
                        <tr><td colspan="5" style="text-align:center;">Loading bills...</td></tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>

    <!-- MODALS SECTION -->

    <!-- Add/Edit Product Modal -->
    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <h2>Add New Product (Manual)</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>Product Name *</label>
                    <input type="text" id="newProductName" placeholder="Enter product name">
                </div>
                <div class="form-group">
                    <label>Packaging Type</label>
                    <select id="newPackaging">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label>HSN Code *</label>
                    <input type="text" id="newHSN" placeholder="HSN Code">
                </div>
                <div class="form-group">
                    <label>Batch Number *</label>
                    <input type="text" id="newBatch" placeholder="Batch number">
                </div>
                <div class="form-group">
                    <label>Quantity *</label>
                    <input type="number" id="newQuantity" min="0" placeholder="Initial quantity">
                </div>
                <div class="form-group">
                    <label>MRP *</label>
                    <input type="number" id="newMRP" step="0.01" placeholder="Maximum retail price">
                </div>
                <div class="form-group">
                    <label>Sale Rate (Incl. Tax) *</label>
                    <input type="number" id="newSaleRateInclusive" step="0.01" placeholder="Price with GST" oninput="calculateSaleExclusiveRate()">
                </div>
                <div class="form-group">
                    <label>Sale Rate (Excl. Tax)</label>
                    <input type="number" id="newSaleRate" step="0.01" readonly>
                </div>
                 <div class="form-group">
                    <label>CGST % *</label>
                    <input type="number" id="newCGST" min="0" max="100" step="0.5" value="6" oninput="calculateSaleExclusiveRate()">
                </div>
                <div class="form-group">
                    <label>SGST % *</label>
                    <input type="number" id="newSGST" min="0" max="100" step="0.5" value="6" oninput="calculateSaleExclusiveRate()">
                </div>
                <div class="form-group">
                    <label>Expiry Date *</label>
                    <input type="month" id="newExpiry">
                </div>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="addProduct()">Add Product</button>
                <button class="btn btn-danger" onclick="closeModal('addProductModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add Purchase Bill Modal -->
    <div id="addPurchaseModal" class="modal">
        <div class="modal-content" style="min-width: 90vw; max-width: 1200px;">
            <h2>Add New Purchase Bill</h2>
            
            <!-- Supplier Details -->
            <div class="form-grid">
                <div class="form-group">
                    <label>Supplier Name *</label>
                    <input type="text" id="purchaseSupplierName" placeholder="Enter supplier name">
                </div>
                <div class="form-group">
                    <label>Purchase Bill No *</label>
                    <input type="text" id="purchaseBillNumber" placeholder="Enter bill number from supplier">
                </div>
                <div class="form-group">
                    <label>Bill Date *</label>
                    <input type="date" id="purchaseBillDate">
                </div>
            </div>
    
            <div class="tax-toggle-group">
                <strong>Tax Type for this Purchase:</strong>
                <label><input type="radio" name="purchaseTaxType" value="CSGST" checked> CGST/SGST</label>
                <label><input type="radio" name="purchaseTaxType" value="IGST"> IGST</label>
            </div>
            
            <hr style="margin: 20px 0;">

            <!-- Add Products to Purchase -->
            <h3>Add Products to Bill</h3>
            <div class="form-grid form-grid-col-3" style="margin-bottom: 10px;">
                <div class="form-group">
                    <label>Product Name *</label>
                    <input type="text" id="purchaseProductName">
                </div>
                <div class="form-group">
                    <label>Packaging</label>
                    <select id="purchasePackaging"></select>
                </div>
                <div class="form-group">
                    <label>HSN *</label>
                    <input type="text" id="purchaseHSN">
                </div>
                <div class="form-group">
                    <label>Batch *</label>
                    <input type="text" id="purchaseBatch">
                </div>
                <div class="form-group">
                    <label>Quantity *</label>
                    <input type="number" id="purchaseQty" min="1">
                </div>
                <div class="form-group">
                    <label>Expiry *</label>
                    <input type="month" id="purchaseExpiry">
                </div>
            </div>
            <div class="form-grid form-grid-col-3">
                 <div class="form-group">
                    <label>Purchase Rate *</label>
                    <input type="number" id="purchaseRate" step="0.01" placeholder="Excl. Tax">
                </div>
                 <div class="form-group">
                    <label>Purchase GST % *</label>
                    <input type="number" id="purchaseGstPercent" min="0" value="12" step="0.01">
                </div>
                <div class="form-group">
                    <label>Discount %</label>
                    <input type="number" id="purchaseDiscount" min="0" value="0" step="0.01">
                </div>
                 <div class="form-group">
                    <label>Sale Rate (Incl. Tax) *</label>
                    <input type="number" id="purchaseSaleRateIncl" step="0.01" oninput="calculatePurchaseSaleExclusiveRate()">
                </div>
                <div class="form-group">
                    <label>Sale GST % *</label>
                    <input type="number" id="purchaseSaleGstPercent" min="0" value="12" step="0.01" oninput="calculatePurchaseSaleExclusiveRate()">
                </div>
                <div class="form-group">
                    <label>Sale Rate (Excl. Tax)</label>
                    <input type="number" id="purchaseSaleRateExcl" step="0.01" readonly>
                </div>
                 <div class="form-group">
                    <label>MRP *</label>
                    <input type="number" id="purchaseMRP" step="0.01">
                </div>
            </div>
            <button class="btn btn-info" onclick="addProductToPurchaseBill()">➕ Add Product</button>
    
            <!-- Current Purchase Bill Items -->
            <div class="bill-section" style="margin-top:20px;">
                <h3>Purchase Items</h3>
                <table id="purchaseItemsTable">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Batch</th>
                            <th>Qty</th>
                            <th>Rate</th>
                            <th>Subtotal</th>
                            <th>Disc %</th>
                            <th>GST</th>
                            <th>Amount</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="purchaseItemsBody">
                        <tr><td colspan="9" style="text-align: center;">No items added</td></tr>
                    </tbody>
                </table>
                <div class="total-section" style="margin-top:10px;">
                     <div class="total-row">
                        <span>Total (Pre-rounding):</span>
                        <span id="purchaseTotalAmount">₹0.00</span>
                    </div>
                    <div class="total-row">
                        <span>Rounding:</span>
                        <span id="purchaseRoundingAmount">₹0.00</span>
                    </div>
                    <div class="total-row">
                        <strong><span>Grand Total:</span></strong>
                        <strong><span id="purchaseGrandTotal">₹0.00</span></strong>
                    </div>
                </div>
            </div>
    
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="savePurchaseBill()">💾 Save Purchase Bill</button>
                <button class="btn btn-danger" onclick="closeModal('addPurchaseModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- View Purchase Modal -->
    <div id="viewPurchaseModal" class="modal">
        <div class="modal-content" style="min-width: 800px;">
            <h2>Purchase Bill Details</h2>
            <div id="viewPurchaseContent"></div>
            <div style="margin-top: 20px;">
                <button class="btn btn-danger" onclick="closeModal('viewPurchaseModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content" style="min-width: 800px;">
            <div class="invoice-container" id="invoiceContent">
                </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;" class="no-print">
                <button class="btn btn-primary" onclick="printInvoice()">🖨️ Print Invoice</button>
                <button class="btn btn-danger" onclick="closeModal('invoiceModal')">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Bill Modal -->
    <div id="editBillModal" class="modal">
        <div class="modal-content" style="min-width: 800px;">
            <h2>Edit Bill</h2>
            <div id="editBillContent"></div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="saveEditedBill()">💾 Save Changes</button>
                <button class="btn btn-danger" onclick="closeModal('editBillModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Customer Modal -->
    <div id="editCustomerModal" class="modal">
        <div class="modal-content">
            <h2>Edit Customer</h2>
            <input type="hidden" id="editCustomerId">
            <div class="form-grid">
                <div class="form-group">
                    <label>Customer Name *</label>
                    <input type="text" id="editCustomerName" placeholder="Enter customer name">
                </div>
                <div class="form-group">
                    <label>Mobile Number *</label>
                    <input type="tel" id="editCustomerMobile" placeholder="10-digit mobile number" maxlength="10">
                </div>
                <div class="form-group">
                    <label>Doctor Name</label>
                    <input type="text" id="editCustomerDoctorName" placeholder="Prescribing doctor (optional)">
                </div>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="updateCustomer()">Update Customer</button>
                <button class="btn btn-danger" onclick="closeModal('editCustomerModal')">Cancel</button>
            </div>
        </div>
    </div>


    <script>
        // Data Storage
        let inventory = [];
        let billItems = [];
        let purchaseBillItems = [];
        let transactions = [];
        let settings = {};
        const packagingTypes = [ "STRIP", "BOTTLE", "PACK", "JAR", "TABLET", "CAPSULES", "BOX", "TUBE", "PIECE", "VIAL", "INJ", "SACHET", "SPRAY BOTTLE", "CAN", "UNIT", "AMPUL", "DROP", "PACKET", "POUCH", "INSURANCE", "RESPULE", "AMPOULE", "GLOVES", "INSULIN", "VIAL & SMALL BOTTLE", "SYRINGE", "TIN", "CONTAINER", "SUPPOSITRIES", "ML", "INJECTION" ];

        // Base URL for the API
        const API_BASE_URL = 'http://localhost:3000/api';

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            populatePackagingDropdowns();
            await fetchSettings();
            await fetchInventory();
            await fetchDashboardData();
            setTodayDate();
        });

        // Tab Switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'dashboard') {
                fetchDashboardData();
            } else if (tabName === 'inventory') {
                fetchInventory();
            } else if (tabName === 'customers') {
                fetchCustomers();
            } else if (tabName === 'reports') {
                setTodayDate();
                document.getElementById('reportContent').innerHTML = ''; // Clear previous report
            } else if (tabName === 'oldBills') {
                fetchBills();
            } else if (tabName === 'purchases') {
                fetchPurchaseBills();
            }
        }

        function populatePackagingDropdowns() {
            const newPackagingSelect = document.getElementById('newPackaging');
            const purchasePackagingSelect = document.getElementById('purchasePackaging');
            
            packagingTypes.forEach(type => {
                const option1 = new Option(type, type);
                const option2 = new Option(type, type);
                newPackagingSelect.add(option1);
                purchasePackagingSelect.add(option2);
            });
        }


        // Settings Management
        async function fetchSettings() {
            try {
                const response = await fetch(`${API_BASE_URL}/settings`);
                settings = await response.json();
                loadSettings();
            } catch (error) {
                showAlert('Failed to load settings.', 'danger');
                console.error('Error fetching settings:', error);
            }
        }

        function loadSettings() {
            if (!settings) return;
            
            const shopNameEl = document.getElementById('shopName');
            if (shopNameEl && settings.shopName) {
                shopNameEl.textContent = settings.shopName;
            }
            
            const settingsInputs = [
                'settingsShopName', 'settingsGST', 'settingsPhone', 
                'settingsEmail', 'settingsAddress', 'lowStockThreshold'
            ];
            
            settingsInputs.forEach(inputId => {
                const element = document.getElementById(inputId);
                const settingKey = inputId.replace('settings', '').toLowerCase();
                const key = settingKey === 'gst' ? 'gst' : settingKey === 'lowstockthreshold' ? 'lowStockThreshold' : settingKey;
                
                if (element && settings[key]) {
                    element.value = settings[key];
                }
            });
        }

        async function saveSettings() {
            const updatedSettings = {
                shopName: document.getElementById('settingsShopName').value,
                gst: document.getElementById('settingsGST').value,
                phone: document.getElementById('settingsPhone').value,
                email: document.getElementById('settingsEmail').value,
                address: document.getElementById('settingsAddress').value,
                lowStockThreshold: parseInt(document.getElementById('lowStockThreshold').value)
            };
            try {
                const response = await fetch(`${API_BASE_URL}/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ settings: updatedSettings })
                });
                const result = await response.json();
                if (response.ok) {
                    settings = updatedSettings;
                    loadSettings();
                    showAlert(result.message, 'success');
                } else {
                    showAlert(result.error, 'danger');
                }
            } catch (error) {
                showAlert('Failed to save settings.', 'danger');
            }
        }

        // Inventory Management
        async function fetchInventory() {
            try {
                const response = await fetch(`${API_BASE_URL}/products`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to fetch inventory');
                }
                inventory = await response.json();
                updateInventoryTable(inventory);
                if (document.getElementById('dashboard').classList.contains('active')) {
                    await fetchDashboardData();
                }
            } catch (error) {
                inventory = [];
                updateInventoryTable(inventory);
                showAlert('Failed to load inventory: ' + error.message, 'danger');
            }
        }
        async function showAddProductModal() {
            closeModal('invoiceModal'); // Close any open modals
            document.getElementById('addProductModal').classList.add('active');
            clearProductForm();
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function calculateSaleExclusiveRate() {
            const inclusiveRateEl = document.getElementById('newSaleRateInclusive');
            const exclusiveRateEl = document.getElementById('newSaleRate');
            const cgst = parseFloat(document.getElementById('newCGST').value) || 0;
            const sgst = parseFloat(document.getElementById('newSGST').value) || 0;
            const totalGstPercent = cgst + sgst;
            const inclusiveRate = parseFloat(inclusiveRateEl.value);

            if (!isNaN(inclusiveRate) && inclusiveRate > 0) {
                const exclusiveRate = inclusiveRate / (1 + (totalGstPercent / 100));
                exclusiveRateEl.value = exclusiveRate.toFixed(2);
            } else {
                 exclusiveRateEl.value = '';
            }
        }

        async function addProduct() {
            const product = {
                name: document.getElementById('newProductName').value,
                packaging: document.getElementById('newPackaging').value,
                hsn: document.getElementById('newHSN').value,
                batch: document.getElementById('newBatch').value,
                quantity: parseInt(document.getElementById('newQuantity').value),
                mrp: parseFloat(document.getElementById('newMRP').value),
                saleRate: parseFloat(document.getElementById('newSaleRate').value),
                saleRateInclusive: parseFloat(document.getElementById('newSaleRateInclusive').value),
                expiry: document.getElementById('newExpiry').value,
                cgst: parseFloat(document.getElementById('newCGST').value),
                sgst: parseFloat(document.getElementById('newSGST').value)
            };

            if (!product.name || !product.hsn || !product.batch || isNaN(product.quantity) || 
                isNaN(product.mrp) || isNaN(product.saleRate) || !product.expiry) {
                showAlert('Please fill all required fields!', 'danger');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/products`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(product)
                });
                const result = await response.json();
                if (response.ok) {
                    showAlert(result.message, 'success');
                    await fetchInventory();
                    await fetchDashboardData();
                    closeModal('addProductModal');
                } else {
                    showAlert(result.error, 'danger');
                }
            } catch (error) {
                showAlert('Failed to add product.', 'danger');
            }
        }

        function clearProductForm() {
            document.getElementById('newProductName').value = '';
            document.getElementById('newPackaging').value = packagingTypes[0];
            document.getElementById('newHSN').value = '';
            document.getElementById('newBatch').value = '';
            document.getElementById('newQuantity').value = '';
            document.getElementById('newMRP').value = '';
            document.getElementById('newSaleRateInclusive').value = '';
            document.getElementById('newSaleRate').value = '';
            document.getElementById('newExpiry').value = '';
            document.getElementById('newCGST').value = '6';
            document.getElementById('newSGST').value = '6';
        }

        function updateInventoryTable(data) {
            const tableBody = document.getElementById('inventoryBody');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            
            if (!data || data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center;">No products in inventory</td></tr>';
                return;
            }

            const today = new Date();
            data.forEach(product => {
                const row = document.createElement('tr');
                let rowClass = '';
                const expiryDate = new Date(`${product.expiry}-01`);
                if (expiryDate < today) rowClass = 'expired-item';
                if (product.quantity <= (settings.lowStockThreshold || 10)) {
                    rowClass += ' low-stock';
                }
                row.className = rowClass.trim();
                row.innerHTML = `
                    <td>${product.name || 'N/A'}</td>
                    <td>${product.packaging || 'N/A'}</td>
                    <td>${product.hsn || 'N/A'}</td>
                    <td>${product.batch || 'N/A'}</td>
                    <td>${product.quantity || 0}</td>
                    <td>₹${parseFloat(product.mrp || 0).toFixed(2)}</td>
                    <td>₹${parseFloat(product.purchase_rate || 0).toFixed(2)}</td>
                    <td>₹${parseFloat(product.sale_rate_inclusive || 0).toFixed(2)}</td>
                    <td>${product.expiry || 'N/A'}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" style="margin-right: 5px;" onclick="editProduct(${product.id})">✏️</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteProduct(${product.id})">❌</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }


        async function searchInventory() {
            const query = document.getElementById('inventorySearch').value.toLowerCase();
            try {
                const response = await fetch(`${API_BASE_URL}/products/search?query=${query}`);
                const filtered = await response.json();
                updateInventoryTable(filtered);
            } catch (error) {
                showAlert('Failed to search inventory.', 'danger');
            }
        }
        
        function applyExpiryFilter(filterType, element) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
            filterExpiring(filterType);
        }

        async function filterExpiring(filterType) {
            if (filterType === 'none') {
                fetchInventory();
                return;
            }
            try {
                const allProducts = await fetch(`${API_BASE_URL}/products`).then(res => res.json());
                const today = new Date();
                let filteredProducts = [];
                if (filterType === 'expired') {
                    filteredProducts = allProducts.filter(p => p.expiry && new Date(`${p.expiry}-01`) < today);
                } else {
                    const months = { 'thisMonth': 1, 'next2months': 2, 'next3months': 3 }[filterType];
                    const futureDate = new Date();
                    futureDate.setMonth(futureDate.getMonth() + months);
                    filteredProducts = allProducts.filter(p => {
                        if (!p.expiry) return false;
                        const expiryDate = new Date(`${p.expiry}-01`);
                        return expiryDate >= today && expiryDate <= futureDate;
                    });
                }
                updateInventoryTable(filteredProducts);
                showAlert(`Showing products expiring based on filter.`, 'info');
            } catch (error) {
                showAlert('Failed to filter products.', 'danger');
            }
        }

        async function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                try {
                    const response = await fetch(`${API_BASE_URL}/products/${id}`, { method: 'DELETE' });
                    const result = await response.json();
                    if (response.ok) {
                        showAlert(result.message, 'success');
                        await fetchInventory();
                        await fetchDashboardData();
                    } else {
                        showAlert(result.error, 'danger');
                    }
                } catch (error) {
                    showAlert('Failed to delete product.', 'danger');
                }
            }
        }

        async function editProduct(id) {
            try {
                const product = await fetch(`${API_BASE_URL}/products/${id}`).then(res => res.json());
                const newQuantity = prompt(`Enter new quantity for ${product.name} (Current: ${product.quantity}):`);
                if (newQuantity !== null && !isNaN(newQuantity) && parseInt(newQuantity) >= 0) {
                    const response = await fetch(`${API_BASE_URL}/products/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ quantity: parseInt(newQuantity) })
                    });
                    const result = await response.json();
                    if (response.ok) {
                        showAlert(result.message, 'success');
                        await fetchInventory();
                        await fetchDashboardData();
                    } else {
                        showAlert(result.error, 'danger');
                    }
                } else if (newQuantity !== null) {
                    showAlert('Invalid quantity entered!', 'danger');
                }
            } catch (error) {
                showAlert('Failed to edit product.', 'danger');
            }
        }

        async function checkLowStock() {
            const allProducts = await fetch(`${API_BASE_URL}/products`).then(res => res.json());
            const lowStock = allProducts.filter(p => p.quantity <= settings.lowStockThreshold);
            const message = lowStock.length > 0
                ? `Low stock products (<= ${settings.lowStockThreshold}): \n\n${lowStock.map(p => `${p.name} (Qty: ${p.quantity})`).join('\n')}`
                : 'All products are well stocked.';
            alert(message);
        }

        // Billing Logic
        async function searchProducts() {
            const query = document.getElementById('billProductSearch').value.toLowerCase().trim();
            const dropdown = document.getElementById('billProductDropdown');
            dropdown.innerHTML = '';
            if (query.length < 1) {
                dropdown.style.display = 'none';
                return;
            }
            try {
                const filteredProducts = await fetch(`${API_BASE_URL}/products/search?query=${encodeURIComponent(query)}`).then(res => res.json());
                if (filteredProducts.length > 0) {
                    filteredProducts.forEach(product => {
                        const item = document.createElement('div');
                        item.textContent = `${product.name} - Batch: ${product.batch} (Qty: ${product.quantity})`;
                        item.onclick = () => selectProduct(product);
                        dropdown.appendChild(item);
                    });
                    dropdown.style.display = 'block';
                } else {
                    dropdown.innerHTML = '<div>No products found</div>';
                    dropdown.style.display = 'block';
                }
            } catch (error) {
                dropdown.innerHTML = '<div>Error searching</div>';
                dropdown.style.display = 'block';
            }
        }

        function showProductDropdown() {
            document.getElementById('billProductDropdown').style.display = 'block';
        }

        document.addEventListener('click', (event) => {
            if (!document.querySelector('.select-wrapper').contains(event.target)) {
                document.getElementById('billProductDropdown').style.display = 'none';
            }
        });

        function selectProduct(product) {
            document.getElementById('billProductSearch').value = `${product.name} - ${product.batch}`;
            document.getElementById('billProductId').value = product.id;
            document.getElementById('billBatch').value = product.batch;
            document.getElementById('billExpiry').value = product.expiry;
            document.getElementById('availableQty').value = product.quantity;
            document.getElementById('billMRP').value = Number(product.mrp).toFixed(2);
            document.getElementById('billRate').value = Number(product.sale_rate).toFixed(2);
            document.getElementById('billProductDropdown').style.display = 'none';
            document.getElementById('billQty').max = product.quantity;
            document.getElementById('billQty').focus();
        }

        function addToBill() {
            const productId = Number(document.getElementById('billProductId').value);
            const quantity = Number(document.getElementById('billQty').value);
            const rate = Number(document.getElementById('billRate').value);
            const discount = Number(document.getElementById('billDiscount').value);

            if (!productId || !quantity || quantity <= 0 || rate < 0) {
                showAlert('Please select a product and enter valid details.', 'danger');
                return;
            }

            const product = inventory.find(p => p.id === productId);
            if (quantity > product.quantity) {
                showAlert(`Not enough stock. Only ${product.quantity} available.`, 'danger');
                return;
            }

            const existing = billItems.find(item => item.id === productId);
            if (existing) {
                existing.quantity += quantity;
            } else {
                billItems.push({ ...product, quantity, rate, discount });
            }   

            updateBillTable();
            calculateTotals();
            clearProductInputs();
            showAlert('Product added to bill!', 'success');
        }

        function updateBillTable() {
            const tableBody = document.getElementById('billItemsBody');
            tableBody.innerHTML = '';
            if (billItems.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center;">No items added</td></tr>';
                return;
            }

            billItems.forEach((item, index) => {
                const amount = (item.rate * item.quantity) * (1 - (item.discount / 100));
                const totalGST = amount * ((Number(item.cgst) + Number(item.sgst)) / 100);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.batch}</td>
                    <td>${item.expiry}</td>
                    <td>₹${Number(item.mrp).toFixed(2)}</td>
                    <td>₹${Number(item.rate).toFixed(2)}</td>
                    <td>${item.quantity}</td>
                    <td>${item.discount}%</td>
                    <td>${(Number(item.cgst) + Number(item.sgst))}%</td>
                    <td>₹${(amount + totalGST).toFixed(2)}</td>
                    <td><button class="btn btn-danger btn-sm" onclick="removeFromBill(${index})">🗑️</button></td>
                `;
                tableBody.appendChild(row);
            });
        }

        function clearProductInputs() {
            document.getElementById('billProductSearch').value = '';
            document.getElementById('billProductId').value = '';
            document.getElementById('billQty').value = '';
            document.getElementById('billDiscount').value = '0';
            document.getElementById('billBatch').value = '';
            document.getElementById('billExpiry').value = '';
            document.getElementById('availableQty').value = '';
            document.getElementById('billMRP').value = '';
            document.getElementById('billRate').value = '';
        }

        function removeFromBill(index) {
            billItems.splice(index, 1);
            updateBillTable();
            calculateTotals();
        }

        function calculateTotals() {
            let subtotal = 0, totalDiscount = 0, totalCGST = 0, totalSGST = 0;

            billItems.forEach(item => {
                const itemSubtotal = item.rate * item.quantity;
                const itemDiscount = itemSubtotal * (item.discount / 100);
                const taxable = itemSubtotal - itemDiscount;
                subtotal += itemSubtotal;
                totalDiscount += itemDiscount;
                totalCGST += taxable * (Number(item.cgst) / 100);
                totalSGST += taxable * (Number(item.sgst) / 100);
            });

            const grandTotal = subtotal - totalDiscount + totalCGST + totalSGST;
            const rounded = Math.round(grandTotal);
            const rounding = rounded - grandTotal;

            document.getElementById('subtotal').textContent = `₹${subtotal.toFixed(2)}`;
            document.getElementById('totalDiscount').textContent = `₹${totalDiscount.toFixed(2)}`;
            document.getElementById('totalCGST').textContent = `₹${totalCGST.toFixed(2)}`;
            document.getElementById('totalSGST').textContent = `₹${totalSGST.toFixed(2)}`;
            
            let roundingRow = document.getElementById('roundingRow');
            if (!roundingRow) {
                roundingRow = document.createElement('div');
                roundingRow.className = 'total-row';
                roundingRow.id = 'roundingRow';
                const gtRow = document.getElementById('grandTotal').parentNode;
                gtRow.parentNode.insertBefore(roundingRow, gtRow);
            }
            roundingRow.innerHTML = `<span>Rounding:</span><span>₹${rounding.toFixed(2)}</span>`;
            document.getElementById('grandTotal').textContent = `₹${rounded.toFixed(2)}`;
        }


        async function generateBill() {
            if (!document.getElementById('patientName').value || !document.getElementById('patientMobile').value || billItems.length === 0) {
                showAlert('Patient details and at least one item are required.', 'danger');
                return;
            }

            const bill = {
                patientName: document.getElementById('patientName').value,
                patientMobile: document.getElementById('patientMobile').value,
                doctorName: document.getElementById('doctorName').value,
                items: billItems.map(item => ({ ...item, product_id: item.id })),
            };

            try {
                const response = await fetch(`${API_BASE_URL}/bills`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bill)
                });
                const result = await response.json();
                if (response.ok) {
                    showAlert('Bill generated successfully!', 'success');
                    const savedBill = await fetch(`${API_BASE_URL}/bills/${result.id}`).then(res => res.json());
                    displayInvoice(savedBill);
                    await fetchInventory();
                    await fetchDashboardData();
                    clearBill();
                } else {
                    showAlert(result.error, 'danger');
                }
            } catch (error) {
                showAlert('Failed to generate bill.', 'danger');
            }
        }

        function displayInvoice(bill) {
            const itemsHtml = bill.items.map(item => {
                const taxable = (item.rate * item.quantity) * (1 - (item.discount / 100));
                const gst = taxable * ((Number(item.cgst) + Number(item.sgst)) / 100);
                return `<tr>
                    <td>${item.product_name}</td> <td>${item.batch}</td> <td>${item.expiry}</td>
                    <td>₹${Number(item.mrp).toFixed(2)}</td> <td>${item.quantity}</td> <td>₹${Number(item.rate).toFixed(2)}</td>
                    <td>${item.discount}%</td> <td>${(Number(item.cgst) + Number(item.sgst))}%</td> <td>₹${(taxable + gst).toFixed(2)}</td>
                </tr>`;
            }).join('');

            const rounded = Math.round(Number(bill.grand_total));
            const rounding = rounded - Number(bill.grand_total);

            document.getElementById('invoiceContent').innerHTML = `
                <div class="bill-header"> <h2>Invoice</h2> <h1>${settings.shopName}</h1> <p>GST: ${settings.gst} | Ph: ${settings.phone}</p> <p>${settings.address}</p> </div>
                <div class="bill-details" style="display: flex; justify-content: space-between;"> <div><strong>Bill No:</strong> ${bill.bill_number}</div> <div><strong>Date:</strong> ${formatDateForDisplay(bill.bill_date)}</div> </div>
                <div class="bill-details" style="display: flex; justify-content: space-between;"> <div><strong>Patient Name:</strong> ${bill.patient_name}</div> <div><strong>Mobile:</strong> ${bill.patient_mobile}</div> </div>
                ${bill.doctor_name ? `<div><strong>Doctor Name:</strong> ${bill.doctor_name}</div>` : ''}
                <table style="margin-top: 20px;"> <thead> <tr> <th>Product</th> <th>Batch</th> <th>Exp</th> <th>MRP</th> <th>Qty</th> <th>Rate</th> <th>Disc %</th> <th>GST</th> <th>Amount</th> </tr> </thead> <tbody> ${itemsHtml} </tbody> </table>
                <div class="total-section">
                    <div class="total-row"><span>Subtotal:</span><span>₹${Number(bill.subtotal).toFixed(2)}</span></div>
                    <div class="total-row"><span>Discount:</span><span>₹${Number(bill.total_discount).toFixed(2)}</span></div>
                    <div class="total-row"><span>CGST:</span><span>₹${Number(bill.total_cgst).toFixed(2)}</span></div>
                    <div class="total-row"><span>SGST:</span><span>₹${Number(bill.total_sgst).toFixed(2)}</span></div>
                    <div class="total-row"><span>Rounding:</span><span>₹${rounding.toFixed(2)}</span></div>
                    <div class="total-row"><span>Grand Total:</span><span>₹${rounded.toFixed(2)}</span></div>
                </div>`;
            document.getElementById('invoiceModal').classList.add('active');
        }

        function printInvoice() {
            const content = document.getElementById('invoiceContent').innerHTML;
            const original = document.body.innerHTML;
            document.body.innerHTML = content;
            window.print();
            document.body.innerHTML = original;
            location.reload();
        }

        function clearBill() {
            billItems = [];
            document.getElementById('patientName').value = '';
            document.getElementById('patientMobile').value = '';
            document.getElementById('doctorName').value = '';
            clearProductInputs();
            updateBillTable();
            calculateTotals();
        }

        // Dashboard & Reporting
        // FIX: The dashboard data is now fetched from a dedicated, reliable server endpoint.
        async function fetchDashboardData() {
            try {
                const response = await fetch(`${API_BASE_URL}/dashboard-stats`);
                if (!response.ok) {
                    throw new Error('Failed to fetch dashboard stats');
                }
                const data = await response.json();

                document.getElementById('todaySales').textContent = `₹${Number(data.todaySales).toFixed(2)}`;
                document.getElementById('todayBillsCount').textContent = data.todayBillsCount;
                document.getElementById('totalItems').textContent = data.totalItems;
                document.getElementById('lowStockCount').textContent = data.lowStockCount;
                document.getElementById('expiringCount').textContent = data.expiringCount;
                updateRecentTransactions(data.recentTransactions);

            } catch (error) {
                console.error('Error fetching dashboard data:', error);
                showAlert('Failed to load dashboard data.', 'danger');
            }
        }

        function updateRecentTransactions(bills) {
            const body = document.getElementById('recentTransactionsBody');
            body.innerHTML = '';
            if (!bills || bills.length === 0) {
                body.innerHTML = '<tr><td colspan="5" style="text-align: center;">No recent transactions</td></tr>';
                return;
            }
            bills.slice(0, 5).forEach(b => {
                body.innerHTML += `<tr>
                    <td>${b.bill_number}</td> <td>${formatDateForDisplay(b.bill_date)}</td>
                    <td>${b.patient_name}</td> <td>₹${Number(b.grand_total).toFixed(2)}</td>
                    <td><span style="color: green; font-weight: bold;">Paid</span></td>
                </tr>`;
            });
        }

        async function generateReport() {
            const type = document.getElementById('reportType').value;
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;
            const contentDiv = document.getElementById('reportContent');
            contentDiv.innerHTML = '<h3>Generating report...</h3>';

            if(!fromDate || !toDate) {
                showAlert('Please select a valid date range.', 'danger');
                contentDiv.innerHTML = '';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/reports?type=${type}&fromDate=${fromDate}&toDate=${toDate}`);
                if (!response.ok) throw new Error(await response.json().then(e => e.error));
                const data = await response.json();
                
                let html = `<h3>${type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())} Report from ${fromDate} to ${toDate}</h3>`;

                if (data.length === 0) {
                    html += `<p>No data found for this period.</p>`;
                } else {
                    const headers = Object.keys(data[0]);
                    html += `<table class="report-table"><thead><tr>${headers.map(h => `<th>${h.replace(/_/g, ' ').toUpperCase()}</th>`).join('')}</tr></thead><tbody>`;
                    data.forEach(row => {
                         html += `<tr>${headers.map(h => {
                             const val = row[h];
                             let displayVal = val === null || val === undefined ? '' : val;
                             const isCurrency = typeof parseFloat(val) === 'number' && !isNaN(parseFloat(val)) && (h.includes('rate') || h.includes('amount') || h.includes('total') || h.includes('mrp') || h.includes('gst'));
                             if(isCurrency) {
                                 displayVal = '₹' + parseFloat(val).toFixed(2);
                             } else if (h.includes('date')) { // Format dates in reports too
                                 displayVal = formatDateForDisplay(val);
                             }
                             return `<td>${displayVal}</td>`;
                         }).join('')}</tr>`;
                    });
                    html += `</tbody></table>`;
                }
                contentDiv.innerHTML = html;
            } catch(error) {
                showAlert(`Error generating report: ${error.message}`, 'danger');
                contentDiv.innerHTML = `<p style="color:red;">Could not generate report.</p>`;
            }
        }

        // Bills: Fetch / Show / Edit
        async function fetchBills() {
             try {
                const bills = await fetch(`${API_BASE_URL}/bills`).then(res => res.json());
                updateBillsTable(bills);
            } catch (error) {
                showAlert(error.message, 'danger');
            }
        }
        function updateBillsTable(bills) {
            const billsBody = document.getElementById('billsBody');
            billsBody.innerHTML = '';
            if (!bills || bills.length === 0) {
                billsBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No bills found</td></tr>';
                return;
            }

            bills.forEach(bill => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${bill.bill_number}</td>
                    <td>${formatDateForDisplay(bill.bill_date)}</td>
                    <td>${bill.patient_name}</td>
                    <td>₹${parseFloat(bill.grand_total).toFixed(2)}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="viewBill(${bill.id})">✏️ View/Edit</button>
                        <button class="btn btn-info btn-sm" onclick="printOldBill(${bill.id})" style="margin-left: 5px;">🖨️ Print</button>
                    </td>
                `;
                billsBody.appendChild(row);
            });
        }
        
        function removeEditedItem(index) {
            if (!window.currentEditingBill || !window.currentEditingBill.items) return;
            window.currentEditingBill.items.splice(index, 1);
            renderEditBillItems();
        }

        function renderEditBillItems() {
            let itemsHtml = window.currentEditingBill.items.map((item, i) => `
                <tr>
                    <td>${item.product_name}</td>
                    <td><input type="text" value="${item.batch}" class="edit-batch" data-index="${i}" style="width:100px;"></td>
                    <td><input type="number" value="${item.quantity}" class="edit-qty" data-index="${i}" style="width:60px;" oninput="recalculateEditedBillTotals()"></td>
                    <td><input type="number" value="${item.rate}" class="edit-rate" data-index="${i}" step="0.01" style="width:80px;" oninput="recalculateEditedBillTotals()"></td>
                    <td><input type="number" value="${item.discount}" class="edit-discount" data-index="${i}" step="0.01" style="width:70px;" oninput="recalculateEditedBillTotals()"></td>
                    <td><button class="btn btn-danger btn-sm" onclick="removeEditedItem(${i})">Remove</button></td>
                </tr>
            `).join('');
            document.getElementById('editBillItemsBody').innerHTML = itemsHtml;
            recalculateEditedBillTotals();
        }

        function recalculateEditedBillTotals() {
            const qtyInputs = document.querySelectorAll('.edit-qty');
            const rateInputs = document.querySelectorAll('.edit-rate');
            const discountInputs = document.querySelectorAll('.edit-discount');
            
            let subtotal = 0, totalDiscount = 0, totalCGST = 0, totalSGST = 0;

            window.currentEditingBill.items.forEach((item, i) => {
                const qty = Number(qtyInputs[i].value);
                const rate = Number(rateInputs[i].value);
                const discount = Number(discountInputs[i].value);
                
                const itemSubtotal = rate * qty;
                const itemDiscountAmount = itemSubtotal * (discount / 100);
                const taxable = itemSubtotal - itemDiscountAmount;
                
                subtotal += itemSubtotal;
                totalDiscount += itemDiscountAmount;
                totalCGST += taxable * (Number(item.cgst) / 100);
                totalSGST += taxable * (Number(item.sgst) / 100);
            });

            const grandTotal = subtotal - totalDiscount + totalCGST + totalSGST;
            const rounded = Math.round(grandTotal);
            
            document.getElementById('editSubtotal').textContent = `₹${subtotal.toFixed(2)}`;
            document.getElementById('editDiscount').textContent = `₹${totalDiscount.toFixed(2)}`;
            document.getElementById('editCgst').textContent = `₹${totalCGST.toFixed(2)}`;
            document.getElementById('editSgst').textContent = `₹${totalSGST.toFixed(2)}`;
            document.getElementById('editGrandTotal').textContent = `₹${rounded.toFixed(2)}`;
        }

        async function viewBill(billId) {
            try {
                const bill = await fetch(`${API_BASE_URL}/bills/${billId}`).then(res => res.json());
                window.currentEditingBill = bill;

                document.getElementById('editBillContent').innerHTML = `
                    <div class="form-grid">
                        <div class="form-group"> <label>Patient Name</label> <input type="text" id="editPatientName" value="${bill.patient_name}"> </div>
                        <div class="form-group"> <label>Patient Mobile</label> <input type="text" id="editPatientMobile" value="${bill.patient_mobile}"> </div>
                        <div class="form-group"> <label>Doctor Name</label> <input type="text" id="editDoctorName" value="${bill.doctor_name || ''}"> </div>
                    </div>
                    <p><strong>Bill No:</strong> ${bill.bill_number}</p>
                    <table style="width:100%; margin-top:10px;">
                        <thead> <tr> <th>Product</th> <th>Batch</th> <th>Qty</th> <th>Rate</th> <th>Discount %</th> <th>Action</th> </tr> </thead>
                        <tbody id="editBillItemsBody"></tbody>
                    </table>
                    <div class="total-section" style="margin-top:10px;">
                         <div class="total-row"><span>Subtotal:</span><span id="editSubtotal"></span></div>
                         <div class="total-row"><span>Discount:</span><span id="editDiscount"></span></div>
                         <div class="total-row"><span>CGST:</span><span id="editCgst"></span></div>
                         <div class="total-row"><span>SGST:</span><span id="editSgst"></span></div>
                         <div class="total-row"><span>Grand Total:</span><span id="editGrandTotal"></span></div>
                    </div>`;

                renderEditBillItems();
                document.getElementById('editBillModal').classList.add('active');
            } catch (error) {
                showAlert('Failed to fetch bill details.', 'danger');
            }
        }
        
        async function saveEditedBill() {
            if (!window.currentEditingBill) return;

            const qtyInputs = document.querySelectorAll('.edit-qty');
            const rateInputs = document.querySelectorAll('.edit-rate');
            const discountInputs = document.querySelectorAll('.edit-discount');
            const batchInputs = document.querySelectorAll('.edit-batch');
            
            const updatedItems = window.currentEditingBill.items.map((item, i) => ({
                ...item,
                batch: batchInputs[i].value,
                quantity: Number(qtyInputs[i].value),
                rate: Number(rateInputs[i].value),
                discount: Number(discountInputs[i].value)
            }));

            const payload = {
                ...window.currentEditingBill,
                patient_name: document.getElementById('editPatientName').value,
                patient_mobile: document.getElementById('editPatientMobile').value,
                doctor_name: document.getElementById('editDoctorName').value,
                items: updatedItems
            };

            try {
                const response = await fetch(`${API_BASE_URL}/bills/${payload.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (response.ok) {
                    showAlert('Bill updated successfully!', 'success');
                    closeModal('editBillModal');
                    await fetchBills();
                    await fetchInventory();
                } else {
                    showAlert(result.error, 'danger');
                }
            } catch (error) {
                showAlert('Failed to update bill.', 'danger');
            }
        }

        async function printOldBill(billId) {
             try {
                const bill = await fetch(`${API_BASE_URL}/bills/${billId}`).then(res => res.json());
                displayInvoice(bill);
             } catch(error) {
                showAlert('Could not fetch bill for printing.', 'danger');
             }
        }

        // Purchase Management
        async function fetchPurchaseBills() {
            try {
                const purchaseBills = await fetch(`${API_BASE_URL}/purchases`).then(res => res.json());
                updatePurchaseBillsTable(purchaseBills);
            } catch (error) {
                showAlert(error.message, 'danger');
            }
        }

        function updatePurchaseBillsTable(bills) {
            const tableBody = document.getElementById('purchaseBillsBody');
            tableBody.innerHTML = '';
            if (!bills || bills.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No purchase bills found</td></tr>';
                return;
            }
            bills.forEach(bill => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${bill.bill_number}</td> <td>${bill.supplier_name}</td>
                    <td>${formatDateForDisplay(bill.bill_date)}</td> <td>${bill.tax_type}</td>
                    <td>₹${Number(bill.total_amount).toFixed(2)}</td>
                    <td><button class="btn btn-info btn-sm" onclick="viewPurchaseBill(${bill.id})">👁️ View</button></td>
                `;
                tableBody.appendChild(row);
            });
        }

        async function showAddPurchaseModal() {
            purchaseBillItems = [];
            document.getElementById('addPurchaseModal').classList.add('active');
            document.getElementById('purchaseSupplierName').value = '';
            document.getElementById('purchaseBillNumber').value = '';
            
            // FIX: Fetch the current IST date from the server to set as the default.
            try {
                const response = await fetch(`${API_BASE_URL}/current-ist-date`);
                const data = await response.json();
                // The server returns the date in 'YYYY-MM-DD' format, which is exactly what the input needs.
                document.getElementById('purchaseBillDate').value = data.currentDate;
            } catch (error) {
                console.error("Could not fetch current date, falling back to local date.", error);
                // Fallback in case of network error
                document.getElementById('purchaseBillDate').valueAsDate = new Date();
            }

            clearPurchaseProductForm();
            updatePurchaseItemsTable();
            calculatePurchaseTotal();
        }

        function clearPurchaseProductForm() {
            document.getElementById('purchaseProductName').value = '';
            document.getElementById('purchasePackaging').value = packagingTypes[0];
            document.getElementById('purchaseHSN').value = '';
            document.getElementById('purchaseBatch').value = '';
            document.getElementById('purchaseQty').value = '';
            document.getElementById('purchaseMRP').value = '';
            document.getElementById('purchaseRate').value = '';
            document.getElementById('purchaseGstPercent').value = '12';
            document.getElementById('purchaseDiscount').value = '0';
            document.getElementById('purchaseSaleRateIncl').value = '';
            document.getElementById('purchaseSaleGstPercent').value = '12';
            document.getElementById('purchaseSaleRateExcl').value = '';
            document.getElementById('purchaseExpiry').value = '';
        }
        
        function calculatePurchaseSaleExclusiveRate(){
             const inclRate = parseFloat(document.getElementById('purchaseSaleRateIncl').value) || 0;
             const saleGst = parseFloat(document.getElementById('purchaseSaleGstPercent').value) || 0;
             const exclRateEl = document.getElementById('purchaseSaleRateExcl');
             if(inclRate > 0 && saleGst > 0) {
                 exclRateEl.value = (inclRate / (1 + (saleGst/100))).toFixed(2);
             } else {
                 exclRateEl.value = '';
             }
        }

        function addProductToPurchaseBill() {
            const purchaseTaxType = document.querySelector('input[name="purchaseTaxType"]:checked').value;
            const purchaseGst = parseFloat(document.getElementById('purchaseGstPercent').value) || 0;
            const saleGst = parseFloat(document.getElementById('purchaseSaleGstPercent').value) || 0;
            
            const item = {
                productName: document.getElementById('purchaseProductName').value,
                packaging: document.getElementById('purchasePackaging').value,
                hsn: document.getElementById('purchaseHSN').value,
                batch: document.getElementById('purchaseBatch').value,
                quantity: parseInt(document.getElementById('purchaseQty').value),
                mrp: parseFloat(document.getElementById('purchaseMRP').value),
                purchaseRate: parseFloat(document.getElementById('purchaseRate').value),
                discount: parseFloat(document.getElementById('purchaseDiscount').value),
                expiry: document.getElementById('purchaseExpiry').value,
                saleRate: parseFloat(document.getElementById('purchaseSaleRateExcl').value),
                saleRateIncl: parseFloat(document.getElementById('purchaseSaleRateIncl').value),
                saleCgst: saleGst / 2,
                saleSgst: saleGst / 2,
                cgst: purchaseTaxType === 'CSGST' ? purchaseGst / 2 : 0,
                sgst: purchaseTaxType === 'CSGST' ? purchaseGst / 2 : 0,
                igst: purchaseTaxType === 'IGST' ? purchaseGst : 0,
            };
            
            if (!item.productName || !item.batch || isNaN(item.quantity) || isNaN(item.purchaseRate) || isNaN(item.saleRate)) {
                 showAlert('Please fill all required product fields (*).', 'danger');
                 return;
            }

            const baseAmount = item.purchaseRate * item.quantity;
            item.subtotal = baseAmount;
            const discountedAmount = baseAmount * (1 - (item.discount / 100));
            const gstAmount = discountedAmount * (purchaseGst / 100);
            item.amount = discountedAmount + gstAmount;
            
            purchaseBillItems.push(item);
            updatePurchaseItemsTable();
            calculatePurchaseTotal();
            clearPurchaseProductForm();
            document.getElementById('purchaseProductName').focus();
        }

        function updatePurchaseItemsTable() {
            const tableBody = document.getElementById('purchaseItemsBody');
            tableBody.innerHTML = '';
            if (purchaseBillItems.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">No items added</td></tr>';
                return;
            }
            purchaseBillItems.forEach((item, index) => {
                const gstText = item.igst > 0 ? `${item.igst}% (IGST)` : `${item.cgst + item.sgst}% (C/SGST)`;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.productName}</td>
                    <td>${item.batch}</td>
                    <td>${item.quantity}</td>
                    <td>₹${item.purchaseRate.toFixed(2)}</td>
                    <td>₹${item.subtotal.toFixed(2)}</td>
                    <td>${item.discount.toFixed(2)}%</td>
                    <td>${gstText}</td>
                    <td>₹${item.amount.toFixed(2)}</td>
                    <td><button class="btn btn-danger btn-sm" onclick="removeProductFromPurchase(${index})">🗑️</button></td>
                `;
                tableBody.appendChild(row);
            });
        }

        function removeProductFromPurchase(index) {
            purchaseBillItems.splice(index, 1);
            updatePurchaseItemsTable();
            calculatePurchaseTotal();
        }

        function calculatePurchaseTotal() {
            const total = purchaseBillItems.reduce((sum, item) => sum + item.amount, 0);
            const roundedTotal = Math.round(total);
            const rounding = roundedTotal - total;

            document.getElementById('purchaseTotalAmount').textContent = `₹${total.toFixed(2)}`;
            document.getElementById('purchaseRoundingAmount').textContent = `₹${rounding.toFixed(2)}`;
            document.getElementById('purchaseGrandTotal').textContent = `₹${roundedTotal.toFixed(2)}`;
        }

        async function savePurchaseBill() {
            const purchaseData = {
                supplierName: document.getElementById('purchaseSupplierName').value,
                billNumber: document.getElementById('purchaseBillNumber').value,
                billDate: document.getElementById('purchaseBillDate').value,
                taxType: document.querySelector('input[name="purchaseTaxType"]:checked').value,
                totalAmount: purchaseBillItems.reduce((sum, item) => sum + item.amount, 0),
                items: purchaseBillItems
            };

            if (!purchaseData.supplierName || !purchaseData.billNumber || !purchaseData.billDate || purchaseData.items.length === 0) {
                showAlert('Please fill supplier details and add at least one product.', 'danger');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/purchases`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(purchaseData)
                });
                const result = await response.json();
                if (response.ok) {
                    showAlert(result.message, 'success');
                    closeModal('addPurchaseModal');
                    await fetchPurchaseBills();
                    await fetchInventory(); 
                } else {
                    showAlert(result.error, 'danger');
                }
            } catch (error) {
                showAlert('Failed to save purchase bill.', 'danger');
            }
        }

        async function viewPurchaseBill(id) {
            try {
                const bill = await fetch(`${API_BASE_URL}/purchases/${id}`).then(res => res.json());
                const itemsHtml = bill.items.map(item => `
                    <tr>
                        <td>${item.product_name}</td> <td>${item.packaging || ''}</td> <td>${item.batch}</td>
                        <td>${item.quantity}</td> <td>₹${Number(item.purchase_rate).toFixed(2)}</td> <td>${item.discount || 0}%</td>
                        <td>${item.igst > 0 ? item.igst + '% (IGST)' : (item.cgst + item.sgst) + '%'}</td>
                        <td>₹${Number(item.amount).toFixed(2)}</td>
                    </tr>
                `).join('');

                document.getElementById('viewPurchaseContent').innerHTML = `
                    <p><strong>Supplier:</strong> ${bill.supplier_name}</p>
                    <p><strong>Bill No:</strong> ${bill.bill_number}</p>
                    <p><strong>Date:</strong> ${formatDateForDisplay(bill.bill_date)}</p>
                    <p><strong>Tax Type:</strong> ${bill.tax_type}</p>
                    <h4 style="margin-top:20px;">Items</h4>
                    <table> <thead> <tr> <th>Product</th> <th>Pkg</th> <th>Batch</th> <th>Qty</th> <th>Rate</th> <th>Disc</th> <th>GST</th> <th>Amount</th> </tr> </thead> <tbody>${itemsHtml}</tbody> </table>
                    <h3 style="text-align:right; margin-top:10px;">Total: ₹${Number(bill.total_amount).toFixed(2)}</h3>
                `;
                document.getElementById('viewPurchaseModal').classList.add('active');
            } catch (error) {
                showAlert(error.message, 'danger');
            }
        }
        
        // Helper Functions & Customer Management
        // FIX: This function is now robust and correctly formats the TIMESTAMP from the server.
        // It creates a Date object, which correctly interprets the ISO 8601 format (including 'Z' for UTC),
        // and then extracts the local day, month, and year for display.
        function formatDateForDisplay(dateString) {
            if (!dateString) return 'N/A';
            // Create a date object. The string from MySQL TIMESTAMP will be in ISO format
            // and correctly parsed by the Date constructor.
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-based
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function setTodayDate() {
            // This correctly sets the report dates to the user's local "today",
            // which is the desired behavior for filtering.
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportFromDate').value = today;
            document.getElementById('reportToDate').value = today;
        }

        function showAlert(message, type) {
            const container = document.getElementById('alert-container');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            container.appendChild(alertDiv);
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
        async function fetchCustomers() {
            try {
                const response = await fetch(`${API_BASE_URL}/customers`);
                updateCustomersTable(await response.json());
            } catch (error) {
                showAlert('Failed to load customers.', 'danger');
            }
        }
        function updateCustomersTable(data) {
            const tableBody = document.getElementById('customersBody');
            tableBody.innerHTML = '';
            if (!data || data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No customers found</td></tr>';
                return;
            }
            data.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.id}</td>
                    <td>${customer.name || 'N/A'}</td>
                    <td>${customer.mobile || 'N/A'}</td>
                    <td>${customer.doctor_name || 'N/A'}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="showEditCustomerModal(${customer.id})">✏️</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteCustomer(${customer.id})">❌</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        async function searchCustomers() {
            const query = document.getElementById('customerSearch').value.toLowerCase();
            try {
                const response = await fetch(`${API_BASE_URL}/customers/search?query=${query}`);
                updateCustomersTable(await response.json());
            } catch (error) {
                showAlert('Failed to search customers.', 'danger');
            }
        }
        async function showEditCustomerModal(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/customers/${id}`);
                const customer = await response.json();
                document.getElementById('editCustomerId').value = customer.id;
                document.getElementById('editCustomerName').value = customer.name;
                document.getElementById('editCustomerMobile').value = customer.mobile;
                document.getElementById('editCustomerDoctorName').value = customer.doctor_name || '';
                document.getElementById('editCustomerModal').classList.add('active');
            } catch (error) {
                showAlert(error.message, 'danger');
            }
        }
        async function updateCustomer() {
            const id = document.getElementById('editCustomerId').value;
            const customer = {
                name: document.getElementById('editCustomerName').value,
                mobile: document.getElementById('editCustomerMobile').value,
                doctor_name: document.getElementById('editCustomerDoctorName').value
            };
            try {
                const response = await fetch(`${API_BASE_URL}/customers/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(customer)
                });
                const result = await response.json();
                if (response.ok) {
                    showAlert(result.message, 'success');
                    fetchCustomers();
                    closeModal('editCustomerModal');
                } else {
                    showAlert(result.error, 'danger');
                }
            } catch (error) {
                showAlert('Failed to update customer.', 'danger');
            }
        }
        async function deleteCustomer(id) {
            if (confirm('Are you sure you want to delete this customer?')) {
                try {
                    const response = await fetch(`${API_BASE_URL}/customers/${id}`, { method: 'DELETE' });
                    const result = await response.json();
                    if (response.ok) {
                        showAlert(result.message, 'success');
                        fetchCustomers();
                    } else {
                        showAlert(result.error, 'danger');
                    }
                } catch (error) {
                    showAlert('Failed to delete customer.', 'danger');
                }
            }
        }
        async function searchCustomer() {
            const query = document.getElementById('patientName').value.trim() || document.getElementById('patientMobile').value.trim();
            const dropdown = document.getElementById('patientNameDropdown');
            dropdown.innerHTML = '';
            if (query.length < 2) {
                dropdown.style.display = 'none';
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/customers/search?query=${query}`);
                const customers = await response.json();
                if (customers.length > 0) {
                    customers.forEach(customer => {
                        const item = document.createElement('div');
                        item.textContent = `${customer.name} - ${customer.mobile}`;
                        item.onclick = () => selectCustomer(customer);
                        dropdown.appendChild(item);
                    });
                    dropdown.style.display = 'block';
                } else {
                    dropdown.style.display = 'none';
                }
            } catch (error) {
                console.error('Error searching customers:', error);
            }
        }
        function selectCustomer(customer) {
            document.getElementById('patientName').value = customer.name;
            document.getElementById('patientMobile').value = customer.mobile;
            document.getElementById('doctorName').value = customer.doctor_name || '';
            document.getElementById('patientNameDropdown').style.display = 'none';
        }
    </script>
</body>
</html>

